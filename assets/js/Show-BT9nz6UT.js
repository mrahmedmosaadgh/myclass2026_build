import{p as e,d as t,A as a,e as s,B as r,Q as n,q as o,g as i,n as l}from"./app-BXm70mdJ.js";import{Q as c}from"./QImg-xQZwcc-t.js";import{Q as u}from"./QForm-DyZk5PSh.js";import{_ as d}from"./AppLayout-poNpMhjN.js";import{f as m,a as p,o as g,e as v,k as y,H as f,I as h,J as _,M as x,b as w,V as b,U as k,L as q,O as D,Q as j,S,F as E,y as T,n as C,Z as I}from"./vendor-DNM7Y6Xn.js";import"./offline-BzIlwqNM.js";import"./i18n-CBOKL2HS.js";import"./ui-BP0GJNn5.js";const A={class:"flex justify-between items-center"},Q={class:"font-semibold text-xl text-gray-800 leading-tight"},F={class:"py-6"},L={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},V={class:"flex items-center"},$={class:"q-ml-md"},z={class:"text-weight-bold"},U={key:0,class:"text-caption"},H={key:1,class:"text-caption text-primary"},O={class:"q-py-md"},B={key:0,class:"text-center text-grey q-py-xl"},J={key:0,class:"text-center text-grey-7 text-caption q-my-sm"},K={key:0,class:"text-caption text-weight-bold q-mb-xs"},M={key:1},N={key:2},R={key:3},W={key:0,class:"q-mt-sm flex items-center bg-white rounded-borders q-pa-xs"},Y={class:"q-ml-sm"},Z=e({__name:"Show",props:{conversation:{type:Object,required:!0},messages:{type:Array,default:()=>[]}},setup(e){const Z=window.route,G=e,P=m(null),X=m(""),ee=m(null),te=m(null),ae=m(null),se=m(null),re=m(!1),ne=m([...G.messages]),oe=p(()=>""!==X.value.trim()||null!==ee.value),ie=e=>e?e.split(" ").map(e=>e[0]).join("").toUpperCase():"?",le=e=>{if(!e)return"primary";const t=["primary","secondary","accent","positive","negative","info","warning"];return t[e.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%t.length]},ce=e=>{const t=new Date(e),a=new Date,s=new Date(a);return s.setDate(s.getDate()-1),t.toDateString()===a.toDateString()?"Today":t.toDateString()===s.toDateString()?"Yesterday":t.toLocaleDateString([],{weekday:"long",month:"long",day:"numeric"})},ue=(e,t)=>{if(0===t)return!0;return new Date(e.created_at).toDateString()!==new Date(ne.value[t-1].created_at).toDateString()},de=e=>{ee.value=e.target.files[0]||null},me=async()=>{if(!oe.value)return;const e=new FormData;if(""!==X.value.trim()&&(e.append("body",X.value),e.append("type","text")),ee.value){e.append("attachment",ee.value);ee.value.type.startsWith("image/")?e.append("type","image"):e.append("type","file")}try{const t=await I.post(Z("messages.store",G.conversation.id),e,{headers:{"Content-Type":"multipart/form-data"}});ne.value.push({...t.data,is_mine:!0,user:{id:t.data.user.id,name:t.data.user.name,profile_photo_url:t.data.user.profile_photo_url}}),X.value="",ee.value=null,ge()}catch(t){console.error("Error sending message:",t)}},pe=()=>{re.value||(re.value=!0,I.post(Z("messages.typing",G.conversation.id)).catch(e=>console.error("Error sending typing event:",e)),setTimeout(()=>{re.value=!1},3e3))},ge=()=>{C(()=>{if(P.value){const e=P.value.$el.querySelector(".scroll");e.scrollTop=e.scrollHeight}})},ve=e=>{I.post(Z("messages.mark-seen",G.conversation.id),{message_ids:[e]}).catch(e=>console.error("Error marking message as seen:",e))};return g(()=>{(()=>{try{if(!window.Echo)return void console.warn("Laravel Echo not initialized. Real-time messaging will not work.");window.Echo.join(`conversation.${G.conversation.id}`).listen(".message.sent",e=>{ne.value.push({id:e.id,body:e.body,type:e.type,attachment_url:e.attachment_url,created_at:e.created_at,is_mine:!1,user:{id:e.user_id,name:e.user_name,profile_photo_url:e.user_photo}}),ae.value=null,ge(),ve(e.id)}).listen(".user.typing",e=>{e.user_id!==window.userId&&(ae.value=e.user_name,clearTimeout(se.value),se.value=setTimeout(()=>{ae.value=null},3e3))})}catch(e){console.error("Error setting up message listeners:",e)}})(),ge()}),v(()=>{try{clearTimeout(se.value),window.Echo&&window.Echo.leave(`conversation.${G.conversation.id}`)}catch(e){console.error("Error cleaning up message listeners:",e)}}),y(()=>G.messages,e=>{ne.value=[...e],ge()},{deep:!0}),(m,p)=>(h(),f(d,{title:e.conversation.name},{header:_(()=>[x("div",A,[x("h2",Q,k(e.conversation.name),1),w(n,{flat:"",round:"",color:"primary",icon:"arrow_back",to:T(Z)("conversations.index")},null,8,["to"])])]),default:_(()=>[x("div",F,[x("div",L,[w(l,{flat:"",bordered:"",class:"chat-container"},{default:_(()=>[w(t,{class:"bg-grey-2"},{default:_(()=>[x("div",V,[e.conversation.is_group?(h(),f(a,{key:0},{default:_(()=>[w(s,{name:"group",size:"md"})]),_:1})):(h(),f(a,{key:1,color:le(e.conversation.name)},{default:_(()=>[b(k(ie(e.conversation.name)),1)]),_:1},8,["color"])),x("div",$,[x("div",z,k(e.conversation.name),1),e.conversation.is_group?(h(),q("div",U,k(e.conversation.users.length)+" participants ",1)):ae.value?(h(),q("div",H,k(ae.value)+" is typing... ",1)):D("",!0)])])]),_:1}),w(t,{class:"messages-container q-pa-none"},{default:_(()=>[w(r,{ref_key:"scrollArea",ref:P,style:{height:"400px"},class:"q-px-md"},{default:_(()=>[x("div",O,[0===e.messages.length?(h(),q("div",B," No messages yet. Start the conversation! ")):(h(!0),q(E,{key:1},j(e.messages,(t,s)=>{return h(),q("div",{key:t.id,class:"q-mb-md"},[ue(t,s)?(h(),q("div",J,k(ce(t.created_at)),1)):D("",!0),x("div",{class:S(["message-bubble flex",t.is_mine?"justify-end":"justify-start"])},[!t.is_mine&&e.conversation.is_group?(h(),f(a,{key:0,size:"sm",color:le(t.user.name),class:"q-mr-sm self-end"},{default:_(()=>[b(k(ie(t.user.name)),1)]),_:2},1032,["color"])):D("",!0),x("div",{class:S(["message-content rounded-borders q-pa-sm",t.is_mine?"bg-primary text-white":"bg-grey-3"])},[!t.is_mine&&e.conversation.is_group?(h(),q("div",K,k(t.user.name),1)):D("",!0),"text"===t.type?(h(),q("div",M,k(t.body),1)):"image"===t.type?(h(),q("div",N,[w(c,{src:t.attachment_url,"spinner-color":"white",style:{"max-width":"250px","max-height":"250px"}},null,8,["src"])])):"file"===t.type?(h(),q("div",R,[w(n,{flat:"",color:t.is_mine?"white":"primary",icon:"attach_file",label:(o=t.attachment_url,o?o.split("/").pop():"File"),href:t.attachment_url,target:"_blank"},null,8,["color","label","href"])])):D("",!0),x("div",{class:S(["text-caption q-mt-xs text-right",t.is_mine?"text-white-7":"text-grey-7"])},k((r=t.created_at,new Date(r).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),3)],2)],2)]);var r,o}),128))])]),_:1},512)]),_:1}),w(t,{class:"message-input bg-grey-2"},{default:_(()=>[w(u,{onSubmit:me,class:"row items-center"},{default:_(()=>[w(n,{round:"",flat:"",color:"primary",icon:"attach_file",onClick:p[0]||(p[0]=e=>m.$refs.fileInput.click())},{default:_(()=>[w(o,null,{default:_(()=>p[3]||(p[3]=[b("Attach File")])),_:1})]),_:1}),x("input",{type:"file",ref_key:"fileInput",ref:te,style:{display:"none"},onChange:de},null,544),w(i,{modelValue:X.value,"onUpdate:modelValue":p[1]||(p[1]=e=>X.value=e),placeholder:"Type a message...",dense:"",outlined:"",class:"col q-mx-sm","bg-color":"white",onKeydown:pe},null,8,["modelValue"]),w(n,{round:"",flat:"",color:"primary",icon:"send",type:"submit",disable:!oe.value},null,8,["disable"])]),_:1}),ee.value?(h(),q("div",W,[w(s,{name:"attach_file",color:"primary"}),x("span",Y,k(ee.value.name),1),w(n,{round:"",flat:"",dense:"",icon:"close",onClick:p[2]||(p[2]=e=>ee.value=null)})])):D("",!0)]),_:1})]),_:1})])])]),_:1},8,["title"]))}},[["__scopeId","data-v-3d4c0a19"]]);export{Z as default};
