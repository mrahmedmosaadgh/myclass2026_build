import{o as e,u as a,c as s,d as l,n as t,Q as o,a as c,e as r,m as i,p as d,g as n,l as u,b as m,aP as p,bb as _,C as v,f as g}from"./app-B77gjd5a.js";import{Q as f}from"./QSpace-Bk4F2b8L.js";import{Q as b}from"./QSpinnerDots-CnY0H5Kp.js";import{Q as y}from"./QBadge-ZkvAqPBD.js";import{Q as w}from"./QTd-Cd1TbwhN.js";import{Q as h}from"./QTable-Dzgz30xz.js";import{d as x}from"./date-DOBw9r3p.js";import{u as k}from"./schoolData-BRFwL7u7.js";import{f as j,a as q,k as C,I as V,J as Q,K as S,b as z,N as T,Q as D,y as A,M as $,W as F,V as M,F as Y,R as E,_ as R,U as I}from"./vendor-DuKqz2x4.js";import"./offline-BzIlwqNM.js";import"./i18n-DE5KxGn8.js";import"./ui-BITzTqrO.js";import"./QMarkupTable-xKG6mM4A.js";import"./QSelect-DB_tK-Lk.js";import"./rtl-Cr6c3OOr.js";import"./QLinearProgress-B9hMkhRG.js";import"./use-fullscreen-Cf3Zl1YN.js";const O={key:0,class:"row justify-center q-pa-xl"},U={class:"row q-gutter-md q-mb-lg"},L={class:"text-h4 text-primary"},P={class:"text-h4 text-secondary"},W={class:"text-h4 text-negative"},N={class:"text-h4 text-positive"},B={key:2,class:"text-center q-pa-xl"},H={key:3},J={class:"row q-gutter-sm q-mb-md"},K={class:"q-mt-md q-pa-sm bg-green-1 rounded-borders"},G={class:"text-body2 text-green-9"},X={key:4},Z={class:"text-caption text-grey-6"},ee={key:3,class:"text-center q-pa-xl"},ae=e({__name:"CSTOverviewDialog",props:{modelValue:Boolean},emits:["update:modelValue"],setup(e,{emit:ae}){const se=e,le=a(),te=k(),oe=j(!1),ce=j(null),re=j(null),ie=j(!1),de=j(!1),ne=j(!1),ue=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"}],me=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"},{name:"actions",label:"Actions",align:"center"}],pe=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"deleted_at",label:"Deleted At",align:"center"},{name:"restore",label:"",align:"center"}],_e=q(()=>re.value?re.value.by_classroom.filter(e=>e.cst_count>0):[]),ve=q(()=>re.value?re.value.by_classroom.filter(e=>e.cst_deleted_count>0):[]),ge=async()=>{var e,a;if(te.schoolId&&te.academicYearId){oe.value=!0,ce.value=null,re.value=null,ne.value=!1;try{const e=await R.post("/weekly-system/api/cst-overview",{school_id:te.schoolId,academic_year_id:te.academicYearId,include_deleted:de.value});e.data.success?(re.value=e.data.data,re.value.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.original_classes_per_week=e.classes_per_week,e.modified=!1,e.saving=!1})}),e.data.message&&le.notify({type:"info",message:e.data.message,position:"top"})):ce.value=e.data.message||"Failed to load overview"}catch(s){ce.value=(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.message)||"Failed to load overview"}finally{oe.value=!1}}else ce.value="School and Academic Year must be selected"},fe=()=>{ge()};return C(()=>re.value,e=>{e&&ie.value&&e.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.is_deleted||(e.modified=e.classes_per_week!==e.original_classes_per_week)})})},{deep:!0}),C(()=>se.modelValue,e=>{e&&(re.value=null,ce.value=null,ie.value=!1,de.value=!1,ne.value=!1,ge())}),(a,k)=>(Q(),V(m,{"model-value":e.modelValue,"onUpdate:modelValue":k[2]||(k[2]=e=>a.$emit("update:modelValue",e)),position:"right",maximized:""},{default:S(()=>[z(i,{style:{width:"900px","max-width":"95vw"},class:"column"},{default:S(()=>[z(s,{class:"row items-center q-pb-none bg-primary text-white"},{default:S(()=>[z(l,{name:"preview",size:"sm",class:"q-mr-sm"}),k[3]||(k[3]=T("div",{class:"text-h6"},"Subject-Teacher Assignments Overview",-1)),z(f),re.value?(Q(),V(t,{key:0,modelValue:ie.value,"onUpdate:modelValue":k[0]||(k[0]=e=>ie.value=e),label:"Edit Mode",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):D("",!0),re.value?(Q(),V(t,{key:1,modelValue:de.value,"onUpdate:modelValue":[k[1]||(k[1]=e=>de.value=e),fe],label:"Show Deleted",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):D("",!0),A(z(o,{icon:"close",flat:"",round:"",dense:""},null,512),[[p]])]),_:1}),z(c),z(s,{class:"col scroll"},{default:S(()=>[oe.value?(Q(),$("div",O,[z(b,{size:"50px",color:"primary"}),k[4]||(k[4]=T("div",{class:"text-grey-7 q-mt-md"},"Loading data...",-1))])):ce.value?(Q(),V(r,{key:1,class:"bg-negative text-white q-mb-md"},{avatar:S(()=>[z(l,{name:"error",color:"white"})]),default:S(()=>[F(" "+M(ce.value),1)]),_:1})):re.value?(Q(),$(Y,{key:2},[ie.value||ne.value?(Q(),V(r,{key:0,class:"bg-warning text-white q-mb-lg"},{avatar:S(()=>[z(l,{name:"warning",color:"white"})]),default:S(()=>[k[5]||(k[5]=T("div",{class:"text-weight-bold"},"Modifications Active",-1)),k[6]||(k[6]=T("div",{class:"text-body2"}," Changes to classes per week may require updates to the timetable. ",-1))]),_:1})):(Q(),V(r,{key:1,class:"bg-blue-1 q-mb-lg"},{avatar:S(()=>[z(l,{name:"info",color:"blue"})]),default:S(()=>[k[7]||(k[7]=T("div",{class:"text-body2"},[F(" This shows all subject-teacher assignments for the selected school and academic year. The "),T("strong",null,"Total Expected Schedules"),F(" is how many schedule records will be created when you auto-generate. ")],-1))]),_:1})),T("div",U,[z(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:S(()=>[z(s,{class:"text-center"},{default:S(()=>[T("div",L,M(re.value.summary.total_classrooms),1),k[8]||(k[8]=T("div",{class:"text-caption text-grey-7"},"Classrooms",-1)),z(l,{name:"class",color:"primary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),z(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:S(()=>[z(s,{class:"text-center"},{default:S(()=>[T("div",P,M(re.value.summary.total_csts),1),k[9]||(k[9]=T("div",{class:"text-caption text-grey-7"},"Active Assignments",-1)),z(l,{name:"assignment",color:"secondary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),de.value&&re.value.summary.total_deleted_csts>0?(Q(),V(i,{key:0,flat:"",bordered:"",class:"col-12 col-sm"},{default:S(()=>[z(s,{class:"text-center"},{default:S(()=>[T("div",W,M(re.value.summary.total_deleted_csts),1),k[10]||(k[10]=T("div",{class:"text-caption text-grey-7"},"Deleted",-1)),z(l,{name:"delete",color:"negative",size:"md",class:"q-mt-sm"})]),_:1})]),_:1})):D("",!0),z(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:S(()=>[z(s,{class:"text-center"},{default:S(()=>[T("div",N,M(re.value.summary.total_expected_schedules),1),k[12]||(k[12]=T("div",{class:"text-caption text-grey-7"},"Expected Schedules",-1)),z(l,{name:"event",color:"positive",size:"md",class:"q-mt-sm"}),z(d,null,{default:S(()=>k[11]||(k[11]=[F("Total classes_per_week across all active assignments")])),_:1})]),_:1})]),_:1})]),0!==_e.value.length||de.value&&0!==ve.value.length?D("",!0):(Q(),$("div",B,[z(l,{name:"inbox",size:"64px",color:"grey-5"}),k[13]||(k[13]=T("p",{class:"text-h6 text-grey-7 q-mt-md"},"No Data Found",-1)),k[14]||(k[14]=T("p",{class:"text-grey-6"},"No subject-teacher assignments for this school and academic year",-1))])),_e.value.length>0?(Q(),$("div",H,[k[18]||(k[18]=T("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Active Assignments by Classroom",-1)),z(n,{bordered:"",separator:"",class:"rounded-borders q-mb-lg"},{default:S(()=>[(Q(!0),$(Y,null,E(_e.value,e=>(Q(),V(_,{key:e.classroom_id,label:e.classroom_name,caption:`${e.cst_count} subjects → ${e.total_classes_per_week} schedule entries`,icon:"class","header-class":"bg-grey-1"},{default:S(()=>[z(i,null,{default:S(()=>[z(s,{class:"q-pa-sm"},{default:S(()=>[T("div",J,[z(v,{dense:"",icon:"subject",color:"blue-2","text-color":"blue-9"},{default:S(()=>[F(M(e.cst_count)+" Subjects ",1)]),_:2},1024),z(v,{dense:"",icon:"schedule",color:"green-2","text-color":"green-9"},{default:S(()=>[F(M(e.total_classes_per_week)+" Periods/Week ",1)]),_:2},1024)]),z(h,{rows:e.subjects.filter(e=>!e.is_deleted),columns:ie.value?me:ue,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":S(e=>[z(w,{props:e},{default:S(()=>[z(y,{color:"blue-2","text-color":"blue-9"},{default:S(()=>[F(M(e.row.subject_name),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-classes_per_week":S(e=>[z(w,{props:e},{default:S(()=>[ie.value?(Q(),V(g,{key:0,modelValue:e.row.classes_per_week,"onUpdate:modelValue":a=>e.row.classes_per_week=a,modelModifiers:{number:!0},type:"number",dense:"",outlined:"",min:"1",max:"20",style:{"max-width":"80px"},class:I({"bg-yellow-1":e.row.modified})},null,8,["modelValue","onUpdate:modelValue","class"])):(Q(),V(v,{key:1,dense:"",size:"sm",color:"green-2","text-color":"green-9"},{default:S(()=>[F(M(e.row.classes_per_week),1)]),_:2},1024))]),_:2},1032,["props"])]),"body-cell-actions":S(e=>[z(w,{props:e},{default:S(()=>[e.row.modified?(Q(),V(o,{key:0,flat:"",dense:"",round:"",icon:"save",color:"positive",size:"sm",onClick:a=>(async e=>{var a,s;e.saving=!0;try{const a=await R.put(`/weekly-system/api/cst/${e.cst_id}/classes-per-week`,{classes_per_week:e.classes_per_week});a.data.success&&(e.original_classes_per_week=e.classes_per_week,e.modified=!1,ne.value=!0,le.notify({type:"positive",message:a.data.message,position:"top"}),await ge())}catch(l){le.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to save",position:"top"})}finally{e.saving=!1}})(e.row),loading:e.row.saving},{default:S(()=>[z(d,null,{default:S(()=>k[15]||(k[15]=[F("Save changes")])),_:1})]),_:2},1032,["onClick","loading"])):D("",!0),z(o,{flat:"",dense:"",round:"",icon:"delete",color:"negative",size:"sm",onClick:a=>(async e=>{le.dialog({title:"Confirm Delete",message:`Are you sure you want to delete ${e.subject_name} (${e.teacher_name})? This will soft-delete the assignment. You can restore it later.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await R.delete(`/weekly-system/api/cst/${e.cst_id}`);a.data.success&&(le.notify({type:"positive",message:a.data.message,position:"top"}),await ge())}catch(l){le.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to delete",position:"top"})}})})(e.row)},{default:S(()=>[z(d,null,{default:S(()=>k[16]||(k[16]=[F("Delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows","columns"]),T("div",K,[k[17]||(k[17]=T("div",{class:"text-caption text-grey-7"},"Calculation:",-1)),T("div",G,[F(M(e.cst_count)+" subjects × avg "+M((e.total_classes_per_week/e.cst_count).toFixed(1))+" periods = ",1),T("strong",null,M(e.total_classes_per_week)+" schedule entries",1)])])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):D("",!0),de.value&&ve.value.length>0?(Q(),$("div",X,[k[20]||(k[20]=T("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Deleted Assignments",-1)),z(n,{bordered:"",separator:"",class:"rounded-borders"},{default:S(()=>[(Q(!0),$(Y,null,E(ve.value,e=>(Q(),V(_,{key:"deleted-"+e.classroom_id,label:e.classroom_name,caption:`${e.cst_deleted_count} deleted subject(s)`,icon:"delete","header-class":"bg-red-1"},{default:S(()=>[z(i,null,{default:S(()=>[z(s,{class:"q-pa-sm"},{default:S(()=>[z(h,{rows:e.subjects.filter(e=>e.is_deleted),columns:pe,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":S(e=>[z(w,{props:e,class:"text-strike text-grey-6"},{default:S(()=>[F(M(e.row.subject_name),1)]),_:2},1032,["props"])]),"body-cell-teacher_name":S(e=>[z(w,{props:e,class:"text-strike text-grey-6"},{default:S(()=>[F(M(e.row.teacher_name),1)]),_:2},1032,["props"])]),"body-cell-deleted_at":S(e=>[z(w,{props:e},{default:S(()=>{return[T("div",Z,M((a=e.row.deleted_at,a?x.formatDate(a,"MMM D, YYYY HH:mm"):"")),1)];var a}),_:2},1032,["props"])]),"body-cell-restore":S(e=>[z(w,{props:e},{default:S(()=>[z(o,{flat:"",dense:"",round:"",icon:"restore",color:"positive",size:"sm",onClick:a=>(async e=>{le.dialog({title:"Confirm Restore",message:`Restore ${e.subject_name} (${e.teacher_name})? You may need to sync schedules afterwards.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await R.post(`/weekly-system/api/cst/${e.cst_id}/restore`);a.data.success&&(ne.value=!0,le.notify({type:"positive",message:a.data.message,position:"top"}),await ge())}catch(l){le.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to restore",position:"top"})}})})(e.row)},{default:S(()=>[z(d,null,{default:S(()=>k[19]||(k[19]=[F("Restore")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):D("",!0)],64)):(Q(),$("div",ee,[z(l,{name:"preview",size:"64px",color:"grey-5"}),k[21]||(k[21]=T("p",{class:"text-h6 text-grey-7 q-mt-md"},"Ready to Load Overview",-1)),k[22]||(k[22]=T("p",{class:"text-grey-6"},"Click the button below to view subject-teacher assignments",-1)),z(o,{color:"primary",icon:"preview",label:"Load Overview",onClick:ge,class:"q-mt-md"})]))]),_:1}),z(c),z(u,{align:"right"},{default:S(()=>[re.value?(Q(),V(o,{key:0,flat:"",icon:"refresh",label:"Refresh",color:"primary",onClick:ge,loading:oe.value},null,8,["loading"])):D("",!0),A(z(o,{flat:"",label:"Close",color:"grey"},null,512),[[p]])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},[["__scopeId","data-v-4c146e8d"]]);export{ae as default};
