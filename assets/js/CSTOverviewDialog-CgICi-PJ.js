import{o as e,u as a,c as s,d as l,n as t,Q as o,a as c,e as r,m as d,p as i,g as n,l as u,b as m,aP as p,bb as _,C as v,f as g}from"./app-BwCflFkV.js";import{Q as f}from"./QSpace-CtVAwmqA.js";import{Q as y}from"./QSpinnerDots-CdUqmAKQ.js";import{Q as b}from"./QBadge-CShv2hr3.js";import{Q as w}from"./QTd-DftUN1Nv.js";import{Q as h}from"./QTable-C_EQBQcS.js";import{d as x}from"./date-CwehRNYO.js";import{u as k}from"./schoolData-BQSkQPXz.js";import{f as j,a as q,k as S,H as C,I as V,J as Q,b as T,M as z,O as D,x as A,L as $,V as Y,U as F,F as O,Q as E,Z as M,S as R}from"./vendor-CUZ9QTQV.js";import"./offline-BzIlwqNM.js";import"./i18n-CP46N9fu.js";import"./ui-LrZmvB2D.js";import"./QMarkupTable-CFmFAA-C.js";import"./QSelect-Cyosk05W.js";import"./rtl-Cr6c3OOr.js";import"./QLinearProgress-BKKQOFX1.js";import"./use-fullscreen-X4x-6n9-.js";const I={key:0,class:"row justify-center q-pa-xl"},U={class:"row q-gutter-md q-mb-lg"},L={class:"text-h4 text-primary"},H={class:"text-h4 text-secondary"},P={class:"text-h4 text-negative"},W={class:"text-h4 text-positive"},B={key:2,class:"text-center q-pa-xl"},N={key:3},J={class:"row q-gutter-sm q-mb-md"},Z={class:"q-mt-md q-pa-sm bg-green-1 rounded-borders"},G={class:"text-body2 text-green-9"},K={key:4},X={class:"text-caption text-grey-6"},ee={key:3,class:"text-center q-pa-xl"},ae=e({__name:"CSTOverviewDialog",props:{modelValue:Boolean},emits:["update:modelValue"],setup(e,{emit:ae}){const se=e,le=a(),te=k(),oe=j(!1),ce=j(null),re=j(null),de=j(!1),ie=j(!1),ne=j(!1),ue=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"}],me=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"},{name:"actions",label:"Actions",align:"center"}],pe=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"deleted_at",label:"Deleted At",align:"center"},{name:"restore",label:"",align:"center"}],_e=q(()=>re.value?re.value.by_classroom.filter(e=>e.cst_count>0):[]),ve=q(()=>re.value?re.value.by_classroom.filter(e=>e.cst_deleted_count>0):[]),ge=async()=>{var e,a;if(te.schoolId&&te.academicYearId){oe.value=!0,ce.value=null,re.value=null,ne.value=!1;try{const e=await M.post("/weekly-system/api/schedule-copies/cst-overview",{school_id:te.schoolId,academic_year_id:te.academicYearId,include_deleted:ie.value});e.data.success?(re.value=e.data.data,re.value.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.original_classes_per_week=e.classes_per_week,e.modified=!1,e.saving=!1})}),e.data.message&&le.notify({type:"info",message:e.data.message,position:"top"})):ce.value=e.data.message||"Failed to load overview"}catch(s){ce.value=(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.message)||"Failed to load overview"}finally{oe.value=!1}}else ce.value="School and Academic Year must be selected"},fe=()=>{ge()};return S(()=>re.value,e=>{e&&de.value&&e.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.is_deleted||(e.modified=e.classes_per_week!==e.original_classes_per_week)})})},{deep:!0}),S(()=>se.modelValue,e=>{e&&(re.value=null,ce.value=null,de.value=!1,ie.value=!1,ne.value=!1,ge())}),(a,k)=>(V(),C(m,{"model-value":e.modelValue,"onUpdate:modelValue":k[2]||(k[2]=e=>a.$emit("update:modelValue",e)),position:"right",maximized:""},{default:Q(()=>[T(d,{style:{width:"900px","max-width":"95vw"},class:"column"},{default:Q(()=>[T(s,{class:"row items-center q-pb-none bg-primary text-white"},{default:Q(()=>[T(l,{name:"preview",size:"sm",class:"q-mr-sm"}),k[3]||(k[3]=z("div",{class:"text-h6"},"Subject-Teacher Assignments Overview",-1)),T(f),re.value?(V(),C(t,{key:0,modelValue:de.value,"onUpdate:modelValue":k[0]||(k[0]=e=>de.value=e),label:"Edit Mode",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):D("",!0),re.value?(V(),C(t,{key:1,modelValue:ie.value,"onUpdate:modelValue":[k[1]||(k[1]=e=>ie.value=e),fe],label:"Show Deleted",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):D("",!0),A(T(o,{icon:"close",flat:"",round:"",dense:""},null,512),[[p]])]),_:1}),T(c),T(s,{class:"col scroll"},{default:Q(()=>[oe.value?(V(),$("div",I,[T(y,{size:"50px",color:"primary"}),k[4]||(k[4]=z("div",{class:"text-grey-7 q-mt-md"},"Loading data...",-1))])):ce.value?(V(),C(r,{key:1,class:"bg-negative text-white q-mb-md"},{avatar:Q(()=>[T(l,{name:"error",color:"white"})]),default:Q(()=>[Y(" "+F(ce.value),1)]),_:1})):re.value?(V(),$(O,{key:2},[de.value||ne.value?(V(),C(r,{key:0,class:"bg-warning text-white q-mb-lg"},{avatar:Q(()=>[T(l,{name:"warning",color:"white"})]),default:Q(()=>[k[5]||(k[5]=z("div",{class:"text-weight-bold"},"Schedule Sync Required",-1)),k[6]||(k[6]=z("div",{class:"text-body2"},[Y(" After making changes to classes per week, you must use the "),z("strong",null,"Schedule Sync"),Y(" feature on each affected schedule copy to update schedule records accordingly. ")],-1))]),_:1})):(V(),C(r,{key:1,class:"bg-blue-1 q-mb-lg"},{avatar:Q(()=>[T(l,{name:"info",color:"blue"})]),default:Q(()=>[k[7]||(k[7]=z("div",{class:"text-body2"},[Y(" This shows all subject-teacher assignments for the selected school and academic year. The "),z("strong",null,"Total Expected Schedules"),Y(" is how many schedule records will be created when you auto-generate. ")],-1))]),_:1})),z("div",U,[T(d,{flat:"",bordered:"",class:"col-12 col-sm"},{default:Q(()=>[T(s,{class:"text-center"},{default:Q(()=>[z("div",L,F(re.value.summary.total_classrooms),1),k[8]||(k[8]=z("div",{class:"text-caption text-grey-7"},"Classrooms",-1)),T(l,{name:"class",color:"primary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),T(d,{flat:"",bordered:"",class:"col-12 col-sm"},{default:Q(()=>[T(s,{class:"text-center"},{default:Q(()=>[z("div",H,F(re.value.summary.total_csts),1),k[9]||(k[9]=z("div",{class:"text-caption text-grey-7"},"Active Assignments",-1)),T(l,{name:"assignment",color:"secondary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),ie.value&&re.value.summary.total_deleted_csts>0?(V(),C(d,{key:0,flat:"",bordered:"",class:"col-12 col-sm"},{default:Q(()=>[T(s,{class:"text-center"},{default:Q(()=>[z("div",P,F(re.value.summary.total_deleted_csts),1),k[10]||(k[10]=z("div",{class:"text-caption text-grey-7"},"Deleted",-1)),T(l,{name:"delete",color:"negative",size:"md",class:"q-mt-sm"})]),_:1})]),_:1})):D("",!0),T(d,{flat:"",bordered:"",class:"col-12 col-sm"},{default:Q(()=>[T(s,{class:"text-center"},{default:Q(()=>[z("div",W,F(re.value.summary.total_expected_schedules),1),k[12]||(k[12]=z("div",{class:"text-caption text-grey-7"},"Expected Schedules",-1)),T(l,{name:"event",color:"positive",size:"md",class:"q-mt-sm"}),T(i,null,{default:Q(()=>k[11]||(k[11]=[Y("Total classes_per_week across all active assignments")])),_:1})]),_:1})]),_:1})]),0!==_e.value.length||ie.value&&0!==ve.value.length?D("",!0):(V(),$("div",B,[T(l,{name:"inbox",size:"64px",color:"grey-5"}),k[13]||(k[13]=z("p",{class:"text-h6 text-grey-7 q-mt-md"},"No Data Found",-1)),k[14]||(k[14]=z("p",{class:"text-grey-6"},"No subject-teacher assignments for this school and academic year",-1))])),_e.value.length>0?(V(),$("div",N,[k[18]||(k[18]=z("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Active Assignments by Classroom",-1)),T(n,{bordered:"",separator:"",class:"rounded-borders q-mb-lg"},{default:Q(()=>[(V(!0),$(O,null,E(_e.value,e=>(V(),C(_,{key:e.classroom_id,label:e.classroom_name,caption:`${e.cst_count} subjects → ${e.total_classes_per_week} schedule entries`,icon:"class","header-class":"bg-grey-1"},{default:Q(()=>[T(d,null,{default:Q(()=>[T(s,{class:"q-pa-sm"},{default:Q(()=>[z("div",J,[T(v,{dense:"",icon:"subject",color:"blue-2","text-color":"blue-9"},{default:Q(()=>[Y(F(e.cst_count)+" Subjects ",1)]),_:2},1024),T(v,{dense:"",icon:"schedule",color:"green-2","text-color":"green-9"},{default:Q(()=>[Y(F(e.total_classes_per_week)+" Periods/Week ",1)]),_:2},1024)]),T(h,{rows:e.subjects.filter(e=>!e.is_deleted),columns:de.value?me:ue,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":Q(e=>[T(w,{props:e},{default:Q(()=>[T(b,{color:"blue-2","text-color":"blue-9"},{default:Q(()=>[Y(F(e.row.subject_name),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-classes_per_week":Q(e=>[T(w,{props:e},{default:Q(()=>[de.value?(V(),C(g,{key:0,modelValue:e.row.classes_per_week,"onUpdate:modelValue":a=>e.row.classes_per_week=a,modelModifiers:{number:!0},type:"number",dense:"",outlined:"",min:"1",max:"20",style:{"max-width":"80px"},class:R({"bg-yellow-1":e.row.modified})},null,8,["modelValue","onUpdate:modelValue","class"])):(V(),C(v,{key:1,dense:"",size:"sm",color:"green-2","text-color":"green-9"},{default:Q(()=>[Y(F(e.row.classes_per_week),1)]),_:2},1024))]),_:2},1032,["props"])]),"body-cell-actions":Q(e=>[T(w,{props:e},{default:Q(()=>[e.row.modified?(V(),C(o,{key:0,flat:"",dense:"",round:"",icon:"save",color:"positive",size:"sm",onClick:a=>(async e=>{var a,s;e.saving=!0;try{const a=await M.put(`/weekly-system/api/cst/${e.cst_id}/classes-per-week`,{classes_per_week:e.classes_per_week});a.data.success&&(e.original_classes_per_week=e.classes_per_week,e.modified=!1,ne.value=!0,le.notify({type:"positive",message:a.data.message,position:"top"}),await ge())}catch(l){le.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to save",position:"top"})}finally{e.saving=!1}})(e.row),loading:e.row.saving},{default:Q(()=>[T(i,null,{default:Q(()=>k[15]||(k[15]=[Y("Save changes")])),_:1})]),_:2},1032,["onClick","loading"])):D("",!0),T(o,{flat:"",dense:"",round:"",icon:"delete",color:"negative",size:"sm",onClick:a=>(async e=>{le.dialog({title:"Confirm Delete",message:`Are you sure you want to delete ${e.subject_name} (${e.teacher_name})? This will soft-delete the assignment. You can restore it later.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await M.delete(`/weekly-system/api/cst/${e.cst_id}`);a.data.success&&(le.notify({type:"positive",message:a.data.message,position:"top"}),await ge())}catch(l){le.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to delete",position:"top"})}})})(e.row)},{default:Q(()=>[T(i,null,{default:Q(()=>k[16]||(k[16]=[Y("Delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows","columns"]),z("div",Z,[k[17]||(k[17]=z("div",{class:"text-caption text-grey-7"},"Calculation:",-1)),z("div",G,[Y(F(e.cst_count)+" subjects × avg "+F((e.total_classes_per_week/e.cst_count).toFixed(1))+" periods = ",1),z("strong",null,F(e.total_classes_per_week)+" schedule entries",1)])])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):D("",!0),ie.value&&ve.value.length>0?(V(),$("div",K,[k[20]||(k[20]=z("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Deleted Assignments",-1)),T(n,{bordered:"",separator:"",class:"rounded-borders"},{default:Q(()=>[(V(!0),$(O,null,E(ve.value,e=>(V(),C(_,{key:"deleted-"+e.classroom_id,label:e.classroom_name,caption:`${e.cst_deleted_count} deleted subject(s)`,icon:"delete","header-class":"bg-red-1"},{default:Q(()=>[T(d,null,{default:Q(()=>[T(s,{class:"q-pa-sm"},{default:Q(()=>[T(h,{rows:e.subjects.filter(e=>e.is_deleted),columns:pe,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":Q(e=>[T(w,{props:e,class:"text-strike text-grey-6"},{default:Q(()=>[Y(F(e.row.subject_name),1)]),_:2},1032,["props"])]),"body-cell-teacher_name":Q(e=>[T(w,{props:e,class:"text-strike text-grey-6"},{default:Q(()=>[Y(F(e.row.teacher_name),1)]),_:2},1032,["props"])]),"body-cell-deleted_at":Q(e=>[T(w,{props:e},{default:Q(()=>{return[z("div",X,F((a=e.row.deleted_at,a?x.formatDate(a,"MMM D, YYYY HH:mm"):"")),1)];var a}),_:2},1032,["props"])]),"body-cell-restore":Q(e=>[T(w,{props:e},{default:Q(()=>[T(o,{flat:"",dense:"",round:"",icon:"restore",color:"positive",size:"sm",onClick:a=>(async e=>{le.dialog({title:"Confirm Restore",message:`Restore ${e.subject_name} (${e.teacher_name})? You may need to sync schedules afterwards.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await M.post(`/weekly-system/api/cst/${e.cst_id}/restore`);a.data.success&&(ne.value=!0,le.notify({type:"positive",message:a.data.message,position:"top"}),await ge())}catch(l){le.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to restore",position:"top"})}})})(e.row)},{default:Q(()=>[T(i,null,{default:Q(()=>k[19]||(k[19]=[Y("Restore")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):D("",!0)],64)):(V(),$("div",ee,[T(l,{name:"preview",size:"64px",color:"grey-5"}),k[21]||(k[21]=z("p",{class:"text-h6 text-grey-7 q-mt-md"},"Ready to Load Overview",-1)),k[22]||(k[22]=z("p",{class:"text-grey-6"},"Click the button below to view subject-teacher assignments",-1)),T(o,{color:"primary",icon:"preview",label:"Load Overview",onClick:ge,class:"q-mt-md"})]))]),_:1}),T(c),T(u,{align:"right"},{default:Q(()=>[re.value?(V(),C(o,{key:0,flat:"",icon:"refresh",label:"Refresh",color:"primary",onClick:ge,loading:oe.value},null,8,["loading"])):D("",!0),A(T(o,{flat:"",label:"Close",color:"grey"},null,512),[[p]])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},[["__scopeId","data-v-3228c053"]]);export{ae as default};
