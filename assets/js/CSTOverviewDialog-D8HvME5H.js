import{o as e,u as a,c as s,d as l,n as t,Q as o,a as c,e as r,m as i,p as d,g as n,l as u,b as m,aP as p,bb as _,C as v,f as g}from"./app-ggGwxJON.js";import{Q as y}from"./QSpace-DKhB4IlP.js";import{Q as f}from"./QSpinnerDots-xIVaxwwk.js";import{Q as b}from"./QSpinnerGears-BR2gfWE2.js";import{Q as w}from"./QInnerLoading-BjYWvaSD.js";import{Q as h}from"./QBadge-DVUbh_5M.js";import{Q as k}from"./QTd-D6gdMIVj.js";import{Q as x}from"./QTable-D7jFdT1k.js";import{d as j}from"./date-C_NgUKAH.js";import{u as q}from"./schoolData-B8mO1d2r.js";import{f as C,a as V,k as Q,I as S,J as z,K as T,b as D,O as A,Q as $,y as Y,N as E,W as F,V as U,F as I,R as M,_ as O,a2 as R,U as L}from"./vendor-nQjeLEvd.js";import"./offline-BzIlwqNM.js";import"./i18n-kquWfmcz.js";import"./ui-Bfjdq-TR.js";import"./QMarkupTable-BbwJTHXP.js";import"./QSelect-DOo83gJW.js";import"./rtl-Cr6c3OOr.js";import"./QLinearProgress-DJHuJoTJ.js";import"./use-fullscreen-DuZ9ifcT.js";const P={key:0,class:"row justify-center q-pa-xl"},W={class:"row q-gutter-md q-mb-lg"},N={class:"text-h4 text-primary"},B={class:"text-h4 text-secondary"},H={class:"text-h4 text-negative"},J={class:"text-h4 text-positive"},K={key:2,class:"text-center q-pa-xl"},G={key:3},X={class:"row q-gutter-sm q-mb-md"},Z={class:"q-mt-md q-pa-sm bg-green-1 rounded-borders"},ee={class:"text-body2 text-green-9"},ae={key:4},se={class:"text-caption text-grey-6"},le={key:3,class:"text-center q-pa-xl"},te=e({__name:"CSTOverviewDialog",props:{modelValue:Boolean},emits:["update:modelValue"],setup(e,{emit:te}){const oe=e,ce=a(),re=q(),ie=C(!1),de=C(null),ne=C(null),ue=C(!1),me=C(!1),pe=C(!1),_e=C(!1),ve=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"}],ge=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"},{name:"actions",label:"Actions",align:"center"}],ye=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"deleted_at",label:"Deleted At",align:"center"},{name:"restore",label:"",align:"center"}],fe=V(()=>ne.value?ne.value.by_classroom.filter(e=>e.cst_count>0):[]),be=V(()=>ne.value?ne.value.by_classroom.filter(e=>e.cst_deleted_count>0):[]),we=C({}),he=async()=>{var e,a;if(re.schoolId&&re.academicYearId){ie.value=!0,de.value=null,ne.value||(ne.value=null),pe.value=!1;try{const e=await O.post("/weekly-system/api/cst-overview",{school_id:re.schoolId,academic_year_id:re.academicYearId,include_deleted:me.value});e.data.success?(ne.value=e.data.data,ne.value.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.original_classes_per_week=e.classes_per_week,e.modified=!1,e.saving=!1})}),e.data.message&&ce.notify({type:"info",message:e.data.message,position:"top"})):de.value=e.data.message||"Failed to load overview"}catch(s){de.value=(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.message)||"Failed to load overview"}finally{ie.value=!1}}else de.value="School and Academic Year must be selected"},ke=()=>{he()},xe=async()=>{var e,a;_e.value=!0;try{const e=[];if(ne.value&&ne.value.by_classroom&&ne.value.by_classroom.forEach(a=>{a.subjects.forEach(a=>{!a.is_deleted&&a.modified&&e.push({cst_id:a.cst_id,classes_per_week:a.classes_per_week})})}),0===e.length)return void(_e.value=!1);const a=await O.post("/weekly-system/api/cst-bulk-update-classes-per-week",{updates:e});a.data.success&&(ce.notify({type:"positive",message:a.data.message,position:"top"}),await he())}catch(s){console.error(s),ce.notify({type:"negative",message:(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.message)||"Failed to save changes",position:"top"})}finally{_e.value=!1}};return Q(()=>ne.value,e=>{e&&ue.value&&e.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.is_deleted||(e.modified=e.classes_per_week!==e.original_classes_per_week)})})},{deep:!0}),Q(()=>oe.modelValue,e=>{e&&(ne.value=null,de.value=null,ue.value=!1,me.value=!1,pe.value=!1,he())}),(a,q)=>(z(),S(m,{"model-value":e.modelValue,"onUpdate:modelValue":q[2]||(q[2]=e=>a.$emit("update:modelValue",e)),position:"right",maximized:""},{default:T(()=>[D(i,{style:{width:"900px","max-width":"95vw"},class:"column"},{default:T(()=>[D(s,{class:"row items-center q-pb-none bg-primary text-white"},{default:T(()=>[D(l,{name:"preview",size:"sm",class:"q-mr-sm"}),q[3]||(q[3]=A("div",{class:"text-h6"},"Subject-Teacher Assignments Overview",-1)),D(y),ne.value?(z(),S(t,{key:0,modelValue:ue.value,"onUpdate:modelValue":q[0]||(q[0]=e=>ue.value=e),label:"Edit Mode",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):$("",!0),ue.value&&pe.value?(z(),S(o,{key:1,color:"positive",icon:"save",label:"Save Changes",class:"q-mr-md",onClick:xe,loading:_e.value},null,8,["loading"])):$("",!0),ne.value?(z(),S(t,{key:2,modelValue:me.value,"onUpdate:modelValue":[q[1]||(q[1]=e=>me.value=e),ke],label:"Show Deleted",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):$("",!0),Y(D(o,{icon:"close",flat:"",round:"",dense:""},null,512),[[p]])]),_:1}),D(c),D(s,{class:"col scroll"},{default:T(()=>[ie.value&&!ne.value?(z(),E("div",P,[D(f,{size:"50px",color:"primary"}),q[4]||(q[4]=A("div",{class:"text-grey-7 q-mt-md"},"Loading data...",-1))])):de.value?(z(),S(r,{key:1,class:"bg-negative text-white q-mb-md"},{avatar:T(()=>[D(l,{name:"error",color:"white"})]),default:T(()=>[F(" "+U(de.value),1)]),_:1})):ne.value?(z(),E(I,{key:2},[D(w,{showing:ie.value},{default:T(()=>[D(b,{size:"50px",color:"primary"})]),_:1},8,["showing"]),ue.value||pe.value?(z(),S(r,{key:0,class:"bg-warning text-white q-mb-lg"},{avatar:T(()=>[D(l,{name:"warning",color:"white"})]),default:T(()=>[q[5]||(q[5]=A("div",{class:"text-weight-bold"},"Modifications Active",-1)),q[6]||(q[6]=A("div",{class:"text-body2"}," Changes to classes per week may require updates to the timetable. ",-1))]),_:1})):(z(),S(r,{key:1,class:"bg-blue-1 q-mb-lg"},{avatar:T(()=>[D(l,{name:"info",color:"blue"})]),default:T(()=>[q[7]||(q[7]=A("div",{class:"text-body2"},[F(" This shows all subject-teacher assignments for the selected school and academic year. The "),A("strong",null,"Total Expected Schedules"),F(" is how many schedule records will be created when you auto-generate. ")],-1))]),_:1})),A("div",W,[D(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",N,U(ne.value.summary.total_classrooms),1),q[8]||(q[8]=A("div",{class:"text-caption text-grey-7"},"Classrooms",-1)),D(l,{name:"class",color:"primary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),D(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",B,U(ne.value.summary.total_csts),1),q[9]||(q[9]=A("div",{class:"text-caption text-grey-7"},"Active Assignments",-1)),D(l,{name:"assignment",color:"secondary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),me.value&&ne.value.summary.total_deleted_csts>0?(z(),S(i,{key:0,flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",H,U(ne.value.summary.total_deleted_csts),1),q[10]||(q[10]=A("div",{class:"text-caption text-grey-7"},"Deleted",-1)),D(l,{name:"delete",color:"negative",size:"md",class:"q-mt-sm"})]),_:1})]),_:1})):$("",!0),D(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",J,U(ne.value.summary.total_expected_schedules),1),q[12]||(q[12]=A("div",{class:"text-caption text-grey-7"},"Expected Schedules",-1)),D(l,{name:"event",color:"positive",size:"md",class:"q-mt-sm"}),D(d,null,{default:T(()=>q[11]||(q[11]=[F("Total classes_per_week across all active assignments")])),_:1})]),_:1})]),_:1})]),0!==fe.value.length||me.value&&0!==be.value.length?$("",!0):(z(),E("div",K,[D(l,{name:"inbox",size:"64px",color:"grey-5"}),q[13]||(q[13]=A("p",{class:"text-h6 text-grey-7 q-mt-md"},"No Data Found",-1)),q[14]||(q[14]=A("p",{class:"text-grey-6"},"No subject-teacher assignments for this school and academic year",-1))])),fe.value.length>0?(z(),E("div",G,[q[18]||(q[18]=A("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Active Assignments by Classroom",-1)),D(n,{bordered:"",separator:"",class:"rounded-borders q-mb-lg"},{default:T(()=>[(z(!0),E(I,null,M(fe.value,e=>(z(),S(_,{key:e.classroom_id,modelValue:we.value[e.classroom_id],"onUpdate:modelValue":a=>we.value[e.classroom_id]=a,label:e.classroom_name,caption:`${e.cst_count} subjects → ${e.total_classes_per_week} schedule entries`,icon:"class","header-class":"bg-grey-1"},{default:T(()=>[D(i,null,{default:T(()=>[D(s,{class:"q-pa-sm"},{default:T(()=>[A("div",X,[D(v,{dense:"",icon:"subject",color:"blue-2","text-color":"blue-9"},{default:T(()=>[F(U(e.cst_count)+" Subjects ",1)]),_:2},1024),D(v,{dense:"",icon:"schedule",color:"green-2","text-color":"green-9"},{default:T(()=>[F(U(e.total_classes_per_week)+" Periods/Week ",1)]),_:2},1024)]),D(x,{rows:e.subjects.filter(e=>!e.is_deleted),columns:ue.value?ge:ve,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":T(e=>[D(k,{props:e},{default:T(()=>[D(h,{color:"blue-2","text-color":"blue-9"},{default:T(()=>[F(U(e.row.subject_name),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-classes_per_week":T(e=>[D(k,{props:e},{default:T(()=>[ue.value?(z(),S(g,{key:0,modelValue:e.row.classes_per_week,"onUpdate:modelValue":a=>e.row.classes_per_week=a,modelModifiers:{number:!0},type:"number",dense:"",outlined:"",min:"1",max:"20",style:{"max-width":"80px"},class:L({"bg-yellow-1":e.row.modified}),onKeyup:R(xe,["enter"])},null,8,["modelValue","onUpdate:modelValue","class"])):(z(),S(v,{key:1,dense:"",size:"sm",color:"green-2","text-color":"green-9"},{default:T(()=>[F(U(e.row.classes_per_week),1)]),_:2},1024))]),_:2},1032,["props"])]),"body-cell-actions":T(e=>[D(k,{props:e},{default:T(()=>[e.row.modified?(z(),S(o,{key:0,flat:"",dense:"",round:"",icon:"save",color:"positive",size:"sm",onClick:a=>(async e=>{var a,s;e.saving=!0;try{const a=await O.put(`/weekly-system/api/cst/${e.cst_id}/classes-per-week`,{classes_per_week:e.classes_per_week});a.data.success&&(e.original_classes_per_week=e.classes_per_week,e.modified=!1,pe.value=!0,ce.notify({type:"positive",message:a.data.message,position:"top"}),await he())}catch(l){ce.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to save",position:"top"})}finally{e.saving=!1}})(e.row),loading:e.row.saving},{default:T(()=>[D(d,null,{default:T(()=>q[15]||(q[15]=[F("Save changes")])),_:1})]),_:2},1032,["onClick","loading"])):$("",!0),D(o,{flat:"",dense:"",round:"",icon:"delete",color:"negative",size:"sm",onClick:a=>(async e=>{ce.dialog({title:"Confirm Delete",message:`Are you sure you want to delete ${e.subject_name} (${e.teacher_name})? This will soft-delete the assignment. You can restore it later.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await O.delete(`/weekly-system/api/cst/${e.cst_id}`);a.data.success&&(ce.notify({type:"positive",message:a.data.message,position:"top"}),await he())}catch(l){ce.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to delete",position:"top"})}})})(e.row)},{default:T(()=>[D(d,null,{default:T(()=>q[16]||(q[16]=[F("Delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows","columns"]),A("div",Z,[q[17]||(q[17]=A("div",{class:"text-caption text-grey-7"},"Calculation:",-1)),A("div",ee,[F(U(e.cst_count)+" subjects × avg "+U((e.total_classes_per_week/e.cst_count).toFixed(1))+" periods = ",1),A("strong",null,U(e.total_classes_per_week)+" schedule entries",1)])])]),_:2},1024)]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue","label","caption"]))),128))]),_:1})])):$("",!0),me.value&&be.value.length>0?(z(),E("div",ae,[q[20]||(q[20]=A("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Deleted Assignments",-1)),D(n,{bordered:"",separator:"",class:"rounded-borders"},{default:T(()=>[(z(!0),E(I,null,M(be.value,e=>(z(),S(_,{key:"deleted-"+e.classroom_id,label:e.classroom_name,caption:`${e.cst_deleted_count} deleted subject(s)`,icon:"delete","header-class":"bg-red-1"},{default:T(()=>[D(i,null,{default:T(()=>[D(s,{class:"q-pa-sm"},{default:T(()=>[D(x,{rows:e.subjects.filter(e=>e.is_deleted),columns:ye,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":T(e=>[D(k,{props:e,class:"text-strike text-grey-6"},{default:T(()=>[F(U(e.row.subject_name),1)]),_:2},1032,["props"])]),"body-cell-teacher_name":T(e=>[D(k,{props:e,class:"text-strike text-grey-6"},{default:T(()=>[F(U(e.row.teacher_name),1)]),_:2},1032,["props"])]),"body-cell-deleted_at":T(e=>[D(k,{props:e},{default:T(()=>{return[A("div",se,U((a=e.row.deleted_at,a?j.formatDate(a,"MMM D, YYYY HH:mm"):"")),1)];var a}),_:2},1032,["props"])]),"body-cell-restore":T(e=>[D(k,{props:e},{default:T(()=>[D(o,{flat:"",dense:"",round:"",icon:"restore",color:"positive",size:"sm",onClick:a=>(async e=>{ce.dialog({title:"Confirm Restore",message:`Restore ${e.subject_name} (${e.teacher_name})? You may need to sync schedules afterwards.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await O.post(`/weekly-system/api/cst/${e.cst_id}/restore`);a.data.success&&(pe.value=!0,ce.notify({type:"positive",message:a.data.message,position:"top"}),await he())}catch(l){ce.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to restore",position:"top"})}})})(e.row)},{default:T(()=>[D(d,null,{default:T(()=>q[19]||(q[19]=[F("Restore")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):$("",!0)],64)):(z(),E("div",le,[D(l,{name:"preview",size:"64px",color:"grey-5"}),q[21]||(q[21]=A("p",{class:"text-h6 text-grey-7 q-mt-md"},"Ready to Load Overview",-1)),q[22]||(q[22]=A("p",{class:"text-grey-6"},"Click the button below to view subject-teacher assignments",-1)),D(o,{color:"primary",icon:"preview",label:"Load Overview",onClick:he,class:"q-mt-md"})]))]),_:1}),D(c),D(u,{align:"right"},{default:T(()=>[ne.value?(z(),S(o,{key:0,flat:"",icon:"refresh",label:"Refresh",color:"primary",onClick:he,loading:ie.value},null,8,["loading"])):$("",!0),Y(D(o,{flat:"",label:"Close",color:"grey"},null,512),[[p]])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},[["__scopeId","data-v-106d6a3e"]]);export{te as default};
