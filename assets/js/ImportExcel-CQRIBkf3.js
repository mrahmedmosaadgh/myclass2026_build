import{_ as e}from"./SecondaryButton-UHI6KqaH.js";import{_ as t}from"./PrimaryButton-D4MqeasW.js";import{M as a}from"./Modal-DOPZQLRD.js";import{aI as l}from"./app-BzjXrVp9.js";import{f as s,k as r,L as u,I as n,M as o,b as i,J as d,U as c,O as v,F as m,Q as p,S as y,V as f,H as x,Z as g}from"./vendor-EI0FRBVb.js";import{r as h,u as w}from"./xlsx-cMC2LkxH.js";const b={class:"p-6"},k={class:"flex justify-between items-center mb-4"},T={class:"text-lg font-medium text-gray-900"},S={class:"text-sm text-gray-500"},_={key:0,class:"overflow-x-auto mb-4"},C={class:"min-w-full divide-y divide-gray-200"},U={class:"bg-gray-50"},B={class:"bg-white divide-y divide-gray-200"},I={class:"px-6 py-4 whitespace-nowrap text-sm"},j={class:"flex justify-end space-x-2"},q={class:"p-6"},E={class:"text-lg font-medium text-gray-900 mb-4"},A={key:0,class:"mb-4"},F={class:"text-green-600 font-medium mb-2"},M={class:"text-sm text-gray-600"},P={key:1,class:"mb-4"},R={class:"text-red-600 font-medium mb-2"},$={class:"text-sm text-red-600"},D={class:"mt-6 flex justify-end space-x-2"},V={__name:"ImportExcel",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"}},emits:["imported","validation-success"],setup(V,{emit:W}){const H=V,J=W,L=s(null),N=s(!1),O=s(!1),Q=s(!1),Z=s(!1),z=s([]),G=s({success:[],errors:[]}),K=s(!1),X=s(null);r(()=>H.columns,()=>{z.value.length>0&&(z.value=z.value.map(e=>{const t={};return H.columns.forEach(a=>{t[a.key]=e.data[a.key]}),{...e,data:t}}))},{deep:!0});const Y=e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=e=>{const t=new Uint8Array(e.target.result),a=h(t,{type:"array"}),l=a.Sheets[a.SheetNames[0]],s=w.sheet_to_json(l,{header:1});s.shift(),z.value=s.filter(e=>e.length).map(e=>{const t={};return H.columns.forEach((a,l)=>{t[a.key]=e[l]}),{data:t,status:"new"}}),ee(),Q.value=!0},a.readAsArrayBuffer(t)},ee=async()=>{var e,t,a;try{const l=H.columns.filter(e=>e.required).map(e=>e.key),s=await g.post(H.validateUrl,{data:z.value.map(e=>e.data),required_fields:l,columns:H.columns}),r=(null==(e=s.data.summary)?void 0:e.invalid_rows)>0||(null==(a=null==(t=s.data.summary)?void 0:t.errors)?void 0:a.length)>0;z.value=z.value.map((e,t)=>({...e,status:r?"warning":"valid"})),J("validation-success",s.data)}catch(l){console.error("Validation error:",l),z.value=z.value.map(e=>({...e,status:"error"}))}},te=async()=>{var e,t;N.value=!0,l.start();try{const e=await g.post(H.importUrl,{data:z.value.map(e=>e.data),columns:H.columns});J("imported"),G.value=e.data.results,X.value=e.data.importId,K.value=!!H.undoUrl,Q.value=!1,Z.value=!0}catch(a){console.error("Import error:",a),G.value={success:[],errors:[(null==(t=null==(e=a.response)?void 0:e.data)?void 0:t.message)||"An error occurred during import"]},Z.value=!0}finally{N.value=!1,l.done(),L.value.value=""}},ae=async()=>{if(X.value&&H.undoUrl){O.value=!0,l.start();try{await g.post(`${H.undoUrl}/${X.value}`),K.value=!1,J("imported"),se()}catch(e){alert("Failed to undo the import")}finally{O.value=!1,l.done()}}},le=()=>{Q.value=!1,z.value=[],L.value.value=""},se=()=>{Z.value=!1,G.value={success:[],errors:[]},X.value=null,K.value=!1};return(l,s)=>(n(),u("div",null,[o("input",{type:"file",ref_key:"fileInput",ref:L,class:"hidden",accept:".xlsx,.xls",onChange:Y},null,544),i(e,{onClick:s[0]||(s[0]=e=>l.$refs.fileInput.click()),disabled:N.value,class:"relative"},{default:d(()=>[o("span",null,c(V.buttonText),1)]),_:1},8,["disabled"]),i(a,{show:Q.value,onClose:le,maxWidth:"4xl"},{default:d(()=>[o("div",b,[o("div",k,[o("h3",T,c(V.previewTitle),1),o("div",S," Total Records: "+c(z.value.length),1)]),Q.value?(n(),u("div",_,[o("table",C,[o("thead",U,[o("tr",null,[(n(!0),u(m,null,p(V.columns.filter(e=>!e.hidden),e=>(n(),u("th",{key:e.key,class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},c(e.label),1))),128)),s[1]||(s[1]=o("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Status ",-1))])]),o("tbody",B,[(n(!0),u(m,null,p(z.value,(e,t)=>{return n(),u("tr",{key:t},[(n(!0),u(m,null,p(V.columns.filter(e=>!e.hidden),t=>(n(),u("td",{key:t.key,class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},c(e.data[t.key]),1))),128)),o("td",I,[o("span",{class:y((a=e.status,{"text-yellow-600":"new"===a,"text-blue-600":"update"===a,"text-red-600":"error"===a}))},c(e.status),3)])]);var a}),128))])])])):v("",!0),o("div",j,[i(e,{onClick:le},{default:d(()=>[f(c(V.cancelButtonText),1)]),_:1}),i(t,{onClick:te,disabled:N.value||!z.value.length},{default:d(()=>[f(c(N.value?V.processingText:V.confirmButtonText),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"]),i(a,{show:Z.value,onClose:se,maxWidth:"2xl"},{default:d(()=>[o("div",q,[o("h3",E,c(V.resultsTitle),1),G.value.success.length?(n(),u("div",A,[o("h4",F,"Success ("+c(G.value.success.length)+")",1),o("ul",M,[(n(!0),u(m,null,p(G.value.success,(e,t)=>(n(),u("li",{key:t},c(e),1))),128))])])):v("",!0),G.value.errors.length?(n(),u("div",P,[o("h4",R,"Errors ("+c(G.value.errors.length)+")",1),o("ul",$,[(n(!0),u(m,null,p(G.value.errors,(e,t)=>(n(),u("li",{key:t},c(e),1))),128))])])):v("",!0),o("div",D,[K.value?(n(),x(e,{key:0,onClick:ae,disabled:O.value},{default:d(()=>[f(c(O.value?V.undoingText:V.undoButtonText),1)]),_:1},8,["disabled"])):v("",!0),i(t,{onClick:se},{default:d(()=>[f(c(V.closeButtonText),1)]),_:1})])])]),_:1},8,["show"])]))}};export{V as _};
