import{p as e,u as a,e as l,f as t,i as s,j as o,k as c,Q as i,q as r,C as n,n as u,d,aq as m,h as v,b as y,aD as p}from"./app-BXm70mdJ.js";import{_ as f,Q as _}from"./CSTAssignDialog-BhG-by5d.js";import{Q as g}from"./QSelect-CnZtzPIC.js";import{Q as b}from"./QBadge-ZzhN1X9C.js";import{Q as h}from"./QMarkupTable-Dmg3C5Wm.js";import{Q as x}from"./QSpinnerDots-BY_P7fmL.js";import{Q as w}from"./QSpace-Bu8V-QDa.js";import{f as k,a as j,k as S,o as q,ac as E,L as Q,I as C,b as A,M as T,y as z,H as V,V as F,U as P,J as D,ad as M,ae as I,O as U,F as $,Q as B,x as O,Z as G}from"./vendor-DNM7Y6Xn.js";import H from"./TimetableGrid-_TKis9fq.js";import J from"./StatusBadge-B2Mh2wJ8.js";import L from"./WeeklyPlanMenu-CPPNbbnB.js";import R from"./AIImportDialog-BaCO3w_a.js";import W from"./RandomFillDialog-DSfGaH2f.js";import{u as N}from"./i18n-CBOKL2HS.js";import"./offline-BzIlwqNM.js";import"./ui-BP0GJNn5.js";import"./QForm-DyZk5PSh.js";import"./rtl-Cr6c3OOr.js";import"./TimetableCell-BpPDOhtU.js";import"./QTab-DhKL91H_.js";import"./QTabs-CDJ215OP.js";import"./WeeklySystemGuide-e9afDUCT.js";import"./QTabPanel-sB32VrK8.js";import"./use-panel-D2HepUiw.js";import"./use-render-cache-CmTcazfP.js";import"./QTabPanels-LFwTBPSC.js";import"./MainSchoolData-poTNtOLu.js";import"./schoolData-lzO9rVwn.js";import"./SchoolSettingsDialog-D2VgwIPk.js";import"./QStepper-9iCkKHrv.js";import"./QTd-BIxMTYzb.js";import"./QTable-rnEofRem.js";import"./QLinearProgress-Cix0cchl.js";import"./use-fullscreen-FlxrEg_V.js";const K={class:"q-pa-md"},Z={class:"row items-center q-mb-lg"},X={class:"col"},Y={class:"q-ma-none text-weight-bold"},ee={class:"text-grey-7 q-mb-none"},ae={class:"row q-gutter-md items-end"},le={class:"col-12 col-sm-6 col-md-4"},te={class:"row items-center no-wrap"},se={class:"col"},oe={class:"text-weight-medium"},ce={class:"text-caption text-grey-7"},ie={class:"col-auto"},re={class:"row items-center no-wrap"},ne={class:"col-12 col-sm-6 col-md-4"},ue={class:"col-12 col-sm-auto"},de={class:"col-12 col-sm-auto"},me={class:"col-12"},ve={key:0,class:"q-mb-sm"},ye={class:"text-caption text-grey-7 q-mb-xs"},pe={class:"row q-gutter-sm"},fe={key:1},_e={class:"text-caption text-grey-7 q-mb-xs"},ge={class:"row q-gutter-sm"},be={key:0,class:"q-mt-md"},he={class:"text-left"},xe={class:"text-left"},we={class:"text-center"},ke={class:"text-center"},je={class:"text-center"},Se={key:0,class:"row justify-center q-pa-xl"},qe={class:"text-h6 text-grey-7 q-mt-md"},Ee={class:"text-grey-6"},Qe={class:"text-h6 text-grey-7 q-mt-md"},Ce={class:"text-grey-6"},Ae={class:"text-h6"},Te={key:0,class:"text-center q-pa-md"},ze={key:1,class:"text-center text-grey-7 q-pa-md"},Ve=e({__name:"TimetableEditor",setup(e){const{t:Ve}=N(),Fe=a(),Pe=k([]),De=k([]),Me=k([]),Ie=k([]),Ue=k([]),$e=k([]),Be=k({}),Oe=k(null),Ge=j(()=>Pe.value.find(e=>"active"===(null==e?void 0:e.status)||!0===(null==e?void 0:e.active))||null),He=j(()=>{const e=De.value.find(e=>e.id===Oe.value);return(null==e?void 0:e.name)||""}),Je=k(!1),Le=k(null),Re=k(null),We=k(null),Ne=k(null),Ke=k(!1),Ze=k(!1),Xe=k(!1),Ye=k(!1),ea=k(!1),aa=k(!1),la=k(!1),ta=k(!1),sa=k(null),oa=k(null),ca=k(null),ia=k(!1),ra=k(!1),na=k([]),ua=k("overall"),da=k(!1),ma=k(!1),va=async()=>{if(!Ge.value)return;const e=Ge.value;if(e){Xe.value=!0;try{const a=await G.get(`/api/classrooms?school_id=${e.school_id}`),l=a.data.data||a.data||[];De.value=Array.isArray(l)?l:[],De.value.length&&!Oe.value&&(Oe.value=De.value[0].id)}catch(a){console.error("Error fetching classrooms:",a),Fe.notify({type:"negative",message:"Failed to load classrooms"})}finally{Xe.value=!1}}},ya=async()=>{if(Ge.value&&Oe.value){Ye.value=!0;try{const e=await G.get("/admin/schedules",{params:{copy_id:Ge.value.id,classroom_id:Oe.value}}),a=e.data.data||e.data||[];Me.value=Array.isArray(a)?a:[],e.data.classroom_stats&&(oa.value=e.data.classroom_stats),e.data.overall_stats&&(ca.value=e.data.overall_stats),e.data.stats&&(sa.value=e.data.stats),oa.value||ca.value||ba(),await pa()}catch(e){console.error("Error fetching schedules:",e),Fe.notify({type:"negative",message:"Failed to load schedules"})}finally{Ye.value=!1}}},pa=async()=>{var e;if(Ge.value)try{const a=await G.get("/weekly-system/api/teacher-conflicts",{params:{copy_id:Ge.value.id}});Be.value=(null==(e=a.data.data)?void 0:e.conflicts)||{}}catch(a){console.error("Error fetching teacher conflicts:",a),Be.value={}}},fa=async()=>{if(!Ge.value)return;const e=Ge.value;if(e){ea.value=!0;try{const a=await G.get("/api/classroom-subject-teachers",{params:{school_id:e.school_id,classroom_id:Oe.value}});Ie.value=(a.data.data||a.data||[]).map(e=>({...e,display_label:`${e.subject_name} - ${e.teacher_name}`}))}catch(a){console.error("Error fetching CST options:",a)}finally{ea.value=!1}}},_a=async()=>{if(!Ge.value)return;const e=Ge.value;if(e){aa.value=!0;try{const a=await G.get("/api/teachers",{params:{school_id:e.school_id}});Ue.value=a.data.data||a.data||[]}catch(a){console.error("Error fetching teachers:",a)}finally{aa.value=!1}}},ga=async()=>{la.value=!0;try{const e=await G.get("/api/subjects");$e.value=e.data.data||e.data||[]}catch(e){console.error("Error fetching subjects:",e)}finally{la.value=!1}},ba=()=>{if(!Array.isArray(Me.value)||0===Me.value.length)return void(sa.value={total_slots:0,assigned_slots:0,unassigned_slots:0,conflict_count:0});const e=Me.value.filter(e=>e&&e.cst_id&&null!=e.day_number&&null!=e.period_number).length,a=Me.value.length,l=Object.keys(Be.value||{}).length;sa.value={total_slots:a,assigned_slots:e,unassigned_slots:a-e,conflict_count:l}},ha=async()=>{},xa=async({day:e,period:a,schedule:l})=>{if(Re.value=e,We.value=a,Le.value=l,Ge.value&&Oe.value){Ke.value=!0,Ne.value=null;try{const l=await G.get("/weekly-system/api/slot-availability",{params:{copy_id:Ge.value.id,classroom_id:Oe.value,day:e,period:a}});Ne.value=l.data.data}catch(t){console.error("Error fetching slot availability:",t),Ne.value=null}finally{Ke.value=!1}}Je.value=!0},wa=e=>{Le.value=e,Re.value=e.day,We.value=e.period_number,Je.value=!0},ka=async e=>{try{await G.put(`/admin/schedules/${e.id}`,{cst_id:null,teacher_substitute_id:null,co_teacher_id:null,co_subject_id:null}),Fe.notify({type:"info",message:"Schedule slot cleared"}),await ya()}catch(a){console.error("Error clearing schedule:",a),Fe.notify({type:"negative",message:"Failed to clear schedule"})}},ja=async e=>{var a,l;ta.value=!0;try{const a={...e,day:e.day,period_number:e.period};if(e.schedule_id)await G.put(`/admin/schedules/${e.schedule_id}`,a);else{if(!Ge.value)return void Fe.notify({type:"negative",message:"No active schedule copy found"});await G.post("/admin/schedules",{...a,copy_id:Ge.value.id,school_id:Ge.value.school_id,day_number:e.day})}Fe.notify({type:"positive",message:"Schedule updated successfully"}),Je.value=!1,await ya()}catch(t){console.error("Error saving schedule:",t),Fe.notify({type:"negative",message:(null==(l=null==(a=t.response)?void 0:a.data)?void 0:l.message)||"Failed to save schedule"})}finally{ta.value=!1}},Sa=e=>{},qa=async e=>{var a;ua.value=e,ia.value=!0,ra.value=!0,na.value=[];try{const l={copy_id:null==(a=Ge.value)?void 0:a.id};"classroom"===e&&Oe.value&&(l.classroom_id=Oe.value);const t=await G.get("/weekly-system/api/teacher-conflicts",{params:l});if(t.data.success&&t.data.data){const e=t.data.data.conflicts||[],a=(Array.isArray(e)?e:Object.values(e)).filter(e=>!e.schedule_id);na.value=a.map(e=>({teacher_name:e.teacher_name,day_name:Ea(e.day),period_number:e.period,classrooms:e.classrooms.map(e=>e.classroom_name)}))}}catch(l){console.error("Error fetching conflict details:",l),Fe.notify({type:"negative",message:"Failed to load conflict details"})}finally{ra.value=!1}},Ea=e=>["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e-1]||`Day ${e}`,Qa=async()=>{Me.value=[],await ya(),Fe.notify({type:"positive",message:"AI import completed successfully! Timetable refreshed.",position:"top"})},Ca=async()=>{Me.value=[],await ya(),Fe.notify({type:"positive",message:"Random fill completed successfully! Timetable refreshed.",position:"top"})};return S(Ge,async e=>{e&&(Oe.value=null,De.value=[],Me.value=[],sa.value=null,await Promise.all([va(),_a(),ga()]))}),S(Oe,async e=>{e&&await Promise.all([ya(),fa()])}),q(async()=>{await(async()=>{Ze.value=!0;try{const e=await G.get("/admin/schedule-copies"),a=e.data.data||e.data||[];Pe.value=Array.isArray(a)?a:a.data||[]}catch(e){console.error("Error fetching schedule copies:",e),Fe.notify({type:"negative",message:"Failed to load schedule copies"})}finally{Ze.value=!1}})()}),(e,a)=>{var k,j;const S=E("Head");return C(),Q($,null,[A(S,{title:z(Ve)("weeklySystem.timetableEditor.title")},null,8,["title"]),T("div",K,[A(L),T("div",Z,[T("div",X,[T("h4",Y,[A(l,{name:"grid_view",class:"q-mr-sm",color:"primary"}),F(" "+P(z(Ve)("weeklySystem.timetableEditor.title")),1)]),T("p",ee,P(z(Ve)("weeklySystem.timetableEditor.subtitle")),1)])]),A(u,{flat:"",bordered:"",class:"q-pa-md q-mb-lg"},{default:D(()=>[T("div",ae,[T("div",le,[Ze.value?(C(),V(_,{key:0,type:"rect",height:"40px"})):Ge.value?(C(),V(t,{key:1,dense:"",class:"bg-grey-1",rounded:""},{default:D(()=>{var e,a;return[T("div",te,[A(l,{name:"content_copy",color:"primary",class:"q-mr-sm"}),T("div",se,[T("div",oe,P(Ge.value.name),1),T("div",ce,P(null==(e=Ge.value.academic_year)?void 0:e.name)+" - "+P(null==(a=Ge.value.semester)?void 0:a.name),1)]),T("div",ie,[A(J,{status:Ge.value.status},null,8,["status"])])])]}),_:1})):(C(),V(t,{key:2,dense:"",class:"bg-red-1 text-red-9",rounded:""},{default:D(()=>[T("div",re,[A(l,{name:"error",class:"q-mr-sm"}),T("div",null,P(z(Ve)("common.noActiveSchedule")),1)])]),_:1}))]),T("div",ne,[A(g,{modelValue:Oe.value,"onUpdate:modelValue":[a[0]||(a[0]=e=>Oe.value=e),ha],options:De.value,"option-value":"id","option-label":"name",label:z(Ve)("weeklyPlans.classroom"),outlined:"",dense:"","emit-value":"","map-options":"",loading:Xe.value,disable:!Ge.value},{prepend:D(()=>[A(l,{name:"meeting_room",color:"secondary"})]),option:D(({opt:e,itemProps:a})=>[A(s,M(I(a)),{default:D(()=>[A(o,null,{default:D(()=>[A(c,null,{default:D(()=>[F(P(e.name),1)]),_:2},1024),A(c,{caption:""},{default:D(()=>{var a;return[F(P((null==(a=e.grade)?void 0:a.name)||e.grade_name),1)]}),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","label","loading","disable"])]),T("div",ue,[A(i,{color:"secondary",icon:"psychology",label:z(Ve)("common.aiGenerate"),outline:"",disable:!Ge.value||!Oe.value,onClick:a[1]||(a[1]=e=>da.value=!0)},{default:D(()=>[Ge.value&&Oe.value?U("",!0):(C(),V(r,{key:0},{default:D(()=>[F(P(z(Ve)("common.selectClassroomFirst")),1)]),_:1}))]),_:1},8,["label","disable"])]),T("div",de,[A(i,{color:"positive",icon:"shuffle",label:"Random Fill",outline:"",disable:!Ge.value||!Oe.value,onClick:a[2]||(a[2]=e=>ma.value=!0)},{default:D(()=>[Ge.value&&Oe.value?U("",!0):(C(),V(r,{key:0},{default:D(()=>[F(P(z(Ve)("common.selectClassroomFirst")),1)]),_:1}))]),_:1},8,["disable"])]),T("div",me,[ca.value?(C(),Q("div",ve,[T("div",ye,P(z(Ve)("weeklyPlans.totalSlots"))+" ("+P(z(Ve)("weeklyPlans.allClassrooms"))+")",1),T("div",pe,[A(n,{dense:"",icon:"apps",color:"blue-2","text-color":"blue-9",size:"sm"},{default:D(()=>[F(P(ca.value.total_slots)+" "+P(z(Ve)("common.total")),1)]),_:1}),A(n,{dense:"",icon:"check_circle",color:"green-2","text-color":"green-9",size:"sm"},{default:D(()=>[F(P(ca.value.assigned_slots)+" "+P(z(Ve)("common.assigned")),1)]),_:1}),A(n,{dense:"",icon:"radio_button_unchecked",color:"grey-3","text-color":"grey-8",size:"sm"},{default:D(()=>[F(P(ca.value.unassigned_slots)+" "+P(z(Ve)("common.empty")),1)]),_:1}),ca.value.conflict_count>0?(C(),V(n,{key:0,dense:"",icon:"warning",color:"orange-2","text-color":"orange-9",size:"sm",clickable:"",onClick:a[3]||(a[3]=e=>qa("overall"))},{default:D(()=>[F(P(ca.value.conflict_count)+" "+P(z(Ve)("common.conflicts")),1)]),_:1})):U("",!0)])])):U("",!0),oa.value?(C(),Q("div",fe,[T("div",_e,P(z(Ve)("weeklyPlans.totalSlots"))+" ("+P(z(Ve)("weeklyPlans.currentClassroom"))+")",1),T("div",ge,[A(n,{dense:"",icon:"apps",color:"blue-2","text-color":"blue-9",size:"sm"},{default:D(()=>[F(P(oa.value.total_slots)+" "+P(z(Ve)("common.total")),1)]),_:1}),A(n,{dense:"",icon:"check_circle",color:"green-2","text-color":"green-9",size:"sm"},{default:D(()=>[F(P(oa.value.assigned_slots)+" "+P(z(Ve)("common.assigned")),1)]),_:1}),A(n,{dense:"",icon:"radio_button_unchecked",color:"grey-3","text-color":"grey-8",size:"sm"},{default:D(()=>[F(P(oa.value.unassigned_slots)+" "+P(z(Ve)("common.empty")),1)]),_:1}),oa.value.conflict_count>0?(C(),V(n,{key:0,dense:"",icon:"warning",color:"orange-2","text-color":"orange-9",size:"sm",clickable:"",onClick:a[4]||(a[4]=e=>qa("classroom"))},{default:D(()=>[F(P(oa.value.conflict_count)+" "+P(z(Ve)("common.conflicts")),1)]),_:1})):U("",!0)]),oa.value.subject_breakdown&&oa.value.subject_breakdown.length>0?(C(),Q("div",be,[a[11]||(a[11]=T("div",{class:"text-caption text-grey-7 q-mb-xs"},"Subject Breakdown",-1)),A(h,{dense:"",flat:"",bordered:"",class:"subject-breakdown-table"},{default:D(()=>[a[10]||(a[10]=T("thead",null,[T("tr",null,[T("th",{class:"text-left"},"Subject"),T("th",{class:"text-left"},"Teacher"),T("th",{class:"text-center"},"Expected"),T("th",{class:"text-center"},"Actual"),T("th",{class:"text-center"},"Status")])],-1)),T("tbody",null,[(C(!0),Q($,null,B(oa.value.subject_breakdown,(e,t)=>(C(),Q("tr",{key:t},[T("td",he,[A(b,{color:"blue-2","text-color":"blue-9"},{default:D(()=>[F(P(e.subject_name),1)]),_:2},1024)]),T("td",xe,P(e.teacher_name),1),T("td",we,[A(n,{dense:"",size:"sm",color:"grey-3","text-color":"grey-9"},{default:D(()=>[F(P(e.expected),1)]),_:2},1024)]),T("td",ke,[A(n,{dense:"",size:"sm",color:e.actual===e.expected?"green-2":"orange-2","text-color":e.actual===e.expected?"green-9":"orange-9"},{default:D(()=>[F(P(e.actual),1)]),_:2},1032,["color","text-color"])]),T("td",je,[e.actual===e.expected?(C(),V(l,{key:0,name:"check_circle",color:"positive",size:"sm"},{default:D(()=>[A(r,null,{default:D(()=>a[9]||(a[9]=[F("Correct")])),_:1})]),_:1})):e.actual<e.expected?(C(),V(l,{key:1,name:"arrow_downward",color:"warning",size:"sm"},{default:D(()=>[A(r,null,{default:D(()=>[F("Missing "+P(e.expected-e.actual)+" period(s)",1)]),_:2},1024)]),_:2},1024)):(C(),V(l,{key:2,name:"arrow_upward",color:"warning",size:"sm"},{default:D(()=>[A(r,null,{default:D(()=>[F(P(e.actual-e.expected)+" extra period(s)",1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})])):U("",!0)])):U("",!0)])])]),_:1}),Ye.value?(C(),Q("div",Se,[A(x,{size:"50px",color:"primary"})])):Ge.value?Oe.value?(C(),V(H,{key:3,schedules:Me.value,"teacher-conflicts":Be.value,onCellClick:xa,onEdit:wa,onClear:ka},null,8,["schedules","teacher-conflicts"])):(C(),V(u,{key:2,flat:"",bordered:"",class:"text-center q-pa-xl"},{default:D(()=>[A(l,{name:"touch_app",size:"64px",color:"grey-5"}),T("p",Qe,P(z(Ve)("weeklySystem.timetableEditor.selectClassroom")),1),T("p",Ce,P(z(Ve)("weeklySystem.timetableEditor.chooseClassroom")),1)]),_:1})):(C(),V(u,{key:1,flat:"",bordered:"",class:"text-center q-pa-xl"},{default:D(()=>[A(l,{name:"error",size:"64px",color:"red-5"}),T("p",qe,P(z(Ve)("common.noActiveSchedule")),1),T("p",Ee,P(z(Ve)("weeklySystem.timetableEditor.activateSchedule")),1)]),_:1})),A(f,{modelValue:Je.value,"onUpdate:modelValue":a[5]||(a[5]=e=>Je.value=e),schedule:Le.value,day:Re.value,period:We.value,"classroom-name":He.value,"cst-options":Ie.value,teachers:Ue.value,subjects:$e.value,"loading-c-s-t":ea.value,"loading-teachers":aa.value,"loading-subjects":la.value,saving:ta.value,"slot-availability":Ne.value,"loading-availability":Ke.value,onSubmit:ja,onFilterCst:Sa},null,8,["modelValue","schedule","day","period","classroom-name","cst-options","teachers","subjects","loading-c-s-t","loading-teachers","loading-subjects","saving","slot-availability","loading-availability"]),A(y,{modelValue:ia.value,"onUpdate:modelValue":a[6]||(a[6]=e=>ia.value=e),position:"right"},{default:D(()=>[A(u,{style:{width:"500px","max-width":"80vw"}},{default:D(()=>[A(d,{class:"row items-center q-pb-none"},{default:D(()=>[T("div",Ae,P(z(Ve)("weeklySystem.timetableEditor.conflictDetails")),1),A(w),O(A(i,{icon:"close",flat:"",round:"",dense:""},null,512),[[p]])]),_:1}),A(d,null,{default:D(()=>[ra.value?(C(),Q("div",Te,[A(m,{color:"primary",size:"3em"})])):0===na.value.length?(C(),Q("div",ze,P(z(Ve)("common.noConflicts")),1)):(C(),V(v,{key:2,separator:""},{default:D(()=>[(C(!0),Q($,null,B(na.value,(e,a)=>(C(),V(s,{key:a},{default:D(()=>[A(o,null,{default:D(()=>[A(c,{class:"text-weight-medium"},{default:D(()=>[F(P(e.teacher_name),1)]),_:2},1024),A(c,{caption:""},{default:D(()=>[F(P(e.day_name)+" - Period "+P(e.period_number),1)]),_:2},1024),A(c,{caption:"",class:"text-orange-9"},{default:D(()=>[F(P(z(Ve)("weeklySystem.timetableEditor.assignedTo"))+": "+P(e.classrooms.join(", ")),1)]),_:2},1024)]),_:2},1024),A(o,{side:""},{default:D(()=>[A(b,{color:"orange",label:e.classrooms.length+" classes"},null,8,["label"])]),_:2},1024)]),_:2},1024))),128))]),_:1}))]),_:1})]),_:1})]),_:1},8,["modelValue"]),A(R,{modelValue:da.value,"onUpdate:modelValue":a[7]||(a[7]=e=>da.value=e),"classroom-id":Oe.value,"classroom-name":He.value,subjects:$e.value,"copy-id":null==(k=Ge.value)?void 0:k.id,onApplied:Qa},null,8,["modelValue","classroom-id","classroom-name","subjects","copy-id"]),A(W,{modelValue:ma.value,"onUpdate:modelValue":a[8]||(a[8]=e=>ma.value=e),"classroom-id":Oe.value,"classroom-name":He.value,"copy-id":null==(j=Ge.value)?void 0:j.id,onApplied:Ca},null,8,["modelValue","classroom-id","classroom-name","copy-id"])])],64)}}},[["__scopeId","data-v-3cd270d9"]]);export{Ve as default};
