import{u as e,e as a,a as l,Q as s,q as t,n}from"./app-BXm70mdJ.js";import{Q as i}from"./QSelect-CnZtzPIC.js";import{f as o,a as r,o as c,L as u,I as d,b as m,J as p,M as y,V as v,Z as g}from"./vendor-DNM7Y6Xn.js";import f from"./WeekSelector-CR0I50Iw.js";import"./offline-BzIlwqNM.js";import"./i18n-CBOKL2HS.js";import"./ui-BP0GJNn5.js";import"./rtl-Cr6c3OOr.js";const w={class:"q-pa-md"},k={class:"row q-col-gutter-md items-end"},h={class:"col-12 col-sm-4"},_={class:"col-12 col-sm-4"},b={class:"col-12 col-sm-4"},S={class:"row q-gutter-md justify-center"},x={class:"q-mt-xl text-center text-grey-7"},q={__name:"WeeklyPlanSync",props:{initialCopyId:[Number,String],initialSemester:Number,initialWeek:Number},emits:["update:week","update:copy","update:semester","refreshed"],setup(q,{emit:V}){const j=q,W=V,C=e(),G=o([]),N=o(!1),z=o(j.initialCopyId),D=o(j.initialSemester||1),F=o(j.initialWeek||1),I=o(18),P=o(1),Q=[{label:"Semester 1",value:1},{label:"Semester 2",value:2}],U=r(()=>G.value.find(e=>e.id===z.value)),E=o(!1),L=async()=>{var e,a;if(z.value){N.value=!0;try{const e=(await g.post("/weekly-system/api/weekly-plans/generate",{copy_id:z.value,week_number:F.value,semester_number:D.value})).data;C.notify({type:"positive",message:`Generated ${e.created} plans (${e.skipped} already existed)`}),W("refreshed")}catch(l){console.error("Error generating plans:",l),C.notify({type:"negative",message:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"Failed to generate plans"})}finally{N.value=!1}}else C.notify({type:"warning",message:"Please select a schedule copy first"})},M=async()=>{if(U.value){C.loading.show({message:"Syncing week plans..."});try{const e=await g.post("/weekly-system/api/weekly-plans/sync-week",{academic_year_id:U.value.academic_year_id,semester_number:D.value,week_number:F.value});C.notify({type:"positive",message:e.data.message||"Week synced successfully"}),W("refreshed")}catch(e){console.error("Sync error:",e),C.notify({type:"negative",message:"Failed to sync week"})}finally{C.loading.hide()}}else C.notify({type:"warning",message:"No active schedule found"})};return c(()=>{(async()=>{E.value=!0;try{const e=await g.get("/admin/schedule-copies",{params:{status:"active"}}),a=e.data.data||e.data||[];G.value=a.filter(e=>"active"===e.status),G.value.length&&!z.value&&(z.value=G.value[0].id)}catch(e){console.error("Error fetching copies:",e)}finally{E.value=!1}})();const e=new Date,a=new Date(e.getFullYear(),0,1);P.value=Math.ceil(((e-a)/864e5+a.getDay()+1)/7),j.initialWeek||(F.value=P.value>I.value?1:P.value)}),(e,o)=>(d(),u("div",w,[m(n,{flat:"",bordered:"",class:"q-pa-md"},{default:p(()=>[y("div",k,[y("div",h,[m(i,{modelValue:z.value,"onUpdate:modelValue":o[0]||(o[0]=e=>z.value=e),options:G.value,"option-value":"id","option-label":"name",label:"Active Schedule",outlined:"",dense:"","emit-value":"","map-options":"",loading:E.value},{prepend:p(()=>[m(a,{name:"content_copy",color:"primary"})]),_:1},8,["modelValue","options","loading"])]),y("div",_,[m(i,{modelValue:D.value,"onUpdate:modelValue":o[1]||(o[1]=e=>D.value=e),options:Q,label:"Semester",outlined:"",dense:"","emit-value":"","map-options":""},{prepend:p(()=>[m(a,{name:"date_range",color:"secondary"})]),_:1},8,["modelValue"])]),y("div",b,[m(f,{modelValue:F.value,"onUpdate:modelValue":o[2]||(o[2]=e=>F.value=e),"max-weeks":I.value,"current-week":P.value},null,8,["modelValue","max-weeks","current-week"])])]),m(l,{class:"q-my-lg"}),y("div",S,[m(s,{color:"primary",icon:"auto_fix_high",label:"Generate Plans",loading:N.value,onClick:L,size:"lg",class:"q-px-xl"},{default:p(()=>[m(t,null,{default:p(()=>o[3]||(o[3]=[v("Generate weekly plans for all teachers for this week")])),_:1})]),_:1},8,["loading"]),m(s,{outline:"",color:"secondary",icon:"sync",label:"Sync Current Week",onClick:M,size:"lg",class:"q-px-xl"},{default:p(()=>[m(t,null,{default:p(()=>o[4]||(o[4]=[v("Sync current week plans with any schedule changes")])),_:1})]),_:1})]),y("div",x,[m(a,{name:"info",color:"info",size:"xs",class:"q-mr-sm"}),o[5]||(o[5]=v(" Generating plans will create empty weekly plan entries based on the active schedule. Syncing will ensure any changes in the schedule (like new classes) are reflected in the current week's plans. "))])]),_:1})]))}};export{q as default};
