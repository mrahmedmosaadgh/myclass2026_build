import{M as e}from"./Modal-DM1yMaqp.js";import{f as t,k as r,N as s,J as l,R as a,b as o,V as n,a0 as i,U as u,K as d,O as c,F as p,Q as v,W as m,_ as g}from"./vendor-BWKGNkNB.js";import{read as f,utils as x}from"./xlsx-BHXqx-YI.js";import{r as y}from"./app-BxJhpxku.js";import"./offline-BzIlwqNM.js";import"./i18n-B0T1C7j3.js";import"./ui-B7TfxbV_.js";const h={class:"flex flex-col items-center justify-center space-y-3 cursor-pointer"},w={class:"text-lg font-medium text-gray-700"},b={class:"p-6"},k={class:"flex justify-between items-center mb-4"},C={class:"text-lg font-medium text-gray-900"},S={class:"text-sm text-gray-500"},T={key:0,class:"overflow-x-auto mb-6 rounded-lg border border-gray-200 shadow"},j={class:"min-w-full divide-y divide-gray-200"},B={class:"bg-blue-50"},E={key:0,class:"text-red-500 ml-1"},A={class:"bg-white divide-y divide-gray-200"},U={key:0},_={key:1,class:"text-gray-400 italic"},I={class:"px-6 py-4 whitespace-nowrap text-sm"},M={class:"flex justify-end space-x-3"},z=["disabled"],q={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},P={class:"p-6"},D={class:"flex items-center justify-between mb-6"},N={class:"text-xl font-semibold text-gray-900"},V={key:0,class:"mb-6 bg-green-50 border border-green-200 rounded-lg p-4"},R={class:"flex items-center mb-3"},$={class:"text-green-800 font-medium"},F={class:"pl-7"},L={class:"text-sm text-green-700 space-y-1 max-h-40 overflow-y-auto"},W={key:1,class:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4"},H={class:"flex items-center mb-3"},O={class:"text-red-800 font-medium"},J={class:"pl-7"},K={class:"text-sm text-red-700 space-y-1 max-h-40 overflow-y-auto"},Q={class:"mt-6 flex justify-end space-x-3"},Z=["disabled"],G={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 text-red-700",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},X={key:1,class:"-ml-1 mr-2 h-4 w-4 text-red-700",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},Y=y({__name:"ImportExcel",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"}},emits:["imported","validation-success","validation-error"],setup(y,{emit:Y}){const ee=y,te=Y,re=t(null),se=t(!1),le=t(!1),ae=t(!1),oe=t(!1),ne=t([]),ie=t({success:[],errors:[]}),ue=t(!1),de=t(null),ce=t(!1);r(()=>ee.columns,()=>{ne.value.length>0&&(ne.value=ne.value.map(e=>{const t={};return ee.columns.forEach(r=>{t[r.key]=e.data[r.key]}),{...e,data:t}}))},{deep:!0});const pe=e=>{if(!e)return;const t=new FileReader;t.onload=e=>{const t=new Uint8Array(e.target.result),r=f(t,{type:"array"}),s=r.Sheets[r.SheetNames[0]],l=x.sheet_to_json(s,{header:1});l.shift(),ne.value=l.filter(e=>e.length).map(e=>{const t={};return ee.columns.forEach((r,s)=>{t[r.key]=e[s]}),{data:t,status:"new"}}),ge(),ae.value=!0},t.readAsArrayBuffer(e)},ve=e=>{const t=e.target.files[0];pe(t)},me=e=>{ce.value=!1;const t=e.dataTransfer.files[0];pe(t)},ge=async()=>{try{const e=ee.columns.filter(e=>e.required).map(e=>e.key),t=ne.value.map(e=>{const t={};return ee.columns.forEach(r=>{let s=e.data[r.key];null==s&&(s=""),t[r.key]=String(s).trim()}),t}),r=[],s=t.map(()=>"valid");if(t.forEach((t,l)=>{e.forEach(e=>{t[e]&&""!==String(t[e]).trim()||(r.push(`Row ${l+1}: Missing required field '${e}'`),s[l]="error")})}),ne.value=ne.value.map((e,t)=>({...e,status:s[t]})),r.length)return ie.value={success:[],errors:r},oe.value=!0,void console.warn("Local validation prevented server call:",r);const l={data:t,required_fields:e,columns:ee.columns};console.debug("validatePreviewData payload:",l);const a=await g.post(ee.validateUrl,l);ne.value=ne.value.map((e,t)=>({...e,status:a.data.stats.invalid_rows>0?"warning":"valid"})),te("validation-success",a.data)}catch(e){console.error("Validation error:",e);const t=[];if(e.response&&e.response.data){const r=e.response.data;r.message&&t.push(r.message),r.errors&&(Array.isArray(r.errors)?r.errors.forEach(e=>t.push(e)):Object.values(r.errors).forEach(e=>{Array.isArray(e)?e.forEach(e=>t.push(e)):t.push(String(e))}))}else t.push("Validation failed.");ie.value={success:[],errors:t},oe.value=!0}},fe=async()=>{var e,t;se.value=!0,NProgress.start();try{const e=await g.post(ee.importUrl,{data:ne.value.map(e=>e.data),columns:ee.columns});te("imported"),ie.value=e.data.results,de.value=e.data.importId,ue.value=!!ee.undoUrl,ae.value=!1,oe.value=!0}catch(r){console.error("Import error:",r),ie.value={success:[],errors:[(null==(t=null==(e=r.response)?void 0:e.data)?void 0:t.message)||"An error occurred during import"]},oe.value=!0}finally{se.value=!1,NProgress.done(),re.value.value=""}},xe=async()=>{if(de.value&&ee.undoUrl){le.value=!0,NProgress.start();try{await g.post(`${ee.undoUrl}/${de.value}`),ue.value=!1,te("imported"),he()}catch(e){alert("Failed to undo the import")}finally{le.value=!1,NProgress.done()}}},ye=()=>{ae.value=!1,ne.value=[],re.value.value=""},he=()=>{oe.value=!1,ie.value={success:[],errors:[]},de.value=null,ue.value=!1};return(t,r)=>(l(),s("div",null,[a("input",{type:"file",ref_key:"fileInput",ref:re,class:"hidden",accept:".xlsx,.xls",onChange:ve},null,544),a("div",{class:u(["border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors duration-200",{"border-blue-500 bg-blue-50":ce.value}]),onDragover:r[0]||(r[0]=i(e=>ce.value=!0,["prevent"])),onDragleave:r[1]||(r[1]=i(e=>ce.value=!1,["prevent"])),onDrop:i(me,["prevent"]),onClick:r[2]||(r[2]=e=>t.$refs.fileInput.click())},[a("div",h,[r[3]||(r[3]=a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})],-1)),a("div",w,n(y.buttonText),1),r[4]||(r[4]=a("p",{class:"text-sm text-gray-500"},"Drag and drop your Excel file here, or click to browse",-1)),r[5]||(r[5]=a("div",{class:"text-xs text-gray-400"},"Supported formats: .xlsx, .xls",-1))])],34),o(e,{show:ae.value,onClose:ye,maxWidth:"4xl"},{default:d(()=>[a("div",b,[a("div",k,[a("h3",C,n(y.previewTitle),1),a("div",S," Total Records: "+n(ne.value.length),1)]),ae.value?(l(),s("div",T,[a("table",j,[a("thead",B,[a("tr",null,[(l(!0),s(p,null,v(y.columns.filter(e=>!e.hidden),e=>(l(),s("th",{key:e.key,class:"px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider"},[m(n(e.label)+" ",1),e.required?(l(),s("span",E,"*")):c("",!0)]))),128)),r[6]||(r[6]=a("th",{class:"px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider"}," Status ",-1))])]),a("tbody",A,[(l(!0),s(p,null,v(ne.value,(e,t)=>(l(),s("tr",{key:t,class:"hover:bg-gray-50 transition-colors duration-150"},[(l(!0),s(p,null,v(y.columns.filter(e=>!e.hidden),t=>(l(),s("td",{key:t.key,class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},[e.data[t.key]?(l(),s("span",U,n(e.data[t.key]),1)):(l(),s("span",_,"Empty"))]))),128)),a("td",I,[a("span",{class:u({"px-2 py-1 rounded-full text-xs font-medium":!0,"bg-green-100 text-green-800":"valid"===e.status,"bg-yellow-100 text-yellow-800":"warning"===e.status||"new"===e.status,"bg-red-100 text-red-800":"error"===e.status})},n(e.status),3)])]))),128))])])])):c("",!0),a("div",M,[a("button",{onClick:ye,class:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"},n(y.cancelButtonText),1),a("button",{onClick:fe,disabled:se.value||!ne.value.length,class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"},[se.value?(l(),s("svg",q,r[7]||(r[7]=[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):c("",!0),m(" "+n(se.value?y.processingText:y.confirmButtonText),1)],8,z)])])]),_:1},8,["show"]),o(e,{show:oe.value,onClose:he,maxWidth:"2xl"},{default:d(()=>[a("div",P,[a("div",D,[a("h3",N,n(y.resultsTitle),1),r[8]||(r[8]=a("div",{class:"bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full"}," Import Complete ",-1))]),ie.value.success.length?(l(),s("div",V,[a("div",R,[r[9]||(r[9]=a("svg",{class:"w-5 h-5 text-green-500 mr-2",fill:"currentColor",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg"},[a("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),a("h4",$,"Success ("+n(ie.value.success.length)+")",1)]),a("div",F,[a("ul",L,[(l(!0),s(p,null,v(ie.value.success,(e,t)=>(l(),s("li",{key:t,class:"flex items-start"},[r[10]||(r[10]=a("span",{class:"mr-1"},"•",-1)),a("span",null,n(e),1)]))),128))])])])):c("",!0),ie.value.errors.length?(l(),s("div",W,[a("div",H,[r[11]||(r[11]=a("svg",{class:"w-5 h-5 text-red-500 mr-2",fill:"currentColor",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg"},[a("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),a("h4",O,"Errors ("+n(ie.value.errors.length)+")",1)]),a("div",J,[a("ul",K,[(l(!0),s(p,null,v(ie.value.errors,(e,t)=>(l(),s("li",{key:t,class:"flex items-start"},[r[12]||(r[12]=a("span",{class:"mr-1"},"•",-1)),a("span",null,n(e),1)]))),128))])])])):c("",!0),a("div",Q,[ue.value?(l(),s("button",{key:0,onClick:xe,disabled:le.value,class:"px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"},[le.value?(l(),s("svg",G,r[13]||(r[13]=[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(l(),s("svg",X,r[14]||(r[14]=[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"},null,-1)]))),m(" "+n(le.value?y.undoingText:y.undoButtonText),1)],8,Z)):c("",!0),a("button",{onClick:he,class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},n(y.closeButtonText),1)])])]),_:1},8,["show"])]))}},[["__scopeId","data-v-8c405ccd"]]);export{Y as default};
