import{_ as e}from"./SecondaryButton-DFYJg0hY.js";import{_ as t}from"./PrimaryButton-CsGumtxq.js";import{M as a}from"./Modal-Gmv4jxfs.js";import{aU as l}from"./app-ggGwxJON.js";import{f as s,k as r,N as u,J as n,O as o,b as i,K as d,V as c,Q as v,F as m,R as p,U as y,W as f,I as x,_ as g}from"./vendor-nQjeLEvd.js";import{r as h,u as w}from"./xlsx-cMC2LkxH.js";const b={class:"p-6"},k={class:"flex justify-between items-center mb-4"},T={class:"text-lg font-medium text-gray-900"},_={class:"text-sm text-gray-500"},S={key:0,class:"overflow-x-auto mb-4"},U={class:"min-w-full divide-y divide-gray-200"},B={class:"bg-gray-50"},C={class:"bg-white divide-y divide-gray-200"},I={class:"px-6 py-4 whitespace-nowrap text-sm"},j={class:"flex justify-end space-x-2"},q={class:"p-6"},A={class:"text-lg font-medium text-gray-900 mb-4"},E={key:0,class:"mb-4"},F={class:"text-green-600 font-medium mb-2"},R={class:"text-sm text-gray-600"},P={key:1,class:"mb-4"},W={class:"text-red-600 font-medium mb-2"},$={class:"text-sm text-red-600"},M={class:"mt-6 flex justify-end space-x-2"},N={__name:"ImportExcel",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"}},emits:["imported","validation-success"],setup(N,{emit:V}){const D=N,H=V,J=s(null),K=s(!1),O=s(!1),Q=s(!1),z=s(!1),G=s([]),L=s({success:[],errors:[]}),X=s(!1),Y=s(null);r(()=>D.columns,()=>{G.value.length>0&&(G.value=G.value.map(e=>{const t={};return D.columns.forEach(a=>{t[a.key]=e.data[a.key]}),{...e,data:t}}))},{deep:!0});const Z=e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=e=>{const t=new Uint8Array(e.target.result),a=h(t,{type:"array"}),l=a.Sheets[a.SheetNames[0]],s=w.sheet_to_json(l,{header:1});s.shift(),G.value=s.filter(e=>e.length).map(e=>{const t={};return D.columns.forEach((a,l)=>{t[a.key]=e[l]}),{data:t,status:"new"}}),ee(),Q.value=!0},a.readAsArrayBuffer(t)},ee=async()=>{var e,t,a;try{const l=D.columns.filter(e=>e.required).map(e=>e.key),s=await g.post(D.validateUrl,{data:G.value.map(e=>e.data),required_fields:l,columns:D.columns}),r=(null==(e=s.data.summary)?void 0:e.invalid_rows)>0||(null==(a=null==(t=s.data.summary)?void 0:t.errors)?void 0:a.length)>0;G.value=G.value.map((e,t)=>({...e,status:r?"warning":"valid"})),H("validation-success",s.data)}catch(l){console.error("Validation error:",l),G.value=G.value.map(e=>({...e,status:"error"}))}},te=async()=>{var e,t;K.value=!0,l.start();try{const e=await g.post(D.importUrl,{data:G.value.map(e=>e.data),columns:D.columns});H("imported"),L.value=e.data.results,Y.value=e.data.importId,X.value=!!D.undoUrl,Q.value=!1,z.value=!0}catch(a){console.error("Import error:",a),L.value={success:[],errors:[(null==(t=null==(e=a.response)?void 0:e.data)?void 0:t.message)||"An error occurred during import"]},z.value=!0}finally{K.value=!1,l.done(),J.value.value=""}},ae=async()=>{if(Y.value&&D.undoUrl){O.value=!0,l.start();try{await g.post(`${D.undoUrl}/${Y.value}`),X.value=!1,H("imported"),se()}catch(e){alert("Failed to undo the import")}finally{O.value=!1,l.done()}}},le=()=>{Q.value=!1,G.value=[],J.value.value=""},se=()=>{z.value=!1,L.value={success:[],errors:[]},Y.value=null,X.value=!1};return(l,s)=>(n(),u("div",null,[o("input",{type:"file",ref_key:"fileInput",ref:J,class:"hidden",accept:".xlsx,.xls",onChange:Z},null,544),i(e,{onClick:s[0]||(s[0]=e=>l.$refs.fileInput.click()),disabled:K.value,class:"relative"},{default:d(()=>[o("span",null,c(N.buttonText),1)]),_:1},8,["disabled"]),i(a,{show:Q.value,onClose:le,maxWidth:"4xl"},{default:d(()=>[o("div",b,[o("div",k,[o("h3",T,c(N.previewTitle),1),o("div",_," Total Records: "+c(G.value.length),1)]),Q.value?(n(),u("div",S,[o("table",U,[o("thead",B,[o("tr",null,[(n(!0),u(m,null,p(N.columns.filter(e=>!e.hidden),e=>(n(),u("th",{key:e.key,class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},c(e.label),1))),128)),s[1]||(s[1]=o("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Status ",-1))])]),o("tbody",C,[(n(!0),u(m,null,p(G.value,(e,t)=>{return n(),u("tr",{key:t},[(n(!0),u(m,null,p(N.columns.filter(e=>!e.hidden),t=>(n(),u("td",{key:t.key,class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},c(e.data[t.key]),1))),128)),o("td",I,[o("span",{class:y((a=e.status,{"text-yellow-600":"new"===a,"text-blue-600":"update"===a,"text-red-600":"error"===a}))},c(e.status),3)])]);var a}),128))])])])):v("",!0),o("div",j,[i(e,{onClick:le},{default:d(()=>[f(c(N.cancelButtonText),1)]),_:1}),i(t,{onClick:te,disabled:K.value||!G.value.length},{default:d(()=>[f(c(K.value?N.processingText:N.confirmButtonText),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"]),i(a,{show:z.value,onClose:se,maxWidth:"2xl"},{default:d(()=>[o("div",q,[o("h3",A,c(N.resultsTitle),1),L.value.success.length?(n(),u("div",E,[o("h4",F,"Success ("+c(L.value.success.length)+")",1),o("ul",R,[(n(!0),u(m,null,p(L.value.success,(e,t)=>(n(),u("li",{key:t},c(e),1))),128))])])):v("",!0),L.value.errors.length?(n(),u("div",P,[o("h4",W,"Errors ("+c(L.value.errors.length)+")",1),o("ul",$,[(n(!0),u(m,null,p(L.value.errors,(e,t)=>(n(),u("li",{key:t},c(e),1))),128))])])):v("",!0),o("div",M,[X.value?(n(),x(e,{key:0,onClick:ae,disabled:O.value},{default:d(()=>[f(c(O.value?N.undoingText:N.undoButtonText),1)]),_:1},8,["disabled"])):v("",!0),i(t,{onClick:se},{default:d(()=>[f(c(N.closeButtonText),1)]),_:1})])])]),_:1},8,["show"])]))}};export{N as _};
