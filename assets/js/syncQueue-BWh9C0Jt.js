import{db as e}from"./dexie-BiHiwTft.js";import{a as t,f as s,_ as r}from"./vendor-BJyC5yAd.js";import"./import-wrapper-prod-CTSFTTQQ.js";const n=s("idle"),u=s({current:0,total:0}),o=s(null),a=s([]),c=t(()=>"syncing"===n.value);t(()=>a.value.length>0),t(()=>0===u.value.total?100:Math.round(u.value.current/u.value.total*100));const l={MEDIUM:3},i={PENDING:"pending",SYNCING:"syncing",FAILED:"failed",CONFLICT:"conflict"};function d(t,s,r=null,n={}){const u={method:t.toUpperCase(),url:s,payload:r,timestamp:(new Date).toISOString(),retry_count:0,status:i.PENDING,priority:n.priority||l.MEDIUM,resource_type:y(s),options:n};return e.sync_queue.add(u).then(e=>(console.log("ðŸ“¤ Request queued:",{id:e,method:t,url:s}),e)).catch(e=>{throw console.error("âŒ Failed to queue request:",e),e})}function p(t={}){return c.value?(console.log("â³ Sync already in progress"),Promise.resolve({processed:0,errors:0})):(n.value="syncing",a.value=[],e.sync_queue.where("status").equals(i.PENDING).or("status").equals(i.FAILED).sortBy("priority").then(s=>0===s.length?(n.value="idle",{processed:0,errors:0}):(u.value={current:0,total:s.length},function(t){const s={processed:0,errors:0,conflicts:0};return t.reduce((t,n)=>t.then(()=>function(t){return e.sync_queue.update(t.id,{status:i.SYNCING,retry_count:t.retry_count+1}).then(()=>function(e){var t;const s={method:e.method,url:e.url,timeout:1e4,headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"}},n=null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content");n&&(s.headers["X-CSRF-TOKEN"]=n);e.payload&&["POST","PUT","PATCH"].includes(e.method)&&(s.data=e.payload);e.payload&&"GET"===e.method&&(s.params=e.payload);return r(s)}(t)).then(s=>e.sync_queue.delete(t.id).then(()=>({success:!0,response:s}))).catch(s=>function(t,s){var r,n;const u=5,o=409===(null==(r=s.response)?void 0:r.status),c=(null==(n=s.response)?void 0:n.status)>=500,l=!s.response;if(o)return e.sync_queue.update(t.id,{status:i.CONFLICT,error_message:"Data conflict detected"}).then(()=>(a.value.push({id:t.id,type:"conflict",message:"Data conflict requires manual resolution",item:t}),{conflict:!0}));if(t.retry_count>=u)return e.sync_queue.update(t.id,{status:i.FAILED,error_message:s.message}).then(()=>(a.value.push({id:t.id,type:"failed",message:`Failed after ${u} attempts: ${s.message}`,item:t}),{success:!1}));if(c||l)return e.sync_queue.update(t.id,{status:i.PENDING,error_message:s.message}).then(()=>({success:!1}));return e.sync_queue.update(t.id,{status:i.FAILED,error_message:s.message}).then(()=>(a.value.push({id:t.id,type:"client_error",message:`Client error: ${s.message}`,item:t}),{success:!1}))}(t,s))}(n).then(e=>{e.success?s.processed++:e.conflict?s.conflicts++:s.errors++,u.value.current++}).catch(e=>{console.error("âŒ Failed to process queue item:",n.id,e),s.errors++,u.value.current++})),Promise.resolve()).then(()=>s)}(s,t))).then(e=>(n.value=e.errors>0?"error":"idle",o.value=new Date,console.log("âœ… Sync completed:",e),e)).catch(e=>{throw n.value="error",console.error("âŒ Sync failed:",e),e}))}function m(){return Promise.all([e.sync_queue.where("status").equals(i.PENDING).count(),e.sync_queue.where("status").equals(i.FAILED).count(),e.sync_queue.where("status").equals(i.CONFLICT).count(),e.sync_queue.count()]).then(([e,t,s,r])=>({pending:e,failed:t,conflicts:s,total:r,needsAttention:t+s}))}function h(){return e.sync_queue.clear()}function y(e){const t=e.match(/\/api\/([^\/\?]+)/);return t?t[1]:"unknown"}export{l as SYNC_PRIORITIES,i as SYNC_STATUSES,h as clearQueue,m as getSyncQueueStats,c as isSyncing,o as lastSyncTime,p as processQueue,d as queueRequest,a as syncErrors,u as syncProgress,n as syncStatus};
