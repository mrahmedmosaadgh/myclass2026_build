import{r as e,Q as a,d as l,f as t,o as s,aS as r,b as o,e as u,i,k as d,l as n,j as c,h as m,g as v,c as p,bd as g,t as y,aI as f,F as h}from"./app-DlLesFGi.js";import{Q as x}from"./QSelect-BTh0khse.js";import{_ as b}from"./AppLayout-B3PyevP7.js";import{Q as _}from"./QFile-Cve4lAri.js";import{Q as w}from"./QBadge-IdEcTs8C.js";import{Q as k}from"./QTd-BU_S4ffH.js";import{Q as q}from"./QTable-BIAJAIui.js";import{f as S,a as T,k as j,N as I,J as U,R as V,b as C,K as E,V as Q,W as R,y as B,O as P,F,Q as A,I as D,_ as L,o as N,U as $}from"./vendor-BWKGNkNB.js";import{read as O,utils as W}from"./xlsx-BHXqx-YI.js";import"./offline-BzIlwqNM.js";import"./i18n-B0T1C7j3.js";import"./ui-B7TfxbV_.js";import"./rtl-Cr6c3OOr.js";import"./use-file-DHXgO9tP.js";import"./QMarkupTable-CzIo4GGA.js";import"./QLinearProgress-CX6G9yBK.js";import"./use-fullscreen-BQHoXYBI.js";const Y={class:"row items-center q-gutter-md"},G={class:"text-h6"},J={class:"text-subtitle2 text-grey"},K={class:"text-h6"},z={key:0,class:"q-mb-md"},M={class:"text-positive text-weight-medium q-mb-sm"},X={key:1},H={class:"text-negative text-weight-medium q-mb-sm"},Z=e({__name:"ImportExcelQuasar",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"},additionalPayload:{type:Object,default:()=>({})}},emits:["imported","validation-success"],setup(e,{emit:m}){const v=e,p=m,g=S(null),y=S(!1),f=S(!1),h=S(!1),x=S(!1),b=S(!1),N=S([]),$=S({success:[],errors:[]}),Z=S(!1),ee=S(null),ae=T(()=>{const e=v.columns.filter(e=>!e.hidden).map(e=>({name:e.key,label:e.label,field:a=>a.data[e.key],align:"left",sortable:!0}));return e.push({name:"status",label:"Status",field:"status",align:"left",sortable:!0}),e});j(()=>v.columns,()=>{N.value.length>0&&(N.value=N.value.map(e=>{const a={};return v.columns.forEach(l=>{a[l.key]=e.data[l.key]||""}),{...e,data:a}}))},{deep:!0});const le=async e=>{if(e){y.value=!0;try{const a=await e.arrayBuffer(),l=O(a,{type:"array"}),t=l.Sheets[l.SheetNames[0]],s=W.sheet_to_json(t,{header:1}),r=s.shift().map(e=>String(e).trim().toLowerCase());N.value=s.filter(e=>e.length).map((e,a)=>{const l={};return v.columns.forEach((a,t)=>{const s=[a.label,a.key].map(e=>String(e).trim().toLowerCase());let o=r.findIndex(e=>s.includes(e));-1===o&&t<e.length&&(o=t),l[a.key]=-1!==o?e[o]:""}),{index:a,data:l,status:"new"}}),await te(),x.value=!0}catch(a){console.error("Error reading file",a)}finally{y.value=!1}}},te=async()=>{var e,a,l;try{const t=v.columns.filter(e=>e.required).map(e=>e.key),s=await L.post(v.validateUrl,{data:N.value.map(e=>e.data),required_fields:t,columns:v.columns}),r=(null==(e=s.data.summary)?void 0:e.invalid_rows)>0||(null==(l=null==(a=s.data.summary)?void 0:a.errors)?void 0:l.length)>0;N.value=N.value.map(e=>({...e,status:r?"warning":"valid"})),p("validation-success",s.data)}catch(t){console.error("Validation error:",t),N.value=N.value.map(e=>({...e,status:"error"}))}},se=async()=>{var e,a;f.value=!0;try{const e=await L.post(v.importUrl,{data:N.value.map(e=>e.data),columns:v.columns,...v.additionalPayload});p("imported",e.data),$.value=e.data.results||{success:[],errors:[]},ee.value=e.data.importId,Z.value=!!v.undoUrl,x.value=!1,b.value=!0,g.value=null}catch(l){console.error("Import error:",l),$.value={success:[],errors:[(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"An error occurred during import"]},b.value=!0}finally{f.value=!1}},re=async()=>{if(ee.value&&v.undoUrl){h.value=!0;try{await L.post(`${v.undoUrl}/${ee.value}`),Z.value=!1,p("imported"),ue()}catch(e){alert("Failed to undo the import")}finally{h.value=!1}}},oe=e=>{switch(e){case"new":case"warning":return"warning";case"update":return"info";case"valid":return"positive";case"error":return"negative";default:return"grey"}},ue=()=>{b.value=!1,$.value={success:[],errors:[]},ee.value=null,Z.value=!1};return(m,v)=>(U(),I("div",null,[V("div",Y,[C(_,{modelValue:g.value,"onUpdate:modelValue":[v[0]||(v[0]=e=>g.value=e),le],class:"col-grow",outlined:"",dense:"",label:e.buttonText,accept:".xlsx, .xls",loading:y.value},{prepend:E(()=>[C(a,{name:"attach_file"})]),_:1},8,["modelValue","label","loading"])]),C(u,{modelValue:x.value,"onUpdate:modelValue":v[1]||(v[1]=e=>x.value=e),"full-width":""},{default:E(()=>[C(l,{class:"column full-height",style:{"max-height":"90vh"}},{default:E(()=>[C(t,null,{default:E(()=>[V("div",G,Q(e.previewTitle),1),V("div",J,"Total Records: "+Q(N.value.length),1)]),_:1}),C(t,{class:"col q-pa-none"},{default:E(()=>[C(q,{flat:"",bordered:"",rows:N.value,columns:ae.value,"row-key":"index","virtual-scroll":"","rows-per-page-options":[0],class:"sticky-header-table",style:{height:"100%"}},{"body-cell-status":E(e=>[C(k,{props:e},{default:E(()=>[C(w,{color:oe(e.value)},{default:E(()=>[R(Q(e.value),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1}),C(s,{align:"right",class:"bg-white text-primary"},{default:E(()=>[B(C(o,{flat:"",label:e.cancelButtonText},null,8,["label"]),[[r]]),C(o,{flat:"",label:f.value?e.processingText:e.confirmButtonText,color:"primary",onClick:se,loading:f.value,disable:f.value||!N.value.length},null,8,["label","loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),C(u,{modelValue:b.value,"onUpdate:modelValue":v[2]||(v[2]=e=>b.value=e)},{default:E(()=>[C(l,{style:{"min-width":"350px"}},{default:E(()=>[C(t,null,{default:E(()=>[V("div",K,Q(e.resultsTitle),1)]),_:1}),C(t,{class:"q-pt-none"},{default:E(()=>[$.value.success.length?(U(),I("div",z,[V("div",M,"Success ("+Q($.value.success.length)+")",1),C(i,{dense:""},{default:E(()=>[(U(!0),I(F,null,A($.value.success,(e,a)=>(U(),D(c,{key:a},{default:E(()=>[C(d,null,{default:E(()=>[C(n,{caption:""},{default:E(()=>[R(Q(e),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):P("",!0),$.value.errors.length?(U(),I("div",X,[V("div",H,"Errors ("+Q($.value.errors.length)+")",1),C(i,{dense:""},{default:E(()=>[(U(!0),I(F,null,A($.value.errors,(e,a)=>(U(),D(c,{key:a},{default:E(()=>[C(d,null,{default:E(()=>[C(n,{caption:"",class:"text-negative"},{default:E(()=>[R(Q(e),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):P("",!0)]),_:1}),C(s,{align:"right"},{default:E(()=>[Z.value?(U(),D(o,{key:0,flat:"",label:h.value?e.undoingText:e.undoButtonText,color:"secondary",onClick:re,loading:h.value,disable:h.value},null,8,["label","loading","disable"])):P("",!0),C(o,{flat:"",label:e.closeButtonText,color:"primary",onClick:ue},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},[["__scopeId","data-v-e5bd2e4c"]]),ee={class:"q-pa-md"},ae={class:"row justify-center"},le={class:"col-12 col-md-10 col-lg-8"},te={class:"row q-col-gutter-md"},se={class:"col-12 col-md-6"},re={class:"col-12 col-md-6"},oe={class:"q-gutter-sm"},ue={class:"text-caption text-grey q-mt-xs q-ml-sm"},ie={class:"row items-center q-gutter-md"},de={class:"text-weight-bold"},ne={class:"row q-col-gutter-md"},ce={class:"col-6 col-sm-3"},me={class:"text-body1"},ve={class:"col-6 col-sm-3"},pe={class:"text-body1"},ge={class:"col-6 col-sm-3"},ye={class:"text-body1 text-positive"},fe={class:"col-6 col-sm-3"},he={class:"text-body1 text-info"},xe={key:0,class:"q-mt-md"},be={class:"text-subtitle2 text-negative q-mb-sm"},_e={class:"row justify-end q-gutter-sm"},we="Teacher Excel Import",ke={__name:"TeacherImport",props:{schools:{type:Array,required:!0}},setup(e){const s=e,r=S(""),u=S(null),_=S(!1),w=S(""),k=S("update_existing"),q=S(!1),B=S(null),O=S(null),W=T(()=>r.value&&u.value&&!w.value),Y=T(()=>_.value?"Loading...":u.value?`${u.value.name} (${u.value.start_date} - ${u.value.end_date})`:r.value&&!u.value?"No active academic year found":"Select a school first"),G=T(()=>W.value?"/admin/teachers/import/validate":""),J=T(()=>W.value?"/admin/teachers/import/process":""),K=[{key:"classroom",label:"Classroom",required:!0},{key:"subject",label:"Subject",required:!0},{key:"teacher_name",label:"Teacher",required:!0},{key:"periods_per_week",label:"Periods_per_Week",required:!0},{key:"teacher_email",label:"Teacher Email",required:!1},{key:"phone",label:"Phone",required:!1},{key:"national_id",label:"National ID",required:!1},{key:"gender",label:"Gender",required:!1},{key:"date_of_birth",label:"Date of Birth",required:!1}],z=async()=>{var e,a;if(!r.value)return u.value=null,void(w.value="");_.value=!0,w.value="";try{const e=await L.get(`/admin/teachers/import/academic-year/${r.value}`);e.data.success?u.value=e.data.academic_year:(u.value=null,w.value=e.data.message)}catch(l){u.value=null,w.value=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"Failed to load academic year"}finally{_.value=!1}},M=e=>{O.value=e},X=e=>{B.value=e},H=()=>{B.value=null,O.value=null},ke=()=>{var e;if(!(null==(e=B.value)?void 0:e.report))return;const a=JSON.stringify(B.value.report,null,2),l=new Blob([a],{type:"application/json"}),t=URL.createObjectURL(l),s=document.createElement("a");s.href=t,s.download=`teacher-import-report-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t)};return j(r,()=>{H()}),j(u,()=>{H()}),N(()=>{s.schools&&s.schools.length>0&&(r.value=s.schools[0].id,z())}),(s,S)=>(U(),D(b,{title:we},{header:E(()=>[V("div",{class:"bg-white shadow"},[V("div",{class:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8"},[V("h1",{class:"text-3xl font-bold text-gray-900"},Q(we))])])]),default:E(()=>[V("div",ee,[V("div",ae,[V("div",le,[C(l,null,{default:E(()=>[C(t,null,{default:E(()=>S[3]||(S[3]=[V("div",{class:"text-h6"},"School and Academic Year Selection",-1)])),_:1}),C(t,null,{default:E(()=>[V("div",te,[V("div",se,[C(x,{modelValue:r.value,"onUpdate:modelValue":[S[0]||(S[0]=e=>r.value=e),z],options:e.schools,"option-value":"id","option-label":"name",label:"Select School *",outlined:"","emit-value":"","map-options":"",disable:_.value},null,8,["modelValue","options","disable"])]),V("div",re,[C(m,{"model-value":Y.value,label:"Active Academic Year",outlined:"",readonly:"",loading:_.value},{append:E(()=>[u.value?(U(),D(a,{key:0,name:"check_circle",color:"positive"})):r.value&&!_.value?(U(),D(a,{key:1,name:"warning",color:"negative"})):P("",!0)]),_:1},8,["model-value","loading"])])]),w.value?(U(),D(v,{key:0,class:"bg-red-1 text-negative q-mt-md rounded-borders"},{avatar:E(()=>[C(a,{name:"error",color:"negative"})]),default:E(()=>[S[4]||(S[4]=V("div",{class:"text-weight-bold"},"Academic Year Required",-1)),R(" "+Q(w.value),1)]),_:1})):P("",!0)]),_:1}),W.value?(U(),D(p,{key:0})):P("",!0),W.value?(U(),D(t,{key:1},{default:E(()=>[S[7]||(S[7]=V("div",{class:"text-h6 q-mb-md"},"Import Configuration",-1)),V("div",oe,[C(g,{modelValue:k.value,"onUpdate:modelValue":S[1]||(S[1]=e=>k.value=e),val:"update_existing",label:"Update Existing",color:"primary"},{default:E(()=>[C(y,null,{default:E(()=>S[5]||(S[5]=[R("Update existing assignments and add new ones without removing others")])),_:1})]),_:1},8,["modelValue"]),C(g,{modelValue:k.value,"onUpdate:modelValue":S[2]||(S[2]=e=>k.value=e),val:"full_sync",label:"Full Sync",color:"primary"},{default:E(()=>[C(y,null,{default:E(()=>S[6]||(S[6]=[R("Replace all assignments for this school and academic year")])),_:1})]),_:1},8,["modelValue"])]),V("div",ue,Q("update_existing"===k.value?"Update existing assignments and add new ones without removing other assignments":"Replace all assignments for this school and academic year with the imported data"),1)]),_:1})):P("",!0),W.value?(U(),D(p,{key:2})):P("",!0),W.value?(U(),D(t,{key:3},{default:E(()=>{var e;return[S[12]||(S[12]=V("div",{class:"text-h6 q-mb-md"},"Excel File Import",-1)),C(v,{class:"bg-blue-1 text-primary q-mb-md rounded-borders"},{avatar:E(()=>[C(a,{name:"info",color:"primary"})]),default:E(()=>[S[8]||(S[8]=V("div",{class:"text-weight-medium"},"Required Excel Columns",-1)),S[9]||(S[9]=V("div",{class:"row q-gutter-x-md text-caption"},[V("div",null,"• Classroom"),V("div",null,"• Subject"),V("div",null,"• Teacher Name"),V("div",null,"• Periods_per_Week")],-1)),S[10]||(S[10]=V("div",{class:"text-weight-medium q-mt-sm"},"Optional Columns",-1)),S[11]||(S[11]=V("div",{class:"row q-gutter-x-md text-caption"},[V("div",null,"• Teacher Email"),V("div",null,"• Phone"),V("div",null,"• National ID"),V("div",null,"• Gender"),V("div",null,"• Date of Birth")],-1))]),_:1}),C(Z,{"validate-url":G.value,"import-url":J.value,columns:K,"button-text":"Choose Teacher Excel File","preview-title":"Preview Teacher Import Data","confirm-button-text":"Import Teachers","additional-payload":{school_id:r.value,academic_year_id:null==(e=u.value)?void 0:e.id,sync_mode:k.value},onValidationSuccess:M,onImported:X},null,8,["validate-url","import-url","additional-payload"])]}),_:1})):P("",!0),q.value?(U(),D(t,{key:4},{default:E(()=>[V("div",ie,[C(f,{color:"primary",size:"2em"}),S[13]||(S[13]=V("div",null,[V("div",{class:"text-weight-bold text-primary"},"Import in Progress"),V("div",{class:"text-caption"},"Processing your teacher data...")],-1))])]),_:1})):P("",!0),B.value?(U(),D(t,{key:5},{default:E(()=>[S[19]||(S[19]=V("div",{class:"text-h6 q-mb-md"},"Import Results",-1)),C(v,{class:$([B.value.success?"bg-green-1 text-positive":"bg-red-1 text-negative","rounded-borders q-mb-md"])},{avatar:E(()=>[C(a,{name:B.value.success?"check_circle":"error",color:B.value.success?"positive":"negative"},null,8,["name","color"])]),default:E(()=>[V("div",de,Q(B.value.success?"Import Completed Successfully":"Import Failed"),1),R(" "+Q(B.value.message),1)]),_:1},8,["class"]),B.value.report?(U(),D(l,{key:0,bordered:"",flat:"",class:"q-mb-md"},{default:E(()=>[C(t,{class:"bg-grey-1 q-py-sm"},{default:E(()=>S[14]||(S[14]=[V("div",{class:"text-subtitle2"},"Import Summary",-1)])),_:1}),C(t,null,{default:E(()=>{var e,a,l,t,s;return[V("div",ne,[V("div",ce,[S[15]||(S[15]=V("div",{class:"text-caption text-grey"},"Total Rows",-1)),V("div",me,Q((null==(e=B.value.report.summary)?void 0:e.total_rows)||0),1)]),V("div",ve,[S[16]||(S[16]=V("div",{class:"text-caption text-grey"},"Processed",-1)),V("div",pe,Q((null==(a=B.value.report.summary)?void 0:a.processed_rows)||0),1)]),V("div",ge,[S[17]||(S[17]=V("div",{class:"text-caption text-grey"},"Teachers Created",-1)),V("div",ye,Q((null==(l=B.value.report.summary)?void 0:l.teachers_created)||0),1)]),V("div",fe,[S[18]||(S[18]=V("div",{class:"text-caption text-grey"},"Assignments",-1)),V("div",he,Q(((null==(t=B.value.report.summary)?void 0:t.assignments_created)||0)+((null==(s=B.value.report.summary)?void 0:s.assignments_updated)||0)),1)])]),B.value.report.errors&&B.value.report.errors.length>0?(U(),I("div",xe,[V("div",be,"Errors ("+Q(B.value.report.errors.length)+")",1),C(h,{style:{height:"150px",border:"1px solid #ddd","border-radius":"4px"}},{default:E(()=>[C(i,{dense:""},{default:E(()=>[(U(!0),I(F,null,A(B.value.report.errors,(e,a)=>(U(),D(c,{key:a},{default:E(()=>[C(d,null,{default:E(()=>[C(n,{class:"text-negative text-caption"},{default:E(()=>[R(" Row "+Q(e.row)+": "+Q(e.message),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])):P("",!0)]}),_:1})]),_:1})):P("",!0),V("div",_e,[C(o,{outline:"",color:"primary",label:"Import Another File",onClick:H}),B.value.report?(U(),D(o,{key:0,color:"primary",label:"Download Report",onClick:ke,icon:"download"})):P("",!0)])]),_:1})):P("",!0)]),_:1})])])])]),_:1}))}};export{ke as default};
