import{Q as e}from"./QSelect-DB_tK-Lk.js";import{u as a,c as l,a as s,Q as o,d as t,p as r,l as i,m as n}from"./app-B77gjd5a.js";import{Q as c}from"./QTab-CnAf4tCv.js";import{Q as u}from"./QTabs-D_ZwIIJm.js";import{Q as d,a as m}from"./QTable-Dzgz30xz.js";import{Q as p}from"./QTd-Cd1TbwhN.js";import{Q as v}from"./QTr-DYQ1GmNz.js";import{Q as f}from"./QTabPanel-B_PJ80R0.js";import{Q as b}from"./QEditor-AZiEF3FQ.js";import{Q as g}from"./QTabPanels-B5JhG1n5.js";import{i as y,d as h}from"./exportHelper-DgqGG-tE.js";import{O as j,f as k,o as _,a as w,M as Q,J as I,b as V,K as x,I as C,Q as T,N as S,W as q,V as O,U as P,_ as D}from"./vendor-DuKqz2x4.js";import"./rtl-Cr6c3OOr.js";import"./offline-BzIlwqNM.js";import"./i18n-DE5KxGn8.js";import"./ui-BITzTqrO.js";import"./QMarkupTable-xKG6mM4A.js";import"./QLinearProgress-B9hMkhRG.js";import"./use-fullscreen-Cf3Zl1YN.js";import"./use-panel-N2fkKyR_.js";import"./use-render-cache-CmTcazfP.js";import"./xlsx-cMC2LkxH.js";const U=["disabled"],J={__name:"ClassroomSubjectTeacherImport",setup(J){const $=j(),E=a(),M=k(null),N=k("preview"),W=k(""),z=k([]),A=k(!1),H=k(!1),K=k(null),R=k([]),L=k(!1);_(()=>{R.value=$.props.auth.user.school||[];const e=localStorage.getItem("selectedSchoolId");e&&(K.value=parseInt(e))});const B=e=>{localStorage.setItem("selectedSchoolId",e)},F=[{key:"status",label:"status",required:!1},{key:"classroom",label:"Classroom",required:!0},{key:"subject",label:"Subject",required:!0},{key:"teacher",label:"Teacher",required:!0},{key:"classes_per_week",label:"Classes/Week",required:!0,type:"number"}],G=[...F.map(e=>({name:e.key,label:e.label,field:a=>a.data[e.key],align:"left",sortable:!0}))],X=w(()=>z.value.some(e=>Object.keys(e.errors||{}).length>0)),Y=w(()=>`${z.value.filter(e=>Object.keys(e.errors||{}).length).length} of ${z.value.length} rows contain errors`),Z=async e=>{try{A.value=!0;const a=e.target.files[0],l=await y(a),s=Array.isArray(l)?l:l.data?l.data:Object.values(l);z.value=s.map(e=>({data:e,errors:{}})),W.value=JSON.stringify(s,null,2),E.notify({message:`${s.length} records loaded`,color:"positive",icon:"check_circle"})}catch(a){E.notify({message:"Error importing file",color:"negative",icon:"error"}),console.error("Import error:",a)}finally{A.value=!1,e.target.value=""}},ee=()=>{h(F,"classroom-subject-teacher-template"),E.notify({message:"Template downloaded",color:"positive"})},ae=()=>{z.value=[],W.value=""},le=async()=>{var e,a;H.value=!0;try{const e=z.value.map(e=>{var a,l,s;return{classroom:e.data.classroom||(null==(a=e.original_data)?void 0:a.classroom),subject:e.data.subject||(null==(l=e.original_data)?void 0:l.subject),teacher:e.data.teacher||(null==(s=e.original_data)?void 0:s.teacher),classes_per_week:e.data.classes_per_week}}),a=await D.post("/admin/classroom-subject-teachers/validate",{school_id:K.value,data:e});a.data.success&&(z.value=a.data.validatedData.map((e,a)=>({...z.value[a],...e.data,errors:e.errors})),L.value=!0,E.notify({type:a.data.hasErrors?"warning":"positive",message:a.data.message||"Validation complete"}))}catch(l){console.error("Validation error:",l),E.notify({type:"negative",message:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"Validation failed!"})}finally{H.value=!1}},se=()=>{L.value?(H.value=!0,D.post("/admin/classroom-subject-teachers/import",{data:z.value.filter(e=>!Object.keys(e.errors||{}).length).map(e=>e.data),school_id:K.value}).then(e=>{E.notify({type:"positive",message:e.data.message||"Import successful!"})}).catch(e=>{var a,l;console.error("Import error:",e),E.notify({type:"negative",message:(null==(l=null==(a=e.response)?void 0:a.data)?void 0:l.message)||"Import failed!"})}).finally(()=>{H.value=!1})):E.notify({type:"warning",message:"Please validate data first"})};return(a,y)=>(I(),Q("div",null,[V(e,{modelValue:K.value,"onUpdate:modelValue":[y[0]||(y[0]=e=>K.value=e),B],options:R.value,label:"Select School","option-value":"id","option-label":"name","emit-value":"","map-options":"",class:"q-mb-md"},null,8,["modelValue","options"]),V(n,{class:"my-card"},{default:x(()=>[V(l,null,{default:x(()=>y[5]||(y[5]=[S("div",{class:"text-h6"},"Import Classroom-Subject-Teacher",-1)])),_:1}),V(s),V(l,null,{default:x(()=>[S("input",{type:"file",ref_key:"fileInput",ref:M,class:"hidden",accept:".xlsx,.xls",onChange:Z,disabled:!K.value},null,40,U),V(o,{onClick:y[1]||(y[1]=e=>a.$refs.fileInput.click()),loading:A.value,label:"Import Classroom Data",icon:"upload",color:"primary",class:"q-mb-md"},null,8,["loading"]),V(o,{flat:"",color:"primary",label:"Download Template",onClick:ee,class:"q-ml-sm"}),z.value.length?(I(),C(u,{key:0,modelValue:N.value,"onUpdate:modelValue":y[2]||(y[2]=e=>N.value=e),class:"text-teal q-mt-md"},{default:x(()=>[V(c,{name:"preview",icon:"visibility",label:"Data Preview"}),V(c,{name:"raw",icon:"code",label:"Raw Data"})]),_:1},8,["modelValue"])):T("",!0),V(g,{modelValue:N.value,"onUpdate:modelValue":y[4]||(y[4]=e=>N.value=e),animated:""},{default:x(()=>[V(f,{name:"preview"},{default:x(()=>[V(d,{flat:"",bordered:"",rows:z.value,columns:G,"row-key":"id",pagination:{rowsPerPage:10},loading:H.value},{"header-cell-status":x(e=>[V(m,{"auto-width":"",class:"text-center"},{default:x(()=>y[6]||(y[6]=[q("Status")])),_:1})]),"body-cell-status":x(e=>[V(p,{"auto-width":"",class:"text-center"},{default:x(()=>[Object.keys(e.row.errors||{}).length?(I(),C(t,{key:1,name:"error",color:"negative",size:"sm"})):(I(),C(t,{key:0,name:"check_circle",color:"positive",size:"sm"}))]),_:2},1024)]),"body-cell":x(e=>{var a;return[V(p,{props:e,class:P({"text-negative":null==(a=e.row.errors)?void 0:a[e.col.name]})},{default:x(()=>{var a;return[q(O(e.row.data[e.col.name])+" ",1),(null==(a=e.row.errors)?void 0:a[e.col.name])?(I(),C(r,{key:0,anchor:"top middle",self:"bottom middle"},{default:x(()=>[q(O(e.row.errors[e.col.name]),1)]),_:2},1024)):T("",!0)]}),_:2},1032,["props","class"])]}),"bottom-row":x(()=>[X.value?(I(),C(v,{key:0},{default:x(()=>[V(p,{colspan:"100%",class:"bg-red-1 text-negative text-center"},{default:x(()=>[V(t,{name:"warning",class:"q-mr-xs"}),q(" "+O(Y.value),1)]),_:1})]),_:1})):T("",!0)]),_:1},8,["rows","loading"])]),_:1}),V(f,{name:"raw"},{default:x(()=>[V(b,{modelValue:W.value,"onUpdate:modelValue":y[3]||(y[3]=e=>W.value=e),readonly:"","min-height":"300px"},null,8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1}),z.value.length?(I(),C(i,{key:0,align:"right"},{default:x(()=>[V(o,{flat:"",label:"Cancel",color:"negative",onClick:ae}),V(o,{label:"Validate Data",color:"warning",onClick:le,disable:!K.value,class:"q-mr-sm"},null,8,["disable"]),V(o,{label:"Confirm Import",color:"positive",onClick:se,disable:X.value||!K.value||!L.value},null,8,["disable"])]),_:1})):T("",!0)]),_:1})]))}};export{J as default};
