import{D as t}from"./import-wrapper-prod-Ck0rhyRE.js";import"./vendor-BWKGNkNB.js";const e={lessons:"id, title, content, course_id, teacher_id, updated_at, synced_at, is_dirty",students:"id, name, email, class_id, grade_id, updated_at, synced_at, is_dirty",courses:"id, name, description, teacher_id, grade_id, updated_at, synced_at, is_dirty",teachers:"id, name, email, subject_id, updated_at, synced_at, is_dirty",quiz_answers:"id, quiz_id, student_id, answers, score, submitted_at, updated_at, synced_at, is_dirty",assignments:"id, title, description, course_id, due_date, updated_at, synced_at, is_dirty",grades:"id, student_id, assignment_id, score, graded_at, updated_at, synced_at, is_dirty",attendance:"id, student_id, date, status, recorded_at, updated_at, synced_at, is_dirty",schedules:"id, class_id, subject_id, teacher_id, day_of_week, start_time, end_time, updated_at, synced_at, is_dirty",messages:"id, sender_id, recipient_id, content, sent_at, read_at, updated_at, synced_at, is_dirty",announcements:"id, title, content, author_id, published_at, updated_at, synced_at, is_dirty",user_context_profile:"user_id, id, name, email, user_role, cached_at, expires_at, updated_at, synced_at, is_dirty",user_context_permissions:"user_id, roles, cached_at, expires_at, updated_at, synced_at, is_dirty",user_context_school:"user_id, school, schools, cached_at, expires_at, updated_at, synced_at, is_dirty",user_context_classroom:"user_id, teacher, classroom, cached_at, expires_at, updated_at, synced_at, is_dirty",user_context_schedule:"user_id, schedule, cached_at, expires_at, updated_at, synced_at, is_dirty",sync_queue:"id, method, url, payload, timestamp, retry_count, status, priority, resource_type",offline_metadata:"key, value, updated_at"};class s extends t{constructor(){super("EducationManagementDB"),this.version(2).stores(e),this.setupHooks()}setupHooks(){Object.keys(e).forEach(t=>{"sync_queue"!==t&&"offline_metadata"!==t&&(this[t].hook("creating",(e,s,r)=>{const a=(new Date).toISOString();s.updated_at=a,s.synced_at=null,s.is_dirty=!0,t.startsWith("user_context_")&&(s.cached_at=a,s.expires_at=new Date(Date.now()+6048e5).toISOString())}),this[t].hook("updating",(e,s,r,a)=>{e.updated_at=(new Date).toISOString(),e.is_dirty=!0,t.startsWith("user_context_")&&(e.cached_at=(new Date).toISOString(),e.expires_at=new Date(Date.now()+6048e5).toISOString())}))})}getDirtyRecords(t){if(!this[t])throw new Error(`Resource '${t}' not found in database schema`);return this[t].where("is_dirty").equals(!0).toArray()}markAsSynced(t,e){if(!this[t])throw new Error(`Resource '${t}' not found in database schema`);const s=(new Date).toISOString();return this[t].where("id").anyOf(e).modify({is_dirty:!1,synced_at:s})}getSyncStats(t){if(!this[t])throw new Error(`Resource '${t}' not found in database schema`);return Promise.all([this[t].count(),this[t].where("is_dirty").equals(!0).count(),this[t].where("is_dirty").equals(!1).count()]).then(([t,e,s])=>({total:t,dirty:e,synced:s,syncPercentage:t>0?Math.round(s/t*100):100}))}clearResource(t){if(!this[t])throw new Error(`Resource '${t}' not found in database schema`);return this[t].clear()}async getDatabaseInfo(){const t={name:this.name,version:this.verno,tables:{},totalRecords:0};for(const s of Object.keys(e)){const e=await this[s].count();t.tables[s]=e,t.totalRecords+=e}return t}async exportData(t=null){const s=t||Object.keys(e),r={timestamp:(new Date).toISOString(),version:this.verno,data:{}};for(const e of s)this[e]&&(r.data[e]=await this[e].toArray());return r}async importData(t,s=!1){const r={imported:{},errors:[]};try{await this.transaction("rw",Object.keys(e),async()=>{for(const[a,o]of Object.entries(t.data))if(this[a])try{s&&await this[a].clear();const t=await this[a].bulkAdd(o);r.imported[a]=t}catch(e){r.errors.push(`Error importing ${a}: ${e.message}`)}else r.errors.push(`Resource '${a}' not found`)})}catch(a){r.errors.push(`Transaction failed: ${a.message}`)}return r}async storeUserContext(t,e,s){const r=`user_context_${e}`;if(!this[r])throw new Error(`User context segment '${e}' not found`);const a=(new Date).toISOString(),o={user_id:t,...s,cached_at:a,expires_at:new Date(Date.now()+6048e5).toISOString(),updated_at:a,synced_at:a,is_dirty:!1};return this[r].put(o)}async getUserContext(t,e){const s=`user_context_${e}`;if(!this[s])throw new Error(`User context segment '${e}' not found`);const r=await this[s].where("user_id").equals(t).first();if(!r)return null;return new Date>new Date(r.expires_at)?(await this[s].where("user_id").equals(t).delete(),null):r}async isUserContextCached(t,e){return null!==await this.getUserContext(t,e)}async clearExpiredUserContext(){const t=(new Date).toISOString();let e=0;const s=["user_context_profile","user_context_permissions","user_context_school","user_context_classroom","user_context_schedule"];for(const r of s){e+=await this[r].where("expires_at").below(t).delete()}return e}async clearUserContextCache(t){let e=0;const s=["user_context_profile","user_context_permissions","user_context_school","user_context_classroom","user_context_schedule"];for(const r of s){e+=await this[r].where("user_id").equals(t).delete()}return e}async getUserContextStats(t=null){const e={total:0,expired:0,valid:0,segments:{}},s=(new Date).toISOString(),r=["user_context_profile","user_context_permissions","user_context_school","user_context_classroom","user_context_schedule"];for(const a of r){const r=a.replace("user_context_","");let o=this[a];t&&(o=o.where("user_id").equals(t));const n=await o.count(),i=await o.where("expires_at").below(s).count(),d=n-i;e.segments[r]={total:n,expired:i,valid:d},e.total+=n,e.expired+=i,e.valid+=d}return e}}const r=new s,a={resourceExists:t=>t in e,getResourceNames:()=>Object.keys(e).filter(t=>"sync_queue"!==t&&"offline_metadata"!==t&&!t.startsWith("user_context_")),getUserContextTableNames:()=>Object.keys(e).filter(t=>t.startsWith("user_context_")),validateResourceData(t,e){const s={valid:!0,errors:[]};return this.resourceExists(t)?(e&&"object"==typeof e||(s.valid=!1,s.errors.push("Data must be an object")),s):(s.valid=!1,s.errors.push(`Resource '${t}' does not exist`),s)}};r.open().catch(t=>{console.error("Failed to open database:",t)});export{s as EducationDB,r as db,a as dbUtils,r as default,e as resourceSchemas};
