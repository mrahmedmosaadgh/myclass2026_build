import{o as e,u as a,c as l,d as t,Q as s,a as o,m as i,f as r,e as n,C as d,l as u,b as c,aP as m}from"./app-C-WHvmzS.js";import{Q as p}from"./QSpace-B9GNNHOj.js";import{Q as v,a as y}from"./QStepper-GqrNm9Rm.js";import{Q as b}from"./QBadge-DrVfQiJT.js";import{Q as f}from"./QTd-C1DSVNtI.js";import{Q as g}from"./QTable-DtWqhKe5.js";import{f as h,a as w,k as _,I as k,J as x,K as j,b as q,O as S,y as I,V as N,Q as O,N as C,R as T,F as V,W as Q,U as P,_ as U}from"./vendor-nQjeLEvd.js";import"./offline-BzIlwqNM.js";import"./i18n-kquWfmcz.js";import"./ui-Bfjdq-TR.js";import"./use-panel-C3xzl7zI.js";import"./use-render-cache-CmTcazfP.js";import"./QMarkupTable-KFdSGsJ_.js";import"./QSelect-mar89Igw.js";import"./rtl-Cr6c3OOr.js";import"./QLinearProgress-DUxPHj8Z.js";import"./use-fullscreen-CmIMndfj.js";const A={class:"prompt-text"},J={class:"q-mt-md"},M={class:"q-my-none q-pl-md"},R={key:0,class:"text-caption q-mt-xs"},D={class:"text-caption"},B={class:"q-mt-md"},F={key:0,class:"q-mb-md"},L={class:"row q-gutter-sm q-mb-md"},$={class:"q-mt-md"},E={class:"q-mt-md"},W={class:"text-weight-bold"},z={key:0,class:"text-caption q-mt-xs"},G={key:0},Y={key:1},K={key:2},H={key:1,class:"q-mt-sm"},X={class:"q-my-xs q-pl-md"},Z=e({__name:"AIImportDialog",props:{modelValue:Boolean,classroomId:Number,classroomName:String,subjects:Array},emits:["update:modelValue","applied"],setup(e,{emit:Z}){const ee=e,ae=Z,le=a(),te=h(1),se=h(""),oe=h(null),ie=h([]),re=h(null),ne=h(null),de=h("update"),ue=h(!1),ce=h(null),me=w(()=>{const e=ee.subjects.map(e=>e.name).sort().join(", ");return`Provide JSON only matching the schema below. No prose. Map subjects to periods for the given classroom and week.\n\nClassroom: ${ee.classroomName||"Unknown"} (ID: ${ee.classroomId||"<classroom_id>"})\n\nIMPORTANT: You MUST use ONLY the following subject names exactly as written (case-sensitive). If the schedule has a subject name that is slightly different (e.g. spelling or case), you MUST correct it to match one of these valid names. DO NOT invent new subject names.\n\nValid Subjects:\n${e}\n\nAssign sequential periods starting at 1 (Max 8 periods per day). Output:\n\n{\n  "entries": [\n    { "day": "Sunday", "period": 1, "subject": "Math" },\n    { "day": "Sunday", "period": 2, "subject": "Arabic" }\n  ]\n}`}),pe=[{name:"day",label:"Day",field:"day",align:"left"},{name:"period",label:"Period",field:"period",align:"center"},{name:"subject",label:"Subject",field:"subject",align:"left"},{name:"teacher",label:"Teacher",field:"teacher",align:"left"},{name:"notes",label:"Notes",field:"notes",align:"left"}],ve=async()=>{try{await navigator.clipboard.writeText(me.value),le.notify({type:"positive",message:"Prompt copied to clipboard!",position:"top"})}catch(e){le.notify({type:"negative",message:"Failed to copy prompt",position:"top"})}},ye=async()=>{var e,a;if(!se.value.trim())return oe.value=null,ie.value=[],void(ne.value=null);try{let e=se.value.trim();const a=e.indexOf("{"),l=e.lastIndexOf("}");-1!==a&&-1!==l&&l>a&&(e=e.substring(a,l+1));const t=JSON.parse(e);t.classroom_id||(t.classroom_id=ee.classroomId),ne.value=t;const s=await U.post("/weekly-system/api/ai-import/validate",{data:t});s.data.success?(oe.value="valid",ie.value=[],re.value=s.data.summary):(oe.value="invalid",ie.value=s.data.errors||[])}catch(l){oe.value="invalid",(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.errors)?ie.value=l.response.data.errors:l instanceof SyntaxError?ie.value=["Invalid JSON format: "+l.message]:ie.value=["Validation failed: "+l.message],ne.value=null}},be=()=>{const e=new Blob([se.value],{type:"application/json"}),a=URL.createObjectURL(e),l=document.createElement("a");l.href=a,l.download=`rejected-timetable-${Date.now()}.json`,l.click(),URL.revokeObjectURL(a),le.notify({type:"info",message:"JSON downloaded for corrections",position:"top"})},fe=async()=>{var e,a,l,t,s,o;ue.value=!0,ce.value=null;try{const e=await U.post("/weekly-system/api/ai-import/update",{data:ne.value});ce.value=e.data,e.data.success&&(le.notify({type:"positive",message:e.data.message,position:"top"}),ae("applied"))}catch(i){ce.value={success:!1,message:(null==(a=null==(e=i.response)?void 0:e.data)?void 0:a.message)||"Failed to apply import",errors:null==(t=null==(l=i.response)?void 0:l.data)?void 0:t.errors},le.notify({type:"negative",message:(null==(o=null==(s=i.response)?void 0:s.data)?void 0:o.message)||"Failed to apply import",position:"top"})}finally{ue.value=!1}};return _(()=>ee.modelValue,e=>{e&&(te.value=1,se.value="",oe.value=null,ie.value=[],ne.value=null,ce.value=null,de.value="update")}),(a,h)=>(x(),k(c,{"model-value":e.modelValue,"onUpdate:modelValue":h[8]||(h[8]=e=>a.$emit("update:modelValue",e)),position:"right",maximized:""},{default:j(()=>[q(i,{style:{width:"900px","max-width":"90vw"},class:"column"},{default:j(()=>[q(l,{class:"row items-center q-pb-none bg-primary text-white"},{default:j(()=>[q(t,{name:"psychology",size:"sm",class:"q-mr-sm"}),h[9]||(h[9]=S("div",{class:"text-h6"},"AI Timetable Import",-1)),q(p),I(q(s,{icon:"close",flat:"",round:"",dense:""},null,512),[[m]])]),_:1}),q(o),q(l,{class:"col scroll"},{default:j(()=>[q(v,{modelValue:te.value,"onUpdate:modelValue":h[7]||(h[7]=e=>te.value=e),vertical:"",color:"primary",animated:""},{default:j(()=>[q(y,{name:1,title:"Generate AI Prompt",icon:"description",done:te.value>1},{default:j(()=>[h[10]||(h[10]=S("div",{class:"text-body2 q-mb-md"}," Copy the prompt below and paste it into your AI assistant (ChatGPT, Claude, etc.) to generate the timetable JSON. ",-1)),q(i,{flat:"",bordered:""},{default:j(()=>[q(l,null,{default:j(()=>[S("pre",A,N(me.value),1)]),_:1})]),_:1}),S("div",J,[q(s,{color:"primary",icon:"content_copy",label:"Copy Prompt",onClick:ve,class:"q-mr-sm"}),q(s,{flat:"",color:"primary",label:"Next",onClick:h[0]||(h[0]=e=>te.value=2)})])]),_:1},8,["done"]),q(y,{name:2,title:"Paste JSON",icon:"input",done:te.value>2},{default:j(()=>[h[13]||(h[13]=S("div",{class:"text-body2 q-mb-md"}," Paste the AI-generated JSON here. It will be automatically validated. ",-1)),q(r,{modelValue:se.value,"onUpdate:modelValue":[h[1]||(h[1]=e=>se.value=e),ye],type:"textarea",outlined:"",placeholder:'{"classroom_id": 123, ...}',rows:12,class:"q-mb-md"},{append:j(()=>["valid"===oe.value?(x(),k(t,{key:0,name:"check_circle",color:"positive"})):O("",!0),"invalid"===oe.value?(x(),k(t,{key:1,name:"error",color:"negative"})):O("",!0)]),_:1},8,["modelValue"]),ie.value.length>0?(x(),k(n,{key:0,class:"bg-negative text-white q-mb-md"},{avatar:j(()=>[q(t,{name:"warning",color:"white"})]),action:j(()=>[q(s,{flat:"",color:"white",icon:"download",label:"Download JSON",onClick:be,dense:""})]),default:j(()=>[h[11]||(h[11]=S("div",{class:"text-weight-bold q-mb-xs"},"Validation Errors:",-1)),S("ul",M,[(x(!0),C(V,null,T(ie.value.slice(0,5),(e,a)=>(x(),C("li",{key:a},N(e),1))),128))]),ie.value.length>5?(x(),C("div",R," ... and "+N(ie.value.length-5)+" more errors ",1)):O("",!0)]),_:1})):O("",!0),"valid"===oe.value?(x(),k(n,{key:1,class:"bg-positive text-white q-mb-md"},{avatar:j(()=>[q(t,{name:"check_circle",color:"white"})]),default:j(()=>{var e;return[S("div",null,[h[12]||(h[12]=S("strong",null,"Validation passed!",-1)),S("div",D,N(null==(e=re.value)?void 0:e.total_entries)+" entries ready to import ",1)])]}),_:1})):O("",!0),S("div",B,[q(s,{flat:"",color:"primary",label:"Back",onClick:h[2]||(h[2]=e=>te.value=1),class:"q-mr-sm"}),q(s,{color:"primary",label:"Next: Preview",onClick:h[3]||(h[3]=e=>te.value=3),disable:"valid"!==oe.value},null,8,["disable"])])]),_:1},8,["done"]),q(y,{name:3,title:"Preview Timetable",icon:"preview",done:te.value>3},{default:j(()=>[h[14]||(h[14]=S("div",{class:"text-body2 q-mb-md"}," Review the timetable before applying changes. ",-1)),ne.value?(x(),C("div",F,[S("div",L,[q(d,{icon:"meeting_room",color:"blue-2","text-color":"blue-9"},{default:j(()=>[Q(" Classroom ID: "+N(ne.value.classroom_id),1)]),_:1}),q(d,{icon:"schedule",color:"green-2","text-color":"green-9"},{default:j(()=>{var e;return[Q(N(null==(e=ne.value.entries)?void 0:e.length)+" periods ",1)]}),_:1})]),q(g,{rows:ne.value.entries||[],columns:pe,"row-key":"index",flat:"",bordered:"",dense:"","rows-per-page-options":[0]},{"body-cell-day":j(e=>[q(f,{props:e},{default:j(()=>{return[q(b,{color:(a=e.row.day,{Sunday:"red-4",Monday:"blue-4",Tuesday:"green-4",Wednesday:"orange-4",Thursday:"purple-4"}[a]||"grey-4")},{default:j(()=>[Q(N(e.row.day),1)]),_:2},1032,["color"])];var a}),_:2},1032,["props"])]),"body-cell-period":j(e=>[q(f,{props:e},{default:j(()=>[S("strong",null,"Period "+N(e.row.period),1)]),_:2},1032,["props"])]),_:1},8,["rows"])])):O("",!0),S("div",$,[q(s,{flat:"",color:"primary",label:"Back",onClick:h[4]||(h[4]=e=>te.value=2),class:"q-mr-sm"}),q(s,{color:"primary",label:"Next: Apply",onClick:h[5]||(h[5]=e=>te.value=4)})])]),_:1},8,["done"]),q(y,{name:4,title:"Apply Changes",icon:"published_with_changes"},{default:j(()=>[h[17]||(h[17]=S("div",{class:"text-body2 q-mb-md"}," The imported timetable will be merged with your existing schedule: ",-1)),q(n,{class:"bg-blue-1 q-mb-md"},{avatar:j(()=>[q(t,{name:"info",color:"blue"})]),default:j(()=>[h[15]||(h[15]=S("div",null,[S("strong",null,"Update Mode:"),Q(" This will update or create schedules only for the day/period combinations in the imported data. Other schedules will remain unchanged. ")],-1))]),_:1}),S("div",E,[q(s,{flat:"",color:"primary",label:"Back",onClick:h[6]||(h[6]=e=>te.value=3),class:"q-mr-sm",disable:ue.value},null,8,["disable"]),q(s,{color:"positive",icon:"check",label:"Apply Import",onClick:fe,loading:ue.value},null,8,["loading"])]),ce.value?(x(),k(n,{key:0,class:P(["q-mt-md",ce.value.success?"bg-positive text-white":"bg-negative text-white"])},{avatar:j(()=>[q(t,{name:ce.value.success?"check_circle":"error",color:"white"},null,8,["name"])]),default:j(()=>[S("div",null,[S("div",W,N(ce.value.message),1),ce.value.summary?(x(),C("div",z,[ce.value.summary.created?(x(),C("div",G,"Created: "+N(ce.value.summary.created),1)):O("",!0),ce.value.summary.updated?(x(),C("div",Y,"Updated: "+N(ce.value.summary.updated),1)):O("",!0),ce.value.summary.failed?(x(),C("div",K,"Failed: "+N(ce.value.summary.failed),1)):O("",!0)])):O("",!0),ce.value.failed&&ce.value.failed.length>0?(x(),C("div",H,[h[16]||(h[16]=S("div",{class:"text-weight-bold"},"Failed entries:",-1)),S("ul",X,[(x(!0),C(V,null,T(ce.value.failed.slice(0,3),(e,a)=>(x(),C("li",{key:a},N(e.reason),1))),128))])])):O("",!0)])]),_:1},8,["class"])):O("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1}),q(o),q(u,{align:"right"},{default:j(()=>[I(q(s,{flat:"",label:"Close",color:"primary"},null,512),[[m]])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},[["__scopeId","data-v-c1b64b76"]]);export{Z as default};
