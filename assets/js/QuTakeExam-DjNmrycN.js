import{Q as e,a as t}from"./QToolbar-BC_oHanJ.js";import{Q as a}from"./QHeader-hL-bsl9A.js";import{o as s,u as l,m as n,c as o,d as i,Q as r,a as u,l as d,b as c,aP as m}from"./app-Buylb2AA.js";import{Q as v}from"./QLinearProgress-B7jHdoB9.js";import{Q as p}from"./QPageContainer-PmEjwbBk.js";import{Q as g}from"./QLayout-PCowbxvV.js";import{f,a as x,o as y,z as _,ae as b,L as h,I as q,b as w,J as j,M as Q,U as k,F as E,Q as A,H as C,O as V,V as I,x as S,m as z,Z as L,_ as P}from"./vendor-CUZ9QTQV.js";import{s as T}from"./i18n-CP46N9fu.js";import D from"./QuExamTimer-2zmaH1bc.js";import O from"./QuQuestionDisplay-q7be7jJZ.js";import"./offline-BzIlwqNM.js";import"./ui-LrZmvB2D.js";import"./QSpace-1_yTqfel.js";import"./katex-BAATRBTg.js";import"./katex-BXKQVcz-.js";const F={class:"text-h6"},H={class:"text-caption text-grey-7"},M={class:"exam-content"},U={class:"navigation-sidebar"},$={class:"text-caption text-grey-7 q-mb-sm"},J={class:"question-grid"},N={class:"text-caption text-grey-7 q-mb-xs"},R={class:"question-area"},W={class:"text-caption text-grey-7 q-mb-sm"},Y={class:"q-gutter-sm"},Z={class:"q-mt-md"},B={class:"text-caption text-grey-7"},G={key:0,class:"text-caption text-warning q-mt-xs"},K=s({__name:"QuTakeExam",props:{exam:Object,attempt:Object,questions:Array,existing_answers:Object},setup(s){const K=l(),X=s,ee=f(0),te=f({...X.existing_answers}),ae=f(Date.now()),se=f(!1),le=f(!1),ne=f(!1),oe=f(!1);let ie=null;const re=x(()=>X.questions[ee.value]),ue=x({get:()=>te.value[re.value.id]||{selected_options:[],answer_text:""},set(e){te.value[re.value.id]=e}}),de=x(()=>Object.keys(te.value).filter(e=>{const t=te.value[e],a=t.selected_options&&("string"==typeof t.selected_options&&t.selected_options.length>0||Array.isArray(t.selected_options)&&t.selected_options.length>0),s=t.answer_text&&t.answer_text.trim().length>0;return a||s}).length),ce=x(()=>{const e=Math.floor((Date.now()-ae.value)/1e3);if(e<10)return"Just now";if(e<60)return`${e}s ago`;return`${Math.floor(e/60)}m ago`}),me=e=>{const t=te.value[e];if(!t)return!1;const a=t.selected_options&&("string"==typeof t.selected_options&&t.selected_options.length>0||Array.isArray(t.selected_options)&&t.selected_options.length>0),s=t.answer_text&&t.answer_text.trim().length>0;return a||s},ve=e=>{if(ee.value===e)return"primary";const t=X.questions[e];return me(t.id)?"positive":"grey-5"},pe=()=>{ee.value>0&&ee.value--},ge=()=>{ee.value<X.questions.length-1&&ee.value++},fe=()=>{},xe=async(e=!0)=>{if(!le.value){se.value=!0;try{await L.post(T("qu-student.exams.auto-save",{quExam:X.exam.id,quAttempt:X.attempt.id}),{answers:te.value}),ae.value=Date.now(),e&&K.notify({type:"positive",message:"Progress saved",icon:"save",timeout:2e3})}catch(t){e&&K.notify({type:"negative",message:"Failed to save progress",icon:"error"}),console.error("Auto-save error:",t)}finally{se.value=!1}}},ye=()=>{ne.value=!0},_e=()=>{oe.value=!0,P.post(T("qu-student.exams.submit",{quExam:X.exam.id,quAttempt:X.attempt.id}),{answers:te.value},{onSuccess:()=>{le.value=!0,clearInterval(ie),K.notify({type:"positive",message:"Exam submitted successfully!",icon:"check_circle"})},onError:e=>{oe.value=!1,K.notify({type:"negative",message:e.message||"Failed to submit exam",icon:"error"})}})},be=()=>{le.value=!0,clearInterval(ie),_e()},he=e=>{},qe=()=>{},we=e=>{if(!le.value)return e.preventDefault(),e.returnValue="",""};return y(()=>{ie=setInterval(()=>{xe(!1)},3e4),window.addEventListener("beforeunload",we)}),_(()=>{ie&&clearInterval(ie),window.removeEventListener("beforeunload",we)}),(l,f)=>{const x=b("Head");return q(),h(E,null,[w(x,{title:s.exam.title||"Take Exam"},null,8,["title"]),w(g,z({view:"hHh lpR fFf",class:"bg-grey-1"},l.$attrs),{default:j(()=>[w(a,{elevated:"",class:"bg-white text-dark"},{default:j(()=>[w(e,null,{default:j(()=>[w(t,null,{default:j(()=>{var e;return[Q("div",F,k(s.exam.title),1),Q("div",H,k(null==(e=s.exam.subject)?void 0:e.name),1)]}),_:1}),w(D,{"remaining-seconds":s.attempt.remaining_seconds,"auto-submit":be,onTimeWarning:he,onTimeExpired:qe},null,8,["remaining-seconds"])]),_:1})]),_:1}),w(p,null,{default:j(()=>[Q("div",M,[Q("div",U,[w(n,null,{default:j(()=>[w(o,null,{default:j(()=>[f[3]||(f[3]=Q("div",{class:"text-subtitle2 q-mb-md"},"Questions",-1)),Q("div",$," Answered: "+k(de.value)+" / "+k(s.questions.length),1),Q("div",J,[(q(!0),h(E,null,A(s.questions,(e,t)=>(q(),C(r,{key:e.id,label:t+1,color:ve(t),outline:ee.value!==t,unelevated:ee.value===t,size:"sm",onClick:e=>(e=>{ee.value=e})(t),class:"question-nav-btn"},{default:j(()=>[me(e.id)?(q(),C(i,{key:0,name:"check",size:"xs",class:"absolute-top-right",style:{margin:"2px"}})):V("",!0)]),_:2},1032,["label","color","outline","unelevated","onClick"]))),128))])]),_:1}),w(u),w(o,null,{default:j(()=>[Q("div",N," Last saved: "+k(ce.value),1),se.value?(q(),C(v,{key:0,indeterminate:"",color:"primary",size:"2px"})):V("",!0)]),_:1})]),_:1})]),Q("div",R,[w(n,null,{default:j(()=>[w(o,null,{default:j(()=>[Q("div",W," Question "+k(ee.value+1)+" of "+k(s.questions.length),1),w(O,{question:re.value,index:ee.value+1,modelValue:ue.value,"onUpdate:modelValue":[f[0]||(f[0]=e=>ue.value=e),fe],readonly:!1,"show-correct-answer":!1},null,8,["question","index","modelValue"])]),_:1}),w(u),w(d,{align:"between",class:"q-pa-md"},{default:j(()=>[w(r,{flat:"",color:"primary",label:"Previous",icon:"chevron_left",disable:0===ee.value,onClick:pe},null,8,["disable"]),Q("div",Y,[w(r,{outline:"",color:"primary",label:"Save Progress",icon:"save",onClick:f[1]||(f[1]=e=>xe(!0)),loading:se.value},null,8,["loading"]),w(r,{color:"negative",label:"Submit Exam",icon:"send",onClick:ye})]),w(r,{flat:"",color:"primary",label:"Next","icon-right":"chevron_right",disable:ee.value===s.questions.length-1,onClick:ge},null,8,["disable"])]),_:1})]),_:1})])])]),_:1}),w(c,{modelValue:ne.value,"onUpdate:modelValue":f[2]||(f[2]=e=>ne.value=e),persistent:""},{default:j(()=>[w(n,{style:{"min-width":"400px"}},{default:j(()=>[w(o,null,{default:j(()=>f[4]||(f[4]=[Q("div",{class:"text-h6"},"Submit Exam?",-1)])),_:1}),w(o,null,{default:j(()=>[f[5]||(f[5]=Q("p",null,"Are you sure you want to submit your exam?",-1)),Q("div",Z,[Q("div",B," Answered: "+k(de.value)+" / "+k(s.questions.length)+" questions ",1),de.value<s.questions.length?(q(),h("div",G,[w(i,{name:"warning",size:"sm"}),I(" You have "+k(s.questions.length-de.value)+" unanswered question(s) ",1)])):V("",!0)])]),_:1}),w(d,{align:"right"},{default:j(()=>[S(w(r,{flat:"",label:"Cancel",color:"primary"},null,512),[[m]]),w(r,{label:"Submit",color:"negative",onClick:_e,loading:oe.value},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},16)],64)}}},[["__scopeId","data-v-ddba3016"]]);export{K as default};
