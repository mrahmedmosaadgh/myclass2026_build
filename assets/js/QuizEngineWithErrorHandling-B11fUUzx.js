import e from"./QuizEngine-BXnn5D6N.js";import t from"./ErrorDisplay-C7fzd9Oh.js";import a from"./LoadingIndicator-Dmuj5Sii.js";import{f as r,Z as n,d as o,a as s,o as i,e as l,k as u,L as d,I as c,b as m,H as v,O as p,y as w,M as E,U as h}from"./vendor-EI0FRBVb.js";import{p as y}from"./app-Dccx8xF5.js";import"./useQuizI18n-Bzgnl5cn.js";import"./i18n-BbKXhR_S.js";import"./offline-BzIlwqNM.js";import"./ui-B__oX9pK.js";const R={QUIZ_NOT_FOUND:"The requested quiz could not be found. Please try again.",INVALID_ANSWER_FORMAT:"Your answer could not be submitted. Please check your selection and try again.",IMPORT_VALIDATION_FAILED:"The import file contains errors. Please check the file and try again.",UNAUTHORIZED_ACCESS:"You do not have permission to access this quiz.",DATABASE_ERROR:"A database error occurred. Please try again later.",VALIDATION_ERROR:"Please check your input and try again.",QUIZ_FETCH_ERROR:"Failed to load the quiz. Please refresh the page.",ATTEMPT_CREATION_ERROR:"Failed to start the quiz. Please try again.",ANSWER_SUBMISSION_ERROR:"Failed to submit your answer. Please try again.",COMPLETION_ERROR:"Failed to complete the quiz. Please try again.",RESULTS_RETRIEVAL_ERROR:"Failed to load quiz results. Please try again.",NETWORK_ERROR:"Network connection failed. Please check your internet connection.",TIMEOUT_ERROR:"The request timed out. Please try again.",UNKNOWN_ERROR:"An unexpected error occurred. Please try again.",INVALID_QUESTIONS:"Some questions are not available. Please contact support.",ATTEMPT_COMPLETED:"This quiz has already been completed.",INVALID_QUESTION:"This question is not part of the quiz.",NOT_FOUND:"The requested resource was not found.",ALREADY_COMPLETED:"This quiz attempt has already been completed.",ATTEMPT_NOT_COMPLETED:"This quiz attempt has not been completed yet."};function g(){const e=r({hasError:!1,error:null,retryCount:0}),t=e=>R[e]||R.UNKNOWN_ERROR,a=()=>{e.value={hasError:!1,error:null,retryCount:0}},n=e=>{var t,a,r;const n=null==(r=null==(a=null==(t=e.response)?void 0:t.data)?void 0:a.error)?void 0:r.code;return["UNAUTHORIZED_ACCESS","VALIDATION_ERROR","INVALID_QUESTIONS","ATTEMPT_COMPLETED","INVALID_QUESTION","NOT_FOUND","ALREADY_COMPLETED","ATTEMPT_NOT_COMPLETED"].includes(n)},o=e=>new Promise(t=>setTimeout(t,e));return{errorState:e,handleError:a=>{var r,n,o;let s;console.error("Error occurred:",a),s=(null==(n=null==(r=a.response)?void 0:r.data)?void 0:n.error)?a.response.data.error:"ECONNABORTED"===a.code||(null==(o=a.message)?void 0:o.includes("timeout"))?{code:"TIMEOUT_ERROR",message:t("TIMEOUT_ERROR"),timestamp:(new Date).toISOString()}:"ERR_NETWORK"!==a.code&&navigator.onLine?{code:"UNKNOWN_ERROR",message:a.message||t("UNKNOWN_ERROR"),timestamp:(new Date).toISOString()}:{code:"NETWORK_ERROR",message:t("NETWORK_ERROR"),timestamp:(new Date).toISOString()},e.value={hasError:!0,error:s,retryCount:e.value.retryCount}},clearError:a,retryOperation:async(t,r=3)=>{let s;for(let l=0;l<=r;l++)try{l>0&&a(),e.value.retryCount=l;const r=await t();return e.value.retryCount=0,r}catch(i){if(s=i,n(i))throw i;if(l===r)throw i;const e=1e3*Math.pow(2,l);await o(e)}throw s},getUserFriendlyMessage:t,isNetworkError:()=>{var t;return"NETWORK_ERROR"===(null==(t=e.value.error)?void 0:t.code)},isRetryable:()=>!!e.value.error&&!n({response:{data:{error:e.value.error}}})}}const O={class:"quiz-engine-wrapper"},f={key:2,class:"offline-indicator",role:"status","aria-live":"polite"},T={key:3,class:"queued-indicator",role:"status","aria-live":"polite"},_=["disabled"],I=y(o({__name:"QuizEngineWithErrorHandling",props:{quiz:{default:()=>[]},fetchParams:{default:void 0},config:{default:()=>({})},attemptId:{default:void 0},autoStartAttempt:{type:Boolean,default:!1}},emits:["answer-selected","question-changed","quiz-completed","quiz-review-enter","time-warning","attempt-started","error"],setup(o,{emit:y}){const R=o,I=y,{errorState:q,handleError:N,clearError:A,isRetryable:S}=g(),{isLoading:z,isSaving:D,fetchQuiz:L,startAttempt:P,submitAnswer:U,queueAnswer:C,processQueuedAnswers:b,hasQueuedAnswers:M}=function(){const{handleError:e,clearError:t,retryOperation:a}=g(),o=r(!1),s=r(!1),i=async(r,o,i,l,u)=>{s.value=!0,t();try{return await a(async()=>{var e;const t=await n.post(`/api/quiz/attempts/${r}/answers`,{question_id:o,selected_option_id:i,selected_text:l,time_spent_sec:u},{timeout:1e4});if(!t.data.success)throw new Error((null==(e=t.data.error)?void 0:e.message)||"Failed to submit answer");return t.data.data})}catch(d){throw e(d),d}finally{s.value=!1}},l=()=>{try{const e=localStorage.getItem("quiz_answer_queue");return e?JSON.parse(e):[]}catch(e){return[]}},u=e=>{try{localStorage.setItem("quiz_answer_queue",JSON.stringify(e))}catch(t){console.error("Failed to save answer queue:",t)}},d=e=>{const t=l().filter(t=>!(t.attemptId===e.attemptId&&t.questionId===e.questionId));u(t)};return{isLoading:o,isSaving:s,fetchQuiz:async r=>{o.value=!0,t();try{return await a(async()=>{var e;const t=await n.get("/api/quiz/fetch",{params:r,timeout:1e4});if(!t.data.success)throw new Error((null==(e=t.data.error)?void 0:e.message)||"Failed to fetch quiz");return t.data.data.questions})}catch(s){throw e(s),s}finally{o.value=!1}},startAttempt:async(r,o,i)=>{s.value=!0,t();try{return await a(async()=>{var e;const t=await n.post("/api/quiz/attempts",{question_ids:r,quiz_id:o,metadata:i},{timeout:1e4});if(!t.data.success)throw new Error((null==(e=t.data.error)?void 0:e.message)||"Failed to start quiz attempt");return t.data.data})}catch(l){throw e(l),l}finally{s.value=!1}},submitAnswer:i,completeAttempt:async r=>{s.value=!0,t();try{return await a(async()=>{var e;const t=await n.put(`/api/quiz/attempts/${r}/complete`,{},{timeout:1e4});if(!t.data.success)throw new Error((null==(e=t.data.error)?void 0:e.message)||"Failed to complete quiz");return t.data.data})}catch(o){throw e(o),o}finally{s.value=!1}},getResults:async r=>{o.value=!0,t();try{return await a(async()=>{var e;const t=await n.get(`/api/quiz/attempts/${r}/results`,{timeout:1e4});if(!t.data.success)throw new Error((null==(e=t.data.error)?void 0:e.message)||"Failed to get results");return t.data.data})}catch(s){throw e(s),s}finally{o.value=!1}},queueAnswer:(e,t,a)=>{const r=l();r.push({attemptId:e,questionId:t,answerRecord:a,timestamp:(new Date).toISOString()}),u(r)},processQueuedAnswers:async()=>{const e=l();if(0!==e.length)for(const a of e)try{await i(a.attemptId,a.questionId,a.answerRecord.selectedOptionId,a.answerRecord.selectedText,a.answerRecord.timeSpentSec),d(a)}catch(t){console.error("Failed to process queued answer:",t)}},hasQueuedAnswers:()=>l().length>0}}(),F=r(R.quiz||[]),Q=r("number"==typeof R.attemptId?R.attemptId:void 0),k=r(!1),W=r(!1),V=r(navigator.onLine),j=s(()=>z.value||D.value),K=s(()=>D.value?"Saving your answer...":z.value?"Loading quiz...":"Loading..."),x=s(()=>{var e;if(!q.value.hasError)return!1;return["UNAUTHORIZED_ACCESS","QUIZ_NOT_FOUND","INVALID_QUESTIONS"].includes((null==(e=q.value.error)?void 0:e.code)||"")}),Z=async()=>{try{if(R.quiz&&R.quiz.length>0)return void(F.value=R.quiz);if(R.fetchParams){const e=await L(R.fetchParams);F.value=e,R.autoStartAttempt&&e.length>0&&await H(e.map(e=>e.id))}}catch(e){I("error",e)}},H=async e=>{try{const t=await P(e);Q.value=t.attempt_id,I("attempt-started",t.attempt_id)}catch(t){I("error",t)}},Y=async e=>{if(I("answer-selected",e),Q.value)try{V.value?await U(Q.value,e.questionId,e.selectedOptionId,e.selectedText,e.timeSpentSec):C(Q.value,e.questionId,e)}catch(t){C(Q.value,e.questionId,e),I("error",t)}},B=e=>{I("question-changed",e)},$=e=>{I("quiz-completed",e)},J=()=>{I("quiz-review-enter")},G=e=>{I("time-warning",e)},X=async()=>{k.value=!0,A();try{await Z()}catch(e){}finally{k.value=!1}},ee=async()=>{if(V.value){W.value=!0;try{await b()}catch(e){N(e)}finally{W.value=!1}}},te=()=>{V.value=navigator.onLine,V.value&&M()&&ee()};return i(async()=>{await Z(),window.addEventListener("online",te),window.addEventListener("offline",te)}),l(()=>{window.removeEventListener("online",te),window.removeEventListener("offline",te)}),u(()=>R.quiz,e=>{e&&e.length>0&&(F.value=e)}),(r,n)=>(c(),d("div",O,[m(a,{"is-loading":j.value,message:K.value},null,8,["is-loading","message"]),j.value?p("",!0):(c(),v(t,{key:0,error:w(q).error,"can-retry":w(S)(),"is-retrying":k.value,"show-details":w(false),onRetry:X,onDismiss:w(A)},null,8,["error","can-retry","is-retrying","show-details","onDismiss"])),!j.value&&!x.value&&F.value.length>0?(c(),v(e,{key:1,quiz:F.value,config:r.config,"attempt-id":Q.value,onAnswerSelected:Y,onQuestionChanged:B,onQuizCompleted:$,onQuizReviewEnter:J,onTimeWarning:G},null,8,["quiz","config","attempt-id"])):p("",!0),V.value?p("",!0):(c(),d("div",f,n[0]||(n[0]=[E("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"offline-icon","aria-hidden":"true"},[E("path",{"fill-rule":"evenodd",d:"M1.371 8.143c5.858-5.857 15.356-5.857 21.213 0a.75.75 0 010 1.061l-.53.53a.75.75 0 01-1.06 0c-4.98-4.979-13.053-4.979-18.032 0a.75.75 0 01-1.06 0l-.53-.53a.75.75 0 010-1.06zm3.182 3.182c4.1-4.1 10.749-4.1 14.85 0a.75.75 0 010 1.061l-.53.53a.75.75 0 01-1.062 0 8.25 8.25 0 00-11.667 0 .75.75 0 01-1.06 0l-.53-.53a.75.75 0 010-1.061zm3.204 3.182a6 6 0 018.486 0 .75.75 0 010 1.061l-.53.53a.75.75 0 01-1.061 0 3.75 3.75 0 00-5.304 0 .75.75 0 01-1.06 0l-.53-.53a.75.75 0 010-1.061zm3.182 3.182a1.5 1.5 0 012.122 0 .75.75 0 010 1.061l-.53.53a.75.75 0 01-1.061 0l-.53-.53a.75.75 0 010-1.061z","clip-rule":"evenodd"}),E("path",{d:"M3 3l18 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),E("span",null,"You are offline. Answers will be saved and submitted when connection is restored.",-1)]))),w(M)()?(c(),d("div",T,[n[1]||(n[1]=E("span",null,"You have unsaved answers. They will be submitted when connection is restored.",-1)),V.value?(c(),d("button",{key:0,class:"sync-button",onClick:ee,disabled:W.value},h(W.value?"Syncing...":"Sync Now"),9,_)):p("",!0)])):p("",!0)]))}}),[["__scopeId","data-v-0d1d860c"]]);export{I as default};
