import{o as e,u as a,c as l,d as o,aP as t,Q as s,e as r,g as d,h as i,i as u,p as n,f as m,j as c,m as v,b as p}from"./app-B77gjd5a.js";import{Q as g}from"./QSelect-DB_tK-Lk.js";import{Q as _}from"./QStepperNavigation-kWQGGVMQ.js";import{Q as f,a as y}from"./QStepper-ByYk8Nka.js";import{Q as b}from"./QBadge-ZkvAqPBD.js";import{Q as h}from"./QTd-Cd1TbwhN.js";import{Q as w}from"./QTable-Dzgz30xz.js";import{Q as x}from"./QLinearProgress-B9hMkhRG.js";import{a as V,f as q,I as k,J as j,K as Q,b as C,N as P,y as S,W as A,M as U,Q as F,V as T,R as M,F as N,_ as R}from"./vendor-DuKqz2x4.js";import"./offline-BzIlwqNM.js";import"./i18n-DE5KxGn8.js";import"./ui-BITzTqrO.js";import"./rtl-Cr6c3OOr.js";import"./use-panel-N2fkKyR_.js";import"./use-render-cache-CmTcazfP.js";import"./QMarkupTable-xKG6mM4A.js";import"./use-fullscreen-Cf3Zl1YN.js";const Y={class:"col"},z={class:"text-h6"},B={class:"q-pa-md"},D={class:"row q-col-gutter-md"},G={class:"col-12 col-md-6"},W={class:"col-12 col-md-6"},E={class:"col-12"},I={key:0,class:"q-mt-md"},O={class:"q-pa-md"},$={class:"q-mb-md"},J={class:"row q-col-gutter-md items-center"},K={class:"col-12 col-md-5"},L={class:"text-subtitle2"},H={class:"text-caption text-grey-7"},X={class:"col-12 col-md-1 text-center"},Z={class:"col-12 col-md-5"},ee={class:"col-12 col-md-1"},ae={class:"q-pa-md"},le={class:"text-weight-bold"},oe={class:"q-my-sm"},te={class:"text-weight-bold"},se={class:"text-caption text-grey-7"},re={class:"text-weight-bold"},de={class:"text-caption text-grey-7"},ie={class:"text-caption"},ue={class:"q-mt-md"},ne={class:"q-pa-md"},me={key:2,class:"q-mt-md"},ce={class:"q-mt-md"},ve=e({__name:"StudentPromotionDialog",props:{modelValue:Boolean,grades:{type:Array,default:()=>[]},academicYears:{type:Array,default:()=>[]}},emits:["update:modelValue","promoted"],setup(e,{emit:ve}){const pe=e,ge=ve,_e=a(),fe=V({get:()=>pe.modelValue,set:e=>ge("update:modelValue",e)}),ye=q(1),be=q(!1),he=q(!1),we=q(null),xe=q(null),Ve=q(null),qe=q([]),ke=q([]),je=q([]),Qe=q([]),Ce=q([]),Pe=q("Year-end promotion "+(new Date).getFullYear()),Se=q(""),Ae=q({}),Ue=V(()=>qe.value.reduce((e,a)=>e+(a.student_count||0),0)),Fe=V(()=>we.value&&xe.value&&Ve.value),Te=V(()=>je.value.length>0&&je.value.every(e=>e.to_classroom_id)),Me=V(()=>Qe.value.reduce((e,a)=>e+a.student_count,0)),Ne=[{name:"from",label:"From Classroom",field:"from_classroom",align:"left"},{name:"to",label:"To Classroom",field:"to_classroom",align:"left"},{name:"students",label:"Students",field:"student_count",align:"center"}],Re=async()=>{if(we.value){be.value=!0;try{const e=await R.get(`/admin/classrooms/by-grade/${we.value}`);qe.value=e.data}catch(e){_e.notify({type:"negative",message:"Failed to load source classrooms"})}finally{be.value=!1}}},Ye=async()=>{if(xe.value){be.value=!0;try{const e=await R.get(`/admin/classrooms/by-grade/${xe.value}`);ke.value=e.data}catch(e){_e.notify({type:"negative",message:"Failed to load target classrooms"})}finally{be.value=!1}}},ze=async()=>{be.value=!0;try{const e=await R.get("/admin/students/classroom-mapping-suggestions",{params:{source_grade_id:we.value,target_grade_id:xe.value}});je.value=e.data.suggestions,ye.value=2}catch(e){_e.notify({type:"negative",message:"Failed to load classroom mappings"})}finally{be.value=!1}},Be=()=>{je.value.forEach(e=>{}),_e.notify({type:"positive",message:"Auto-mapping applied"})},De=async()=>{be.value=!0;try{const e=await R.post("/admin/students/promotion-preview",{source_grade_id:we.value,target_grade_id:xe.value,classroom_mappings:je.value});Qe.value=e.data.preview,Ce.value=e.data.warnings,ye.value=3}catch(e){_e.notify({type:"negative",message:"Failed to load preview"})}finally{be.value=!1}},Ge=async()=>{var e,a;he.value=!0;try{const e=await R.post("/admin/students/promote",{source_grade_id:we.value,target_grade_id:xe.value,academic_year_id:Ve.value,classroom_mappings:je.value,promotion_reason:Pe.value,notes:Se.value});Ae.value=e.data,ye.value=4,ge("promoted",e.data)}catch(l){Ae.value={success:!1,message:(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"Promotion failed"},ye.value=4}finally{he.value=!1}},We=()=>{fe.value=!1,setTimeout(()=>{ye.value=1,we.value=null,xe.value=null,Ve.value=null,je.value=[],Qe.value=[],Ce.value=[],Ae.value={}},300)};return(a,V)=>(j(),k(p,{modelValue:fe.value,"onUpdate:modelValue":V[8]||(V[8]=e=>fe.value=e),persistent:"",maximized:"","transition-show":"slide-up","transition-hide":"slide-down"},{default:Q(()=>[C(v,null,{default:Q(()=>[C(l,{class:"bg-primary text-white row items-center"},{default:Q(()=>[P("div",Y,[P("div",z,[C(o,{name:"upgrade",class:"q-mr-sm"}),V[9]||(V[9]=A(" Student Promotion Wizard "))]),V[10]||(V[10]=P("div",{class:"text-caption"},"Promote students to next grade level",-1))]),S(C(s,{flat:"",round:"",dense:"",icon:"close"},null,512),[[t]])]),_:1}),C(f,{modelValue:ye.value,"onUpdate:modelValue":V[7]||(V[7]=e=>ye.value=e),ref:"stepper",color:"primary",animated:"","header-nav":"",class:"full-height"},{default:Q(()=>[C(y,{name:1,title:"Select Grades",icon:"school",done:ye.value>1},{default:Q(()=>[P("div",B,[C(r,{class:"bg-info text-white q-mb-md"},{avatar:Q(()=>[C(o,{name:"info"})]),default:Q(()=>[V[11]||(V[11]=A(" Select the source grade (current) and target grade (next year) for promotion. "))]),_:1}),P("div",D,[P("div",G,[C(g,{modelValue:we.value,"onUpdate:modelValue":[V[0]||(V[0]=e=>we.value=e),Re],options:e.grades,"option-value":"id","option-label":"name",label:"Source Grade (Current) *",outlined:"","emit-value":"","map-options":"",rules:[e=>!!e||"Source grade is required"]},{prepend:Q(()=>[C(o,{name:"school"})]),_:1},8,["modelValue","options","rules"])]),P("div",W,[C(g,{modelValue:xe.value,"onUpdate:modelValue":[V[1]||(V[1]=e=>xe.value=e),Ye],options:e.grades,"option-value":"id","option-label":"name",label:"Target Grade (Next Year) *",outlined:"","emit-value":"","map-options":"",rules:[e=>!!e||"Target grade is required"]},{prepend:Q(()=>[C(o,{name:"trending_up"})]),_:1},8,["modelValue","options","rules"])]),P("div",E,[C(g,{modelValue:Ve.value,"onUpdate:modelValue":V[2]||(V[2]=e=>Ve.value=e),options:e.academicYears,"option-value":"id","option-label":"name",label:"Academic Year *",outlined:"","emit-value":"","map-options":"",rules:[e=>!!e||"Academic year is required"]},{prepend:Q(()=>[C(o,{name:"calendar_today"})]),_:1},8,["modelValue","options","rules"])])]),we.value&&qe.value.length>0?(j(),U("div",I,[C(r,{class:"bg-positive text-white"},{avatar:Q(()=>[C(o,{name:"check_circle"})]),default:Q(()=>[A(" Found "+T(qe.value.length)+" classrooms with "+T(Ue.value)+" students ",1)]),_:1})])):F("",!0)]),C(_,null,{default:Q(()=>[C(s,{onClick:ze,color:"primary",label:"Next: Map Classrooms",disable:!Fe.value,loading:be.value},null,8,["disable","loading"])]),_:1})]),_:1},8,["done"]),C(y,{name:2,title:"Map Classrooms",icon:"compare_arrows",done:ye.value>2},{default:Q(()=>[P("div",O,[C(r,{class:"bg-info text-white q-mb-md"},{avatar:Q(()=>[C(o,{name:"info"})]),default:Q(()=>[V[12]||(V[12]=A(" Map each source classroom to a target classroom. Auto-suggestions are provided based on classroom names. "))]),_:1}),P("div",$,[C(s,{onClick:Be,color:"secondary",label:"Auto-Map All",icon:"auto_fix_high",outline:"",loading:be.value},null,8,["loading"])]),C(d,{bordered:"",separator:""},{default:Q(()=>[(j(!0),U(N,null,M(je.value,(e,a)=>(j(),k(i,{key:a},{default:Q(()=>[C(u,null,{default:Q(()=>[P("div",J,[P("div",K,[P("div",L,T(e.from_classroom_name),1),P("div",H,T(e.student_count||0)+" students ",1)]),P("div",X,[C(o,{name:"arrow_forward",size:"md",color:"primary"})]),P("div",Z,[C(g,{modelValue:e.to_classroom_id,"onUpdate:modelValue":a=>e.to_classroom_id=a,options:ke.value,"option-value":"id","option-label":"name",label:"Target Classroom *",outlined:"",dense:"","emit-value":"","map-options":"",rules:[e=>!!e||"Required"]},{append:Q(()=>[e.confidence&&e.confidence>70?(j(),k(b,{key:0,color:e.confidence>90?"positive":"warning"},{default:Q(()=>[A(T(Math.round(e.confidence))+"% ",1)]),_:2},1032,["color"])):F("",!0)]),_:2},1032,["modelValue","onUpdate:modelValue","options","rules"])]),P("div",ee,[e.auto_suggested?(j(),k(o,{key:0,name:"auto_awesome",color:"positive",size:"sm"},{default:Q(()=>[C(n,null,{default:Q(()=>V[13]||(V[13]=[A("Auto-suggested")])),_:1})]),_:1})):F("",!0)])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),C(_,null,{default:Q(()=>[C(s,{flat:"",onClick:V[3]||(V[3]=e=>ye.value=1),color:"primary",label:"Back",class:"q-mr-sm"}),C(s,{onClick:De,color:"primary",label:"Next: Preview",disable:!Te.value,loading:be.value},null,8,["disable","loading"])]),_:1})]),_:1},8,["done"]),C(y,{name:3,title:"Preview & Confirm",icon:"preview",done:ye.value>3},{default:Q(()=>[P("div",ae,[Ce.value.length>0?(j(),k(r,{key:0,class:"bg-warning text-white q-mb-md"},{avatar:Q(()=>[C(o,{name:"warning"})]),default:Q(()=>[P("div",le,T(Ce.value.length)+" Warning(s)",1),P("ul",oe,[(j(!0),U(N,null,M(Ce.value,(e,a)=>(j(),U("li",{key:a},T(e.message),1))),128))])]),_:1})):(j(),k(r,{key:1,class:"bg-positive text-white q-mb-md"},{avatar:Q(()=>[C(o,{name:"check_circle"})]),default:Q(()=>[A(" No issues found. Ready to promote "+T(Me.value)+" students! ",1)]),_:1})),C(w,{rows:Qe.value,columns:Ne,"row-key":"from_classroom.id",flat:"",bordered:""},{"body-cell-from":Q(e=>[C(h,{props:e},{default:Q(()=>[P("div",te,T(e.row.from_classroom.name),1),P("div",se,T(e.row.from_classroom.grade),1)]),_:2},1032,["props"])]),"body-cell-to":Q(e=>[C(h,{props:e},{default:Q(()=>[P("div",re,T(e.row.to_classroom.name),1),P("div",de,T(e.row.to_classroom.grade),1),P("div",ie," Current: "+T(e.row.to_classroom.current_count)+" / "+T(e.row.to_classroom.capacity),1)]),_:2},1032,["props"])]),"body-cell-students":Q(e=>[C(h,{props:e},{default:Q(()=>[C(b,{color:"primary"},{default:Q(()=>[A(T(e.row.student_count),1)]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows"]),P("div",ue,[C(m,{modelValue:Pe.value,"onUpdate:modelValue":V[4]||(V[4]=e=>Pe.value=e),label:"Promotion Reason *",outlined:"",rules:[e=>!!e||"Reason is required"],placeholder:"e.g., Year-end promotion 2025-2026"},{prepend:Q(()=>[C(o,{name:"description"})]),_:1},8,["modelValue","rules"]),C(m,{modelValue:Se.value,"onUpdate:modelValue":V[5]||(V[5]=e=>Se.value=e),label:"Notes (Optional)",outlined:"",type:"textarea",rows:"3",class:"q-mt-md",placeholder:"Additional notes about this promotion..."},{prepend:Q(()=>[C(o,{name:"note"})]),_:1},8,["modelValue"])])]),C(_,null,{default:Q(()=>[C(s,{flat:"",onClick:V[6]||(V[6]=e=>ye.value=2),color:"primary",label:"Back",class:"q-mr-sm"}),C(s,{onClick:Ge,color:"positive",label:"Promote All Students",icon:"upgrade",disable:!Pe.value,loading:he.value},null,8,["disable","loading"])]),_:1})]),_:1},8,["done"]),C(y,{name:4,title:"Results",icon:"check_circle"},{default:Q(()=>[P("div",ne,[Ae.value.success?(j(),k(r,{key:0,class:"bg-positive text-white q-mb-md"},{avatar:Q(()=>[C(o,{name:"check_circle",size:"lg"})]),default:Q(()=>[V[14]||(V[14]=P("div",{class:"text-h6"},"Promotion Successful!",-1)),P("div",null,"Successfully promoted "+T(Ae.value.promoted_count)+" students",1)]),_:1})):(j(),k(r,{key:1,class:"bg-negative text-white q-mb-md"},{avatar:Q(()=>[C(o,{name:"error",size:"lg"})]),default:Q(()=>[V[15]||(V[15]=P("div",{class:"text-h6"},"Promotion Failed",-1)),P("div",null,T(Ae.value.message),1)]),_:1})),Ae.value.errors&&Ae.value.errors.length>0?(j(),U("div",me,[C(d,{bordered:""},{default:Q(()=>[C(c,{header:""},{default:Q(()=>V[16]||(V[16]=[A("Errors")])),_:1}),(j(!0),U(N,null,M(Ae.value.errors,(e,a)=>(j(),k(i,{key:a},{default:Q(()=>[C(u,{avatar:""},{default:Q(()=>[C(o,{name:"error",color:"negative"})]),_:1}),C(u,null,{default:Q(()=>[C(c,null,{default:Q(()=>[A(T(e),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):F("",!0),P("div",ce,[C(x,{value:1,color:"positive",class:"q-mb-sm"}),V[17]||(V[17]=P("div",{class:"text-center text-grey-7"}," Promotion complete ",-1))])]),C(_,null,{default:Q(()=>[C(s,{onClick:We,color:"primary",label:"Done",icon:"check"})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"]))}},[["__scopeId","data-v-3418e58e"]]);export{ve as default};
