import{_ as e}from"./AppLayout-ClCiCQFL.js";import{s as t,t as n,v as s,w as o,x as r,o as a,y as i,z as c}from"./app-BwCflFkV.js";import{l}from"./ui-LrZmvB2D.js";import{f as d,a as u,o as m,e as p,L as f,I as v,O as g,M as h,S as y,U as b,y as x,F as w,Q as C,$ as A,x as L,ab as R,n as j,N as I,H as T,J as U,V as k,b as _}from"./vendor-CUZ9QTQV.js";import"./offline-BzIlwqNM.js";import"./i18n-CP46N9fu.js";const D={isConnected:d(!0),lastConnectedAt:d(null),reconnectAttempts:d(0),maxReconnectAttempts:5,reconnectDelay:2e3};const S=new class{constructor(){this.connectionRef=t(n,".info/connected"),this.listeners=new Set,this.reconnectTimer=null}startListening(){this.stopListening(),s(this.connectionRef,e=>{const t=!0===e.val();D.isConnected.value=t,t?(D.lastConnectedAt.value=r(),D.reconnectAttempts.value=0,this.notifyListeners("connected"),l.success("Connection restored")):this.handleDisconnection()},e=>{console.error("Firebase connection error:",e),this.handleDisconnection()})}handleDisconnection(){D.isConnected.value=!1,this.notifyListeners("disconnected"),D.reconnectAttempts.value<D.maxReconnectAttempts?(l.error(`Connection lost. Attempting to reconnect... (${D.reconnectAttempts.value+1}/${D.maxReconnectAttempts})`),clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{D.reconnectAttempts.value++,this.attemptReconnect()},D.reconnectDelay)):(l.error("Connection failed after multiple attempts. Please check your internet connection."),this.notifyListeners("failed"))}attemptReconnect(){const e=t(n,".info/connected");s(e,()=>{o(e)},e=>{console.error("Reconnection attempt failed:",e),this.handleDisconnection()})}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>t(e))}stopListening(){o(this.connectionRef),clearTimeout(this.reconnectTimer)}},$={class:"chat-room"},E={key:0},N={key:1},F={class:"flex flex-col h-[500px] bg-white rounded-lg shadow-lg"},J={class:"p-4 border-b"},O={class:"text-lg font-semibold"},P={class:"text-sm text-gray-500"},G={class:"text-sm font-semibold mb-1"},H={class:"break-words"},V={class:"text-xs mt-1 opacity-70"},z={class:"p-4 border-t"},M=["disabled"],Q=["disabled"],q=a({__name:"ChatRoom",props:["roomId","roomName","currentUser"],setup(e){const a=e,I=d([]),T=d(""),U=d(null),k=d(0),_=t(n,`rooms/${a.roomId}/messages`),q=t(n,`rooms/${a.roomId}/users`),B=u(()=>D.isConnected.value?"connected":D.reconnectAttempts.value>=D.maxReconnectAttempts?"failed":"reconnecting"),K=e=>{if(!e)return"Just now";if("object"==typeof e&&null!==e)return"Just now";try{return new Date(1e3*e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch(t){return console.error("Error formatting time:",t),"Invalid time"}},W=async()=>{U.value&&(await j(),U.value.scrollTop=U.value.scrollHeight)},X=e=>{"connected"===e&&(Y(),Z(),te())},Y=()=>{o(_),s(_,e=>{if(!D.isConnected.value)return;const t=e.val();t&&(I.value=Object.entries(t).map(([e,t])=>({id:e,...t})).sort((e,t)=>t.timestamp-e.timestamp),W())},e=>{console.error("Error fetching messages:",e),l.error("Error loading messages")})},Z=()=>{o(q),s(q,e=>{if(!D.isConnected.value)return;const t=e.val();k.value=t?Object.keys(t).length:0})},ee=async()=>{if(T.value.trim()&&D.isConnected.value)try{await i(_,{text:T.value.trim(),userId:a.currentUser.id,userName:a.currentUser.name,timestamp:r()}),T.value="",await W()}catch(e){console.error("Error sending message:",e),l.error("Failed to send message. Please try again.")}},te=async()=>{try{const e=t(n,`rooms/${a.roomId}/users/${a.currentUser.id}`);await c(e,{name:a.currentUser.name,lastSeen:r()})}catch(e){console.error("Error updating presence:",e)}};return m(()=>{S.addListener(X),S.startListening()}),p(()=>{S.removeListener(X),S.stopListening(),o(_),o(q)}),(t,n)=>(v(),f("div",$,["connected"!==B.value?(v(),f("div",{key:0,class:y([{"bg-yellow-100 border-yellow-400 text-yellow-700":"reconnecting"===B.value,"bg-red-100 border-red-400 text-red-700":"failed"===B.value},"px-4 py-3 rounded relative mb-4"]),role:"alert"},["reconnecting"===B.value?(v(),f("span",E," Attempting to reconnect... ("+b(x(D).reconnectAttempts+1)+"/"+b(x(D).maxReconnectAttempts)+") ",1)):(v(),f("span",N," Connection failed. Please check your internet connection and refresh the page. "))],2)):g("",!0),h("div",F,[h("div",J,[h("h2",O,b(e.roomName),1),h("p",P,b(k.value)+" users online",1)]),h("div",{class:"flex-1 p-4 overflow-y-auto",ref_key:"messagesContainer",ref:U},[(v(!0),f(w,null,C(I.value,t=>(v(),f("div",{key:t.id,class:y(["mb-4",t.userId===e.currentUser.id?"flex justify-end":"flex justify-start"])},[h("div",{class:y(["max-w-[70%] rounded-lg p-3",t.userId===e.currentUser.id?"bg-blue-500 text-white":"bg-gray-100"])},[h("div",G,b(t.userName),1),h("div",H,b(t.text),1),h("div",V,b(K(t.timestamp)),1)],2)],2))),128))],512),h("div",z,[h("form",{onSubmit:A(ee,["prevent"]),class:"flex gap-2"},[L(h("input",{"onUpdate:modelValue":n[0]||(n[0]=e=>T.value=e),type:"text",placeholder:"Type a message...",class:"flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!x(D).isConnected.value},null,8,M),[[R,T.value]]),h("button",{type:"submit",class:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50",disabled:!x(D).isConnected.value||!T.value.trim()}," Send ",8,Q)],32)])])]))}},[["__scopeId","data-v-feb609bf"]]),B={class:"py-12"},K={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},W={__name:"Index",setup(t){var n,s,o;const r=I(),a=u(()=>{var e;return null==(e=r.props.auth)?void 0:e.user}),i=d({id:(null==(s=null==(n=a.value)?void 0:n.id)?void 0:s.toString())||"guest",name:(null==(o=a.value)?void 0:o.name)||"Guest User"});return m(()=>{}),(t,n)=>(v(),T(e,{title:"Chat"},{default:U(()=>[n[0]||(n[0]=k("ffffffffffffffff ")),h("div",B,[h("div",K,[_(q,{"room-id":"general","room-name":"General Chat","current-user":i.value},null,8,["current-user"])])])]),_:1}))}};export{W as default};
