import{u as e,Q as l,g as a,b2 as t,l as o,d as n,n as r}from"./app-DXXarK7I.js";import{Q as u}from"./QSelect-OI6RFhnT.js";import{Q as s}from"./QTd-DaKXGNl2.js";import{Q as d}from"./QTable-CIXbyzJI.js";import{f as m,r as i,a as c,k as p,o as b,Z as f,H as v,I as w,J as y,M as _,b as h,L as g,O as N,F as T,Q as k,al as j}from"./vendor-EI0FRBVb.js";import"./offline-BzIlwqNM.js";import"./i18n-BbKXhR_S.js";import"./ui-B__oX9pK.js";import"./rtl-Cr6c3OOr.js";import"./QMarkupTable-BVGvqYSu.js";import"./QLinearProgress-BEkk-xFg.js";import"./use-fullscreen-DIOkwRkq.js";const V={class:"row items-center q-col-gutter-md q-mb-sm"},C={class:"col"},U={class:"col-auto"},q={class:"row q-col-gutter-md"},I={class:"col-12 col-md-3"},S={class:"col-12 col-md-3"},L={class:"col-12 col-md-3"},x={class:"col-12 col-md-3"},Q={key:0,class:"q-my-sm"},M={__name:"ClassroomRecordsTable",props:{teacherId:{type:Number,required:!1},subjectId:{type:Number,required:!1},classroomId:{type:Number,required:!1},periodCode:{type:String,required:!1},date:{type:String,required:!1},yearId:{type:Number,required:!1}},emits:["record-updated","record-added","filter-changed","columns-changed"],setup(M,{emit:R}){const E=M,O=R,A=e(),$=m([]),F=m(!1),J=m(""),P=m(!0),B=m(!1),D=i({attend:null,minTotal:null,maxTotal:null}),H=[{label:"All",value:null},{label:"Present",value:1},{label:"Absent",value:0}],Z=[{name:"student_name",label:"Student Name",field:e=>{var l;return(null==(l=e.student)?void 0:l.name)||e.student_name},sortable:!0},{name:"attend",label:"Attend",field:"attend",sortable:!0},{name:"book",label:"Book",field:"book"},{name:"homework",label:"Homework",field:"homework"},{name:"out_classroom",label:"Out-Class",field:"out_classroom"},{name:"turn1",label:"Turn 1",field:"turn1"},{name:"turn2",label:"Turn 2",field:"turn2"},{name:"turn3",label:"Turn 3",field:"turn3"},{name:"plus",label:"Plus",field:"plus"},{name:"minus",label:"Minus",field:"minus"},{name:"total",label:"Total",field:"total",sortable:!0},{name:"notes",label:"Notes",field:"notes"},{name:"date",label:"Date",field:"date",sortable:!0}],z=i({});function G(){const e={};Z.forEach(l=>e[l.name]=z[l.name]),localStorage.setItem("classroom_records_layout",JSON.stringify(e)),O("columns-changed",e)}function K(){Z.forEach(e=>z[e.name]=!0),localStorage.removeItem("classroom_records_layout"),O("columns-changed",null)}Z.forEach(e=>z[e.name]=!0);const W=c(()=>Z.filter(e=>z[e.name]).map(e=>({name:e.name,label:e.label,field:e.field,align:"left"}))),X=c(()=>{let e=$.value.slice();if(J.value){const l=J.value.toLowerCase();e=e.filter(e=>{var a;return((null==(a=e.student)?void 0:a.name)||e.student_name||"").toLowerCase().includes(l)||(e.notes||"").toLowerCase().includes(l)})}return null!==D.attend&&(e=e.filter(e=>Number(e.attend)===Number(D.attend))),null!==D.minTotal&&(e=e.filter(e=>Number(e.total||0)>=Number(D.minTotal))),null!==D.maxTotal&&(e=e.filter(e=>Number(e.total||0)<=Number(D.maxTotal))),e});async function Y(){F.value=!0;try{const e={teacher_id:E.teacherId,subject_id:E.subjectId,classroom_id:E.classroomId,period_code:E.periodCode,date:E.date},l=await f.get("/api/classroom-records",{params:e});$.value=l.data.map(e=>(e.turn1=Number(e.turn1||0),e.turn2=Number(e.turn2||0),e.turn3=Number(e.turn3||0),e.plus=Number(e.plus||0),e.minus=Number(e.minus||0),e.total=e.turn1+e.turn2+e.turn3+e.plus-e.minus,e))}catch(e){console.error(e),A.notify({type:"negative",message:"Could not load records"})}finally{F.value=!1}}function ee(){O("filter-changed",{...D})}function le(){D.attend=null,D.minTotal=null,D.maxTotal=null,ee()}function ae(e,l){const a={student_name:{props:["row","col"],template:"<div>{{ row.student?.name || row.student_name }}</div>"},attend:{props:["row","col"],template:'<q-toggle dense v-model="row.attend" @input="emitUpdate" />',setup:(e,{emit:l})=>({emitUpdate:function(){l("update",e.row)}})},default_editor:{props:["row","col"],template:'<q-input dense v-model="row[col.name]" @blur="emitUpdate" />',setup:(e,{emit:l})=>({emitUpdate:function(){l("update",e.row)}})}};return"student_name"===e?a.student_name:["attend","book","homework","out_classroom"].includes(e)?a.attend:["turn1","turn2","turn3","plus","minus","notes","date"].includes(e)?a.default_editor:"total"===e?{props:["row","col"],template:"<div><strong>{{ computedTotal }}</strong></div>",computed:{computedTotal(){return Number(this.row.turn1||0)+Number(this.row.turn2||0)+Number(this.row.turn3||0)+Number(this.row.plus||0)-Number(this.row.minus||0)}}}:a.default_editor}async function te(e){e.total=Number(e.turn1||0)+Number(e.turn2||0)+Number(e.turn3||0)+Number(e.plus||0)-Number(e.minus||0);try{await f.patch(`/api/classroom-records/${e.id}`,e),O("record-updated",e)}catch(l){console.error(l),A.notify({type:"negative",message:"Could not save change"})}}function oe(){const e=W.value,l=[e.map(e=>`"${e.label}"`).join(","),...X.value.map(l=>e.map(e=>{var a;const t="function"==typeof e.field?e.field(l):null!=(a=l[e.name])?a:"";return`"${String(t).replace(/"/g,'""')}"`}).join(","))].join("\n"),a=new Blob([l],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(a),o=document.createElement("a");o.href=t,o.download=`classroom_records_${Date.now()}.csv`,o.click(),URL.revokeObjectURL(t)}return p([()=>E.teacherId,()=>E.subjectId,()=>E.classroomId,()=>E.periodCode,()=>E.date],Y),b(()=>{!function(){try{const e=localStorage.getItem("classroom_records_layout");if(e){const l=JSON.parse(e);Z.forEach(e=>{var a;return z[e.name]=null==(a=l[e.name])||a})}}catch(e){}}(),(E.teacherId||E.periodCode)&&Y()}),(e,m)=>(w(),v(r,{flat:"",bordered:"",class:"q-pa-md"},{default:y(()=>[_("div",V,[_("div",C,[h(l,{flat:"",round:"",dense:"",icon:"settings",onClick:m[0]||(m[0]=e=>P.value=!P.value)}),h(l,{flat:"",round:"",dense:"",icon:"filter_alt",onClick:m[1]||(m[1]=e=>B.value=!B.value)}),h(l,{flat:"",round:"",dense:"",icon:"download",onClick:oe,title:"Export CSV"})]),_("div",U,[h(a,{dense:"",debounce:"300",modelValue:J.value,"onUpdate:modelValue":m[2]||(m[2]=e=>J.value=e),placeholder:"Search student or notes"},null,8,["modelValue"])])]),h(t,{modelValue:B.value,"onUpdate:modelValue":m[6]||(m[6]=e=>B.value=e),icon:"tune",label:"Filters",class:"q-mb-sm"},{default:y(()=>[_("div",q,[_("div",I,[h(u,{dense:"",outlined:"",label:"Attend",modelValue:D.attend,"onUpdate:modelValue":m[3]||(m[3]=e=>D.attend=e),options:H},null,8,["modelValue"])]),_("div",S,[h(a,{dense:"",outlined:"",label:"Min Total",type:"number",modelValue:D.minTotal,"onUpdate:modelValue":m[4]||(m[4]=e=>D.minTotal=e),modelModifiers:{number:!0}},null,8,["modelValue"])]),_("div",L,[h(a,{dense:"",outlined:"",label:"Max Total",type:"number",modelValue:D.maxTotal,"onUpdate:modelValue":m[5]||(m[5]=e=>D.maxTotal=e),modelModifiers:{number:!0}},null,8,["modelValue"])]),_("div",x,[h(l,{label:"Apply Filters",onClick:ee,color:"primary"}),h(l,{flat:"",label:"Reset",onClick:le})])])]),_:1},8,["modelValue"]),h(n,{class:"q-pa-none"},{default:y(()=>[P.value?(w(),g("div",Q,[(w(),g(T,null,k(Z,e=>h(o,{key:e.name,modelValue:z[e.name],"onUpdate:modelValue":l=>z[e.name]=l,label:e.label,inline:"",dense:""},null,8,["modelValue","onUpdate:modelValue","label"])),64)),h(l,{flat:"",label:"Save Layout",onClick:G}),h(l,{flat:"",label:"Reset Layout",onClick:K})])):N("",!0),h(d,{rows:X.value,columns:W.value,"row-key":"id","virtual-scroll":"",selection:"none",class:"shadow-1"},{"body-cell":y(e=>[h(s,{props:e},{default:y(()=>[(w(),v(j(ae(e.col.name)),{row:e.row,col:e.col,onUpdate:te},null,40,["row","col"]))]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1}))}};export{M as default};
