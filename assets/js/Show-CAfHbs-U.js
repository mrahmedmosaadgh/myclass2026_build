import{o as e,c as t,A as a,d as s,B as r,Q as n,p as o,f as i,m as l}from"./app-B77gjd5a.js";import{Q as c}from"./QImg-Dhi2E1r1.js";import{Q as u}from"./QForm-BQsH4F1U.js";import{_ as d}from"./AppLayout-OZsHDu4T.js";import{f as m,a as p,o as g,e as v,k as y,I as f,J as _,K as h,N as x,b as w,W as b,V as k,M as q,Q as D,R as j,U as S,F as E,z as T,n as A,_ as C}from"./vendor-DuKqz2x4.js";import"./offline-BzIlwqNM.js";import"./i18n-DE5KxGn8.js";import"./ui-BITzTqrO.js";const I={class:"flex justify-between items-center"},Q={class:"font-semibold text-xl text-gray-800 leading-tight"},F={class:"py-6"},z={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},L={class:"flex items-center"},V={class:"q-ml-md"},$={class:"text-weight-bold"},U={key:0,class:"text-caption"},K={key:1,class:"text-caption text-primary"},N={class:"q-py-md"},R={key:0,class:"text-center text-grey q-py-xl"},W={key:0,class:"text-center text-grey-7 text-caption q-my-sm"},B={key:0,class:"text-caption text-weight-bold q-mb-xs"},H={key:1},J={key:2},M={key:3},O={key:0,class:"q-mt-sm flex items-center bg-white rounded-borders q-pa-xs"},Y={class:"q-ml-sm"},G=e({__name:"Show",props:{conversation:{type:Object,required:!0},messages:{type:Array,default:()=>[]}},setup(e){const G=window.route,P=e,X=m(null),Z=m(""),ee=m(null),te=m(null),ae=m(null),se=m(null),re=m(!1),ne=m([...P.messages]),oe=p(()=>""!==Z.value.trim()||null!==ee.value),ie=e=>e?e.split(" ").map(e=>e[0]).join("").toUpperCase():"?",le=e=>{if(!e)return"primary";const t=["primary","secondary","accent","positive","negative","info","warning"];return t[e.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%t.length]},ce=e=>{const t=new Date(e),a=new Date,s=new Date(a);return s.setDate(s.getDate()-1),t.toDateString()===a.toDateString()?"Today":t.toDateString()===s.toDateString()?"Yesterday":t.toLocaleDateString([],{weekday:"long",month:"long",day:"numeric"})},ue=(e,t)=>{if(0===t)return!0;return new Date(e.created_at).toDateString()!==new Date(ne.value[t-1].created_at).toDateString()},de=e=>{ee.value=e.target.files[0]||null},me=async()=>{if(!oe.value)return;const e=new FormData;if(""!==Z.value.trim()&&(e.append("body",Z.value),e.append("type","text")),ee.value){e.append("attachment",ee.value);ee.value.type.startsWith("image/")?e.append("type","image"):e.append("type","file")}try{const t=await C.post(G("messages.store",P.conversation.id),e,{headers:{"Content-Type":"multipart/form-data"}});ne.value.push({...t.data,is_mine:!0,user:{id:t.data.user.id,name:t.data.user.name,profile_photo_url:t.data.user.profile_photo_url}}),Z.value="",ee.value=null,ge()}catch(t){console.error("Error sending message:",t)}},pe=()=>{re.value||(re.value=!0,C.post(G("messages.typing",P.conversation.id)).catch(e=>console.error("Error sending typing event:",e)),setTimeout(()=>{re.value=!1},3e3))},ge=()=>{A(()=>{if(X.value){const e=X.value.$el.querySelector(".scroll");e.scrollTop=e.scrollHeight}})},ve=e=>{C.post(G("messages.mark-seen",P.conversation.id),{message_ids:[e]}).catch(e=>console.error("Error marking message as seen:",e))};return g(()=>{(()=>{try{if(!window.Echo)return void console.warn("Laravel Echo not initialized. Real-time messaging will not work.");window.Echo.join(`conversation.${P.conversation.id}`).listen(".message.sent",e=>{ne.value.push({id:e.id,body:e.body,type:e.type,attachment_url:e.attachment_url,created_at:e.created_at,is_mine:!1,user:{id:e.user_id,name:e.user_name,profile_photo_url:e.user_photo}}),ae.value=null,ge(),ve(e.id)}).listen(".user.typing",e=>{e.user_id!==window.userId&&(ae.value=e.user_name,clearTimeout(se.value),se.value=setTimeout(()=>{ae.value=null},3e3))})}catch(e){console.error("Error setting up message listeners:",e)}})(),ge()}),v(()=>{try{clearTimeout(se.value),window.Echo&&window.Echo.leave(`conversation.${P.conversation.id}`)}catch(e){console.error("Error cleaning up message listeners:",e)}}),y(()=>P.messages,e=>{ne.value=[...e],ge()},{deep:!0}),(m,p)=>(_(),f(d,{title:e.conversation.name},{header:h(()=>[x("div",I,[x("h2",Q,k(e.conversation.name),1),w(n,{flat:"",round:"",color:"primary",icon:"arrow_back",to:T(G)("conversations.index")},null,8,["to"])])]),default:h(()=>[x("div",F,[x("div",z,[w(l,{flat:"",bordered:"",class:"chat-container"},{default:h(()=>[w(t,{class:"bg-grey-2"},{default:h(()=>[x("div",L,[e.conversation.is_group?(_(),f(a,{key:0},{default:h(()=>[w(s,{name:"group",size:"md"})]),_:1})):(_(),f(a,{key:1,color:le(e.conversation.name)},{default:h(()=>[b(k(ie(e.conversation.name)),1)]),_:1},8,["color"])),x("div",V,[x("div",$,k(e.conversation.name),1),e.conversation.is_group?(_(),q("div",U,k(e.conversation.users.length)+" participants ",1)):ae.value?(_(),q("div",K,k(ae.value)+" is typing... ",1)):D("",!0)])])]),_:1}),w(t,{class:"messages-container q-pa-none"},{default:h(()=>[w(r,{ref_key:"scrollArea",ref:X,style:{height:"400px"},class:"q-px-md"},{default:h(()=>[x("div",N,[0===e.messages.length?(_(),q("div",R," No messages yet. Start the conversation! ")):(_(!0),q(E,{key:1},j(e.messages,(t,s)=>{return _(),q("div",{key:t.id,class:"q-mb-md"},[ue(t,s)?(_(),q("div",W,k(ce(t.created_at)),1)):D("",!0),x("div",{class:S(["message-bubble flex",t.is_mine?"justify-end":"justify-start"])},[!t.is_mine&&e.conversation.is_group?(_(),f(a,{key:0,size:"sm",color:le(t.user.name),class:"q-mr-sm self-end"},{default:h(()=>[b(k(ie(t.user.name)),1)]),_:2},1032,["color"])):D("",!0),x("div",{class:S(["message-content rounded-borders q-pa-sm",t.is_mine?"bg-primary text-white":"bg-grey-3"])},[!t.is_mine&&e.conversation.is_group?(_(),q("div",B,k(t.user.name),1)):D("",!0),"text"===t.type?(_(),q("div",H,k(t.body),1)):"image"===t.type?(_(),q("div",J,[w(c,{src:t.attachment_url,"spinner-color":"white",style:{"max-width":"250px","max-height":"250px"}},null,8,["src"])])):"file"===t.type?(_(),q("div",M,[w(n,{flat:"",color:t.is_mine?"white":"primary",icon:"attach_file",label:(o=t.attachment_url,o?o.split("/").pop():"File"),href:t.attachment_url,target:"_blank"},null,8,["color","label","href"])])):D("",!0),x("div",{class:S(["text-caption q-mt-xs text-right",t.is_mine?"text-white-7":"text-grey-7"])},k((r=t.created_at,new Date(r).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),3)],2)],2)]);var r,o}),128))])]),_:1},512)]),_:1}),w(t,{class:"message-input bg-grey-2"},{default:h(()=>[w(u,{onSubmit:me,class:"row items-center"},{default:h(()=>[w(n,{round:"",flat:"",color:"primary",icon:"attach_file",onClick:p[0]||(p[0]=e=>m.$refs.fileInput.click())},{default:h(()=>[w(o,null,{default:h(()=>p[3]||(p[3]=[b("Attach File")])),_:1})]),_:1}),x("input",{type:"file",ref_key:"fileInput",ref:te,style:{display:"none"},onChange:de},null,544),w(i,{modelValue:Z.value,"onUpdate:modelValue":p[1]||(p[1]=e=>Z.value=e),placeholder:"Type a message...",dense:"",outlined:"",class:"col q-mx-sm","bg-color":"white",onKeydown:pe},null,8,["modelValue"]),w(n,{round:"",flat:"",color:"primary",icon:"send",type:"submit",disable:!oe.value},null,8,["disable"])]),_:1}),ee.value?(_(),q("div",O,[w(s,{name:"attach_file",color:"primary"}),x("span",Y,k(ee.value.name),1),w(n,{round:"",flat:"",dense:"",icon:"close",onClick:p[2]||(p[2]=e=>ee.value=null)})])):D("",!0)]),_:1})]),_:1})])])]),_:1},8,["title"]))}},[["__scopeId","data-v-3d4c0a19"]]);export{G as default};
