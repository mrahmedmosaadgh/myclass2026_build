import{_ as e}from"./AppLayout-B3PyevP7.js";import{y as t,z as n,A as s,B as r,C as o,r as a,D as i,E as c}from"./app-BxJhpxku.js";import{l}from"./ui-B7TfxbV_.js";import{f as d,a as u,o as m,e as p,N as f,J as v,O as g,R as h,U as y,V as b,z as x,F as w,Q as C,a0 as A,y as L,ac as R,n as j,M as I,I as T,K as U,W as k,b as _}from"./vendor-BWKGNkNB.js";import"./offline-BzIlwqNM.js";import"./i18n-B0T1C7j3.js";const D={isConnected:d(!0),lastConnectedAt:d(null),reconnectAttempts:d(0),maxReconnectAttempts:5,reconnectDelay:2e3};const E=new class{constructor(){this.connectionRef=t(n,".info/connected"),this.listeners=new Set,this.reconnectTimer=null}startListening(){this.stopListening(),s(this.connectionRef,e=>{const t=!0===e.val();D.isConnected.value=t,t?(D.lastConnectedAt.value=o(),D.reconnectAttempts.value=0,this.notifyListeners("connected"),l.success("Connection restored")):this.handleDisconnection()},e=>{console.error("Firebase connection error:",e),this.handleDisconnection()})}handleDisconnection(){D.isConnected.value=!1,this.notifyListeners("disconnected"),D.reconnectAttempts.value<D.maxReconnectAttempts?(l.error(`Connection lost. Attempting to reconnect... (${D.reconnectAttempts.value+1}/${D.maxReconnectAttempts})`),clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{D.reconnectAttempts.value++,this.attemptReconnect()},D.reconnectDelay)):(l.error("Connection failed after multiple attempts. Please check your internet connection."),this.notifyListeners("failed"))}attemptReconnect(){const e=t(n,".info/connected");s(e,()=>{r(e)},e=>{console.error("Reconnection attempt failed:",e),this.handleDisconnection()})}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>t(e))}stopListening(){r(this.connectionRef),clearTimeout(this.reconnectTimer)}},S={class:"chat-room"},$={key:0},N={key:1},F={class:"flex flex-col h-[500px] bg-white rounded-lg shadow-lg"},J={class:"p-4 border-b"},O={class:"text-lg font-semibold"},P={class:"text-sm text-gray-500"},z={class:"text-sm font-semibold mb-1"},G={class:"break-words"},V={class:"text-xs mt-1 opacity-70"},B={class:"p-4 border-t"},H=["disabled"],K=["disabled"],M=a({__name:"ChatRoom",props:["roomId","roomName","currentUser"],setup(e){const a=e,I=d([]),T=d(""),U=d(null),k=d(0),_=t(n,`rooms/${a.roomId}/messages`),M=t(n,`rooms/${a.roomId}/users`),Q=u(()=>D.isConnected.value?"connected":D.reconnectAttempts.value>=D.maxReconnectAttempts?"failed":"reconnecting"),W=e=>{if(!e)return"Just now";if("object"==typeof e&&null!==e)return"Just now";try{return new Date(1e3*e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch(t){return console.error("Error formatting time:",t),"Invalid time"}},q=async()=>{U.value&&(await j(),U.value.scrollTop=U.value.scrollHeight)},X=e=>{"connected"===e&&(Y(),Z(),te())},Y=()=>{r(_),s(_,e=>{if(!D.isConnected.value)return;const t=e.val();t&&(I.value=Object.entries(t).map(([e,t])=>({id:e,...t})).sort((e,t)=>t.timestamp-e.timestamp),q())},e=>{console.error("Error fetching messages:",e),l.error("Error loading messages")})},Z=()=>{r(M),s(M,e=>{if(!D.isConnected.value)return;const t=e.val();k.value=t?Object.keys(t).length:0})},ee=async()=>{if(T.value.trim()&&D.isConnected.value)try{await i(_,{text:T.value.trim(),userId:a.currentUser.id,userName:a.currentUser.name,timestamp:o()}),T.value="",await q()}catch(e){console.error("Error sending message:",e),l.error("Failed to send message. Please try again.")}},te=async()=>{try{const e=t(n,`rooms/${a.roomId}/users/${a.currentUser.id}`);await c(e,{name:a.currentUser.name,lastSeen:o()})}catch(e){console.error("Error updating presence:",e)}};return m(()=>{E.addListener(X),E.startListening()}),p(()=>{E.removeListener(X),E.stopListening(),r(_),r(M)}),(t,n)=>(v(),f("div",S,["connected"!==Q.value?(v(),f("div",{key:0,class:y([{"bg-yellow-100 border-yellow-400 text-yellow-700":"reconnecting"===Q.value,"bg-red-100 border-red-400 text-red-700":"failed"===Q.value},"px-4 py-3 rounded relative mb-4"]),role:"alert"},["reconnecting"===Q.value?(v(),f("span",$," Attempting to reconnect... ("+b(x(D).reconnectAttempts+1)+"/"+b(x(D).maxReconnectAttempts)+") ",1)):(v(),f("span",N," Connection failed. Please check your internet connection and refresh the page. "))],2)):g("",!0),h("div",F,[h("div",J,[h("h2",O,b(e.roomName),1),h("p",P,b(k.value)+" users online",1)]),h("div",{class:"flex-1 p-4 overflow-y-auto",ref_key:"messagesContainer",ref:U},[(v(!0),f(w,null,C(I.value,t=>(v(),f("div",{key:t.id,class:y(["mb-4",t.userId===e.currentUser.id?"flex justify-end":"flex justify-start"])},[h("div",{class:y(["max-w-[70%] rounded-lg p-3",t.userId===e.currentUser.id?"bg-blue-500 text-white":"bg-gray-100"])},[h("div",z,b(t.userName),1),h("div",G,b(t.text),1),h("div",V,b(W(t.timestamp)),1)],2)],2))),128))],512),h("div",B,[h("form",{onSubmit:A(ee,["prevent"]),class:"flex gap-2"},[L(h("input",{"onUpdate:modelValue":n[0]||(n[0]=e=>T.value=e),type:"text",placeholder:"Type a message...",class:"flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!x(D).isConnected.value},null,8,H),[[R,T.value]]),h("button",{type:"submit",class:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50",disabled:!x(D).isConnected.value||!T.value.trim()}," Send ",8,K)],32)])])]))}},[["__scopeId","data-v-feb609bf"]]),Q={class:"py-12"},W={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},q={__name:"Index",setup(t){var n,s,r;const o=I(),a=u(()=>{var e;return null==(e=o.props.auth)?void 0:e.user}),i=d({id:(null==(s=null==(n=a.value)?void 0:n.id)?void 0:s.toString())||"guest",name:(null==(r=a.value)?void 0:r.name)||"Guest User"});return m(()=>{}),(t,n)=>(v(),T(e,{title:"Chat"},{default:U(()=>[n[0]||(n[0]=k("ffffffffffffffff ")),h("div",Q,[h("div",W,[_(M,{"room-id":"general","room-name":"General Chat","current-user":i.value},null,8,["current-user"])])])]),_:1}))}};export{q as default};
