import{r as e,u as a,f as s,Q as l,p as t,b as o,c as r,g as c,d as i,t as d,i as n,o as u,e as m,aS as p,be as v,G as _,h as y}from"./app-Dtv5Fi9L.js";import{Q as g}from"./QSpace-D-IrDQfo.js";import{Q as f}from"./QSpinnerDots-DmqPi45h.js";import{Q as b}from"./QSpinnerGears-BZpHU5mm.js";import{Q as w}from"./QInnerLoading-BTD0-gSw.js";import{Q as h}from"./QBadge-B7PIhVlN.js";import{Q as k}from"./QTd-DkPAnXdW.js";import{Q as x}from"./QTable-DjEJtvgI.js";import{d as j}from"./date-m6OHFtOH.js";import{u as q}from"./schoolData-tlp4EjaN.js";import{f as C,a as V,k as S,I as Q,J as z,K as T,b as D,R as A,O as $,y as F,N as U,W as E,V as Y,F as R,Q as I,_ as M,a2 as O,U as L,a0 as W}from"./vendor-BWKGNkNB.js";import B from"./CSTSyncDialog-iI4ZKzWZ.js";import"./offline-BzIlwqNM.js";import"./i18n-B0T1C7j3.js";import"./ui-B7TfxbV_.js";import"./QMarkupTable-BGpv7gz2.js";import"./QSelect-BslHFD89.js";import"./rtl-Cr6c3OOr.js";import"./QLinearProgress-D6iXPeG1.js";import"./use-fullscreen-GpMU35jG.js";const N={key:0,class:"row justify-center q-pa-xl"},P={class:"row q-gutter-md q-mb-lg"},G={class:"text-h4 text-primary"},H={class:"text-h4 text-secondary"},K={class:"text-h4 text-negative"},J={class:"text-h4 text-positive"},X={key:2,class:"text-center q-pa-xl"},Z={key:3},ee={class:"row q-gutter-sm q-mb-md"},ae={class:"q-mt-md q-pa-sm bg-green-1 rounded-borders"},se={class:"text-body2 text-green-9"},le={key:0,class:"row justify-end q-mt-md"},te={key:4},oe={class:"text-caption text-grey-6"},re={key:3,class:"text-center q-pa-xl"},ce=e({__name:"CSTOverviewDialog",props:{modelValue:Boolean},emits:["update:modelValue"],setup(e,{emit:ce}){const ie=e,de=a(),ne=q(),ue=C(!1),me=C(null),pe=C(null),ve=C(!1),_e=C(!1),ye=C(!1),ge=C(!1),fe=C(!1),be=C(null),we=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"}],he=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"classes_per_week",label:"Classes/Week",field:"classes_per_week",align:"center"},{name:"actions",label:"Actions",align:"center"}],ke=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"deleted_at",label:"Deleted At",align:"center"},{name:"restore",label:"",align:"center"}],xe=V(()=>pe.value?pe.value.by_classroom.filter(e=>e.cst_count>0):[]),je=V(()=>pe.value?pe.value.by_classroom.filter(e=>e.cst_deleted_count>0):[]),qe=C({}),Ce=async()=>{var e,a;if(ne.schoolId&&ne.academicYearId){ue.value=!0,me.value=null,pe.value||(pe.value=null),ye.value=!1;try{const e=await M.post("/weekly-system/api/cst-overview",{school_id:ne.schoolId,academic_year_id:ne.academicYearId,include_deleted:_e.value});e.data.success?(pe.value=e.data.data,pe.value.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.original_classes_per_week=e.classes_per_week,e.modified=!1,e.saving=!1})}),e.data.message&&de.notify({type:"info",message:e.data.message,position:"top"})):me.value=e.data.message||"Failed to load overview"}catch(s){me.value=(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.message)||"Failed to load overview"}finally{ue.value=!1}}else me.value="School and Academic Year must be selected"},Ve=()=>{Ce()},Se=async()=>{var e,a;ge.value=!0;try{const e=[];if(pe.value&&pe.value.by_classroom&&pe.value.by_classroom.forEach(a=>{a.subjects.forEach(a=>{!a.is_deleted&&a.modified&&e.push({cst_id:a.cst_id,classes_per_week:a.classes_per_week})})}),0===e.length)return void(ge.value=!1);const a=await M.post("/weekly-system/api/cst-bulk-update-classes-per-week",{updates:e});a.data.success&&(de.notify({type:"positive",message:a.data.message,position:"top"}),await Ce())}catch(s){console.error(s),de.notify({type:"negative",message:(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.message)||"Failed to save changes",position:"top"})}finally{ge.value=!1}};return S(()=>pe.value,e=>{e&&ve.value&&e.by_classroom.forEach(e=>{e.subjects.forEach(e=>{e.is_deleted||(e.modified=e.classes_per_week!==e.original_classes_per_week)})})},{deep:!0}),S(()=>ie.modelValue,e=>{e&&(pe.value=null,me.value=null,ve.value=!1,_e.value=!1,ye.value=!1,Ce())}),(a,q)=>(z(),Q(m,{"model-value":e.modelValue,"onUpdate:modelValue":q[3]||(q[3]=e=>a.$emit("update:modelValue",e)),position:"right",maximized:""},{default:T(()=>[D(i,{style:{width:"900px","max-width":"95vw"},class:"column"},{default:T(()=>[D(s,{class:"row items-center q-pb-none bg-primary text-white"},{default:T(()=>[D(l,{name:"preview",size:"sm",class:"q-mr-sm"}),q[4]||(q[4]=A("div",{class:"text-h6"},"Subject-Teacher Assignments Overview",-1)),D(g),pe.value?(z(),Q(t,{key:0,modelValue:ve.value,"onUpdate:modelValue":q[0]||(q[0]=e=>ve.value=e),label:"Edit Mode",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):$("",!0),ve.value&&ye.value?(z(),Q(o,{key:1,color:"positive",icon:"save",label:"Save Changes",class:"q-mr-md",onClick:Se,loading:ge.value},null,8,["loading"])):$("",!0),pe.value?(z(),Q(t,{key:2,modelValue:_e.value,"onUpdate:modelValue":[q[1]||(q[1]=e=>_e.value=e),Ve],label:"Show Deleted",color:"white",dark:"",class:"q-mr-md"},null,8,["modelValue"])):$("",!0),F(D(o,{icon:"close",flat:"",round:"",dense:""},null,512),[[p]])]),_:1}),D(r),D(s,{class:"col scroll"},{default:T(()=>[ue.value&&!pe.value?(z(),U("div",N,[D(f,{size:"50px",color:"primary"}),q[5]||(q[5]=A("div",{class:"text-grey-7 q-mt-md"},"Loading data...",-1))])):me.value?(z(),Q(c,{key:1,class:"bg-negative text-white q-mb-md"},{avatar:T(()=>[D(l,{name:"error",color:"white"})]),default:T(()=>[E(" "+Y(me.value),1)]),_:1})):pe.value?(z(),U(R,{key:2},[D(w,{showing:ue.value},{default:T(()=>[D(b,{size:"50px",color:"primary"})]),_:1},8,["showing"]),ve.value||ye.value?(z(),Q(c,{key:0,class:"bg-warning text-white q-mb-lg"},{avatar:T(()=>[D(l,{name:"warning",color:"white"})]),default:T(()=>[q[6]||(q[6]=A("div",{class:"text-weight-bold"},"Modifications Active",-1)),q[7]||(q[7]=A("div",{class:"text-body2"}," Changes to classes per week may require updates to the timetable. ",-1))]),_:1})):(z(),Q(c,{key:1,class:"bg-blue-1 q-mb-lg"},{avatar:T(()=>[D(l,{name:"info",color:"blue"})]),default:T(()=>[q[8]||(q[8]=A("div",{class:"text-body2"},[E(" This shows all subject-teacher assignments for the selected school and academic year. The "),A("strong",null,"Total Expected Schedules"),E(" is how many schedule records will be created when you auto-generate. ")],-1))]),_:1})),A("div",P,[D(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",G,Y(pe.value.summary.total_classrooms),1),q[9]||(q[9]=A("div",{class:"text-caption text-grey-7"},"Classrooms",-1)),D(l,{name:"class",color:"primary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),D(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",H,Y(pe.value.summary.total_csts),1),q[10]||(q[10]=A("div",{class:"text-caption text-grey-7"},"Active Assignments",-1)),D(l,{name:"assignment",color:"secondary",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),_e.value&&pe.value.summary.total_deleted_csts>0?(z(),Q(i,{key:0,flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",K,Y(pe.value.summary.total_deleted_csts),1),q[11]||(q[11]=A("div",{class:"text-caption text-grey-7"},"Deleted",-1)),D(l,{name:"delete",color:"negative",size:"md",class:"q-mt-sm"})]),_:1})]),_:1})):$("",!0),D(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:T(()=>[D(s,{class:"text-center"},{default:T(()=>[A("div",J,Y(pe.value.summary.total_expected_schedules),1),q[13]||(q[13]=A("div",{class:"text-caption text-grey-7"},"Expected Schedules",-1)),D(l,{name:"event",color:"positive",size:"md",class:"q-mt-sm"}),D(d,null,{default:T(()=>q[12]||(q[12]=[E("Total classes_per_week across all active assignments")])),_:1})]),_:1})]),_:1})]),0!==xe.value.length||_e.value&&0!==je.value.length?$("",!0):(z(),U("div",X,[D(l,{name:"inbox",size:"64px",color:"grey-5"}),q[14]||(q[14]=A("p",{class:"text-h6 text-grey-7 q-mt-md"},"No Data Found",-1)),q[15]||(q[15]=A("p",{class:"text-grey-6"},"No subject-teacher assignments for this school and academic year",-1))])),xe.value.length>0?(z(),U("div",Z,[q[19]||(q[19]=A("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Active Assignments by Classroom",-1)),D(n,{bordered:"",separator:"",class:"rounded-borders q-mb-lg"},{default:T(()=>[(z(!0),U(R,null,I(xe.value,e=>(z(),Q(v,{key:e.classroom_id,modelValue:qe.value[e.classroom_id],"onUpdate:modelValue":a=>qe.value[e.classroom_id]=a,label:e.classroom_name,caption:`${e.cst_count} subjects → ${e.total_classes_per_week} schedule entries`,icon:"class","header-class":"bg-grey-1"},{default:T(()=>[D(i,null,{default:T(()=>[D(s,{class:"q-pa-sm"},{default:T(()=>[A("div",ee,[D(_,{dense:"",icon:"subject",color:"blue-2","text-color":"blue-9"},{default:T(()=>[E(Y(e.cst_count)+" Subjects ",1)]),_:2},1024),D(_,{dense:"",icon:"schedule",color:"green-2","text-color":"green-9"},{default:T(()=>[E(Y(e.total_classes_per_week)+" Periods/Week ",1)]),_:2},1024)]),D(x,{rows:e.subjects.filter(e=>!e.is_deleted),columns:ve.value?he:we,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":T(e=>[D(k,{props:e},{default:T(()=>[D(h,{color:"blue-2","text-color":"blue-9"},{default:T(()=>[E(Y(e.row.subject_name),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-classes_per_week":T(e=>[D(k,{props:e},{default:T(()=>[ve.value?(z(),Q(y,{key:0,modelValue:e.row.classes_per_week,"onUpdate:modelValue":a=>e.row.classes_per_week=a,modelModifiers:{number:!0},type:"number",dense:"",outlined:"",min:"1",max:"20",style:{"max-width":"80px"},class:L({"bg-yellow-1":e.row.modified}),onKeyup:O(Se,["enter"])},null,8,["modelValue","onUpdate:modelValue","class"])):(z(),Q(_,{key:1,dense:"",size:"sm",color:"green-2","text-color":"green-9"},{default:T(()=>[E(Y(e.row.classes_per_week),1)]),_:2},1024))]),_:2},1032,["props"])]),"body-cell-actions":T(e=>[D(k,{props:e},{default:T(()=>[e.row.modified?(z(),Q(o,{key:0,flat:"",dense:"",round:"",icon:"save",color:"positive",size:"sm",onClick:a=>(async e=>{var a,s;e.saving=!0;try{const a=await M.put(`/weekly-system/api/cst/${e.cst_id}/classes-per-week`,{classes_per_week:e.classes_per_week});a.data.success&&(e.original_classes_per_week=e.classes_per_week,e.modified=!1,ye.value=!0,de.notify({type:"positive",message:a.data.message,position:"top"}),await Ce())}catch(l){de.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to save",position:"top"})}finally{e.saving=!1}})(e.row),loading:e.row.saving},{default:T(()=>[D(d,null,{default:T(()=>q[16]||(q[16]=[E("Save changes")])),_:1})]),_:2},1032,["onClick","loading"])):$("",!0),D(o,{flat:"",dense:"",round:"",icon:"delete",color:"negative",size:"sm",onClick:a=>(async e=>{de.dialog({title:"Confirm Delete",message:`Are you sure you want to delete ${e.subject_name} (${e.teacher_name})? This will soft-delete the assignment. You can restore it later.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await M.delete(`/weekly-system/api/cst/${e.cst_id}`);a.data.success&&(de.notify({type:"positive",message:a.data.message,position:"top"}),await Ce())}catch(l){de.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to delete",position:"top"})}})})(e.row)},{default:T(()=>[D(d,null,{default:T(()=>q[17]||(q[17]=[E("Delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows","columns"]),A("div",ae,[q[18]||(q[18]=A("div",{class:"text-caption text-grey-7"},"Calculation:",-1)),A("div",se,[E(Y(e.cst_count)+" subjects × avg "+Y((e.total_classes_per_week/e.cst_count).toFixed(1))+" periods = ",1),A("strong",null,Y(e.total_classes_per_week)+" schedule entries",1)])]),ve.value?(z(),U("div",le,[D(o,{dense:"",unelevated:"",color:"secondary",icon:"sync_alt",label:"Sync classes/week to other classrooms",size:"sm",onClick:W(a=>(e=>{be.value=e,fe.value=!0})(e),["stop"])},null,8,["onClick"])])):$("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue","label","caption"]))),128))]),_:1})])):$("",!0),_e.value&&je.value.length>0?(z(),U("div",te,[q[21]||(q[21]=A("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Deleted Assignments",-1)),D(n,{bordered:"",separator:"",class:"rounded-borders"},{default:T(()=>[(z(!0),U(R,null,I(je.value,e=>(z(),Q(v,{key:"deleted-"+e.classroom_id,label:e.classroom_name,caption:`${e.cst_deleted_count} deleted subject(s)`,icon:"delete","header-class":"bg-red-1"},{default:T(()=>[D(i,null,{default:T(()=>[D(s,{class:"q-pa-sm"},{default:T(()=>[D(x,{rows:e.subjects.filter(e=>e.is_deleted),columns:ke,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-subject_name":T(e=>[D(k,{props:e,class:"text-strike text-grey-6"},{default:T(()=>[E(Y(e.row.subject_name),1)]),_:2},1032,["props"])]),"body-cell-teacher_name":T(e=>[D(k,{props:e,class:"text-strike text-grey-6"},{default:T(()=>[E(Y(e.row.teacher_name),1)]),_:2},1032,["props"])]),"body-cell-deleted_at":T(e=>[D(k,{props:e},{default:T(()=>{return[A("div",oe,Y((a=e.row.deleted_at,a?j.formatDate(a,"MMM D, YYYY HH:mm"):"")),1)];var a}),_:2},1032,["props"])]),"body-cell-restore":T(e=>[D(k,{props:e},{default:T(()=>[D(o,{flat:"",dense:"",round:"",icon:"restore",color:"positive",size:"sm",onClick:a=>(async e=>{de.dialog({title:"Confirm Restore",message:`Restore ${e.subject_name} (${e.teacher_name})? You may need to sync schedules afterwards.`,cancel:!0,persistent:!0}).onOk(async()=>{var a,s;try{const a=await M.post(`/weekly-system/api/cst/${e.cst_id}/restore`);a.data.success&&(ye.value=!0,de.notify({type:"positive",message:a.data.message,position:"top"}),await Ce())}catch(l){de.notify({type:"negative",message:(null==(s=null==(a=l.response)?void 0:a.data)?void 0:s.message)||"Failed to restore",position:"top"})}})})(e.row)},{default:T(()=>[D(d,null,{default:T(()=>q[20]||(q[20]=[E("Restore")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),_:2},1032,["rows"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):$("",!0)],64)):(z(),U("div",re,[D(l,{name:"preview",size:"64px",color:"grey-5"}),q[22]||(q[22]=A("p",{class:"text-h6 text-grey-7 q-mt-md"},"Ready to Load Overview",-1)),q[23]||(q[23]=A("p",{class:"text-grey-6"},"Click the button below to view subject-teacher assignments",-1)),D(o,{color:"primary",icon:"preview",label:"Load Overview",onClick:Ce,class:"q-mt-md"})]))]),_:1}),D(r),D(u,{align:"right"},{default:T(()=>[pe.value?(z(),Q(o,{key:0,flat:"",icon:"refresh",label:"Refresh",color:"primary",onClick:Ce,loading:ue.value},null,8,["loading"])):$("",!0),F(D(o,{flat:"",label:"Close",color:"grey"},null,512),[[p]])]),_:1})]),_:1}),D(B,{modelValue:fe.value,"onUpdate:modelValue":q[2]||(q[2]=e=>fe.value=e),"source-classroom":be.value,"all-classrooms":xe.value,onSynced:Ce},null,8,["modelValue","source-classroom","all-classrooms"])]),_:1},8,["model-value"]))}},[["__scopeId","data-v-cc044b50"]]);export{ce as default};
