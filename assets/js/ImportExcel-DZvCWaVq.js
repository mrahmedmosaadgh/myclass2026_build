import{_ as e}from"./SecondaryButton-WaufSYeJ.js";import{_ as t}from"./PrimaryButton-DVJXOzHH.js";import{M as a}from"./Modal-CmOIIk8g.js";import{f as l,k as s,N as r,J as u,R as n,b as o,K as i,V as d,O as c,F as v,Q as m,U as p,W as y,I as f,_ as x}from"./vendor-BWKGNkNB.js";import{read as g,utils as h}from"./xlsx-BHXqx-YI.js";import{a$ as w}from"./app-Dtv5Fi9L.js";const k={class:"p-6"},b={class:"flex justify-between items-center mb-4"},T={class:"text-lg font-medium text-gray-900"},_={class:"text-sm text-gray-500"},S={key:0,class:"overflow-x-auto mb-4"},C={class:"min-w-full divide-y divide-gray-200"},U={class:"bg-gray-50"},B={class:"bg-white divide-y divide-gray-200"},j={class:"px-6 py-4 whitespace-nowrap text-sm"},I={class:"flex justify-end space-x-2"},q={class:"p-6"},A={class:"text-lg font-medium text-gray-900 mb-4"},E={key:0,class:"mb-4"},F={class:"text-green-600 font-medium mb-2"},R={class:"text-sm text-gray-600"},$={key:1,class:"mb-4"},P={class:"text-red-600 font-medium mb-2"},W={class:"text-sm text-red-600"},M={class:"mt-6 flex justify-end space-x-2"},N={__name:"ImportExcel",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"}},emits:["imported","validation-success"],setup(N,{emit:V}){const D=N,J=V,K=l(null),O=l(!1),Q=l(!1),X=l(!1),z=l(!1),G=l([]),H=l({success:[],errors:[]}),L=l(!1),Y=l(null);s(()=>D.columns,()=>{G.value.length>0&&(G.value=G.value.map(e=>{const t={};return D.columns.forEach(a=>{t[a.key]=e.data[a.key]}),{...e,data:t}}))},{deep:!0});const Z=e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=e=>{const t=new Uint8Array(e.target.result),a=g(t,{type:"array"}),l=a.Sheets[a.SheetNames[0]],s=h.sheet_to_json(l,{header:1});s.shift(),G.value=s.filter(e=>e.length).map(e=>{const t={};return D.columns.forEach((a,l)=>{t[a.key]=e[l]}),{data:t,status:"new"}}),ee(),X.value=!0},a.readAsArrayBuffer(t)},ee=async()=>{var e,t,a;try{const l=D.columns.filter(e=>e.required).map(e=>e.key),s=await x.post(D.validateUrl,{data:G.value.map(e=>e.data),required_fields:l,columns:D.columns}),r=(null==(e=s.data.summary)?void 0:e.invalid_rows)>0||(null==(a=null==(t=s.data.summary)?void 0:t.errors)?void 0:a.length)>0;G.value=G.value.map((e,t)=>({...e,status:r?"warning":"valid"})),J("validation-success",s.data)}catch(l){console.error("Validation error:",l),G.value=G.value.map(e=>({...e,status:"error"}))}},te=async()=>{var e,t;O.value=!0,w.start();try{const e=await x.post(D.importUrl,{data:G.value.map(e=>e.data),columns:D.columns});J("imported"),H.value=e.data.results,Y.value=e.data.importId,L.value=!!D.undoUrl,X.value=!1,z.value=!0}catch(a){console.error("Import error:",a),H.value={success:[],errors:[(null==(t=null==(e=a.response)?void 0:e.data)?void 0:t.message)||"An error occurred during import"]},z.value=!0}finally{O.value=!1,w.done(),K.value.value=""}},ae=async()=>{if(Y.value&&D.undoUrl){Q.value=!0,w.start();try{await x.post(`${D.undoUrl}/${Y.value}`),L.value=!1,J("imported"),se()}catch(e){alert("Failed to undo the import")}finally{Q.value=!1,w.done()}}},le=()=>{X.value=!1,G.value=[],K.value.value=""},se=()=>{z.value=!1,H.value={success:[],errors:[]},Y.value=null,L.value=!1};return(l,s)=>(u(),r("div",null,[n("input",{type:"file",ref_key:"fileInput",ref:K,class:"hidden",accept:".xlsx,.xls",onChange:Z},null,544),o(e,{onClick:s[0]||(s[0]=e=>l.$refs.fileInput.click()),disabled:O.value,class:"relative"},{default:i(()=>[n("span",null,d(N.buttonText),1)]),_:1},8,["disabled"]),o(a,{show:X.value,onClose:le,maxWidth:"4xl"},{default:i(()=>[n("div",k,[n("div",b,[n("h3",T,d(N.previewTitle),1),n("div",_," Total Records: "+d(G.value.length),1)]),X.value?(u(),r("div",S,[n("table",C,[n("thead",U,[n("tr",null,[(u(!0),r(v,null,m(N.columns.filter(e=>!e.hidden),e=>(u(),r("th",{key:e.key,class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},d(e.label),1))),128)),s[1]||(s[1]=n("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Status ",-1))])]),n("tbody",B,[(u(!0),r(v,null,m(G.value,(e,t)=>{return u(),r("tr",{key:t},[(u(!0),r(v,null,m(N.columns.filter(e=>!e.hidden),t=>(u(),r("td",{key:t.key,class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},d(e.data[t.key]),1))),128)),n("td",j,[n("span",{class:p((a=e.status,{"text-yellow-600":"new"===a,"text-blue-600":"update"===a,"text-red-600":"error"===a}))},d(e.status),3)])]);var a}),128))])])])):c("",!0),n("div",I,[o(e,{onClick:le},{default:i(()=>[y(d(N.cancelButtonText),1)]),_:1}),o(t,{onClick:te,disabled:O.value||!G.value.length},{default:i(()=>[y(d(O.value?N.processingText:N.confirmButtonText),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"]),o(a,{show:z.value,onClose:se,maxWidth:"2xl"},{default:i(()=>[n("div",q,[n("h3",A,d(N.resultsTitle),1),H.value.success.length?(u(),r("div",E,[n("h4",F,"Success ("+d(H.value.success.length)+")",1),n("ul",R,[(u(!0),r(v,null,m(H.value.success,(e,t)=>(u(),r("li",{key:t},d(e),1))),128))])])):c("",!0),H.value.errors.length?(u(),r("div",$,[n("h4",P,"Errors ("+d(H.value.errors.length)+")",1),n("ul",W,[(u(!0),r(v,null,m(H.value.errors,(e,t)=>(u(),r("li",{key:t},d(e),1))),128))])])):c("",!0),n("div",M,[L.value?(u(),f(e,{key:0,onClick:ae,disabled:Q.value},{default:i(()=>[y(d(Q.value?N.undoingText:N.undoButtonText),1)]),_:1},8,["disabled"])):c("",!0),o(t,{onClick:se},{default:i(()=>[y(d(N.closeButtonText),1)]),_:1})])])]),_:1},8,["show"])]))}};export{N as _};
