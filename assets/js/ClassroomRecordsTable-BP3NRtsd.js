import{u as e,b as l,h as a,be as t,m as o,f as n,d as r}from"./app-BxJhpxku.js";import{Q as u}from"./QSelect-DvJQhHwY.js";import{Q as s}from"./QTd-CdMOzIxb.js";import{Q as d}from"./QTable-bfrPmXFn.js";import{f as m,r as i,a as c,k as p,o as b,_ as f,I as v,J as w,K as y,R as _,b as h,N,O as g,F as T,Q as k,am as j}from"./vendor-BWKGNkNB.js";import"./offline-BzIlwqNM.js";import"./i18n-B0T1C7j3.js";import"./ui-B7TfxbV_.js";import"./rtl-Cr6c3OOr.js";import"./QMarkupTable-FlbqetwF.js";import"./QLinearProgress-C8hggxm2.js";import"./use-fullscreen-Dx2-rb4h.js";const V={class:"row items-center q-col-gutter-md q-mb-sm"},C={class:"col"},U={class:"col-auto"},q={class:"row q-col-gutter-md"},I={class:"col-12 col-md-3"},S={class:"col-12 col-md-3"},x={class:"col-12 col-md-3"},L={class:"col-12 col-md-3"},Q={key:0,class:"q-my-sm"},R={__name:"ClassroomRecordsTable",props:{teacherId:{type:Number,required:!1},subjectId:{type:Number,required:!1},classroomId:{type:Number,required:!1},periodCode:{type:String,required:!1},date:{type:String,required:!1},yearId:{type:Number,required:!1}},emits:["record-updated","record-added","filter-changed","columns-changed"],setup(R,{emit:E}){const M=R,O=E,A=e(),$=m([]),D=m(!1),F=m(""),J=m(!0),P=m(!1),B=i({attend:null,minTotal:null,maxTotal:null}),H=[{label:"All",value:null},{label:"Present",value:1},{label:"Absent",value:0}],K=[{name:"student_name",label:"Student Name",field:e=>{var l;return(null==(l=e.student)?void 0:l.name)||e.student_name},sortable:!0},{name:"attend",label:"Attend",field:"attend",sortable:!0},{name:"book",label:"Book",field:"book"},{name:"homework",label:"Homework",field:"homework"},{name:"out_classroom",label:"Out-Class",field:"out_classroom"},{name:"turn1",label:"Turn 1",field:"turn1"},{name:"turn2",label:"Turn 2",field:"turn2"},{name:"turn3",label:"Turn 3",field:"turn3"},{name:"plus",label:"Plus",field:"plus"},{name:"minus",label:"Minus",field:"minus"},{name:"total",label:"Total",field:"total",sortable:!0},{name:"notes",label:"Notes",field:"notes"},{name:"date",label:"Date",field:"date",sortable:!0}],W=i({});function z(){const e={};K.forEach(l=>e[l.name]=W[l.name]),localStorage.setItem("classroom_records_layout",JSON.stringify(e)),O("columns-changed",e)}function G(){K.forEach(e=>W[e.name]=!0),localStorage.removeItem("classroom_records_layout"),O("columns-changed",null)}K.forEach(e=>W[e.name]=!0);const X=c(()=>K.filter(e=>W[e.name]).map(e=>({name:e.name,label:e.label,field:e.field,align:"left"}))),Y=c(()=>{let e=$.value.slice();if(F.value){const l=F.value.toLowerCase();e=e.filter(e=>{var a;return((null==(a=e.student)?void 0:a.name)||e.student_name||"").toLowerCase().includes(l)||(e.notes||"").toLowerCase().includes(l)})}return null!==B.attend&&(e=e.filter(e=>Number(e.attend)===Number(B.attend))),null!==B.minTotal&&(e=e.filter(e=>Number(e.total||0)>=Number(B.minTotal))),null!==B.maxTotal&&(e=e.filter(e=>Number(e.total||0)<=Number(B.maxTotal))),e});async function Z(){D.value=!0;try{const e={teacher_id:M.teacherId,subject_id:M.subjectId,classroom_id:M.classroomId,period_code:M.periodCode,date:M.date},l=await f.get("/api/classroom-records",{params:e});$.value=l.data.map(e=>(e.turn1=Number(e.turn1||0),e.turn2=Number(e.turn2||0),e.turn3=Number(e.turn3||0),e.plus=Number(e.plus||0),e.minus=Number(e.minus||0),e.total=e.turn1+e.turn2+e.turn3+e.plus-e.minus,e))}catch(e){console.error(e),A.notify({type:"negative",message:"Could not load records"})}finally{D.value=!1}}function ee(){O("filter-changed",{...B})}function le(){B.attend=null,B.minTotal=null,B.maxTotal=null,ee()}function ae(e,l){const a={student_name:{props:["row","col"],template:"<div>{{ row.student?.name || row.student_name }}</div>"},attend:{props:["row","col"],template:'<q-toggle dense v-model="row.attend" @input="emitUpdate" />',setup:(e,{emit:l})=>({emitUpdate:function(){l("update",e.row)}})},default_editor:{props:["row","col"],template:'<q-input dense v-model="row[col.name]" @blur="emitUpdate" />',setup:(e,{emit:l})=>({emitUpdate:function(){l("update",e.row)}})}};return"student_name"===e?a.student_name:["attend","book","homework","out_classroom"].includes(e)?a.attend:["turn1","turn2","turn3","plus","minus","notes","date"].includes(e)?a.default_editor:"total"===e?{props:["row","col"],template:"<div><strong>{{ computedTotal }}</strong></div>",computed:{computedTotal(){return Number(this.row.turn1||0)+Number(this.row.turn2||0)+Number(this.row.turn3||0)+Number(this.row.plus||0)-Number(this.row.minus||0)}}}:a.default_editor}async function te(e){e.total=Number(e.turn1||0)+Number(e.turn2||0)+Number(e.turn3||0)+Number(e.plus||0)-Number(e.minus||0);try{await f.patch(`/api/classroom-records/${e.id}`,e),O("record-updated",e)}catch(l){console.error(l),A.notify({type:"negative",message:"Could not save change"})}}function oe(){const e=X.value,l=[e.map(e=>`"${e.label}"`).join(","),...Y.value.map(l=>e.map(e=>{var a;const t="function"==typeof e.field?e.field(l):null!=(a=l[e.name])?a:"";return`"${String(t).replace(/"/g,'""')}"`}).join(","))].join("\n"),a=new Blob([l],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(a),o=document.createElement("a");o.href=t,o.download=`classroom_records_${Date.now()}.csv`,o.click(),URL.revokeObjectURL(t)}return p([()=>M.teacherId,()=>M.subjectId,()=>M.classroomId,()=>M.periodCode,()=>M.date],Z),b(()=>{!function(){try{const e=localStorage.getItem("classroom_records_layout");if(e){const l=JSON.parse(e);K.forEach(e=>{var a;return W[e.name]=null==(a=l[e.name])||a})}}catch(e){}}(),(M.teacherId||M.periodCode)&&Z()}),(e,m)=>(w(),v(r,{flat:"",bordered:"",class:"q-pa-md"},{default:y(()=>[_("div",V,[_("div",C,[h(l,{flat:"",round:"",dense:"",icon:"settings",onClick:m[0]||(m[0]=e=>J.value=!J.value)}),h(l,{flat:"",round:"",dense:"",icon:"filter_alt",onClick:m[1]||(m[1]=e=>P.value=!P.value)}),h(l,{flat:"",round:"",dense:"",icon:"download",onClick:oe,title:"Export CSV"})]),_("div",U,[h(a,{dense:"",debounce:"300",modelValue:F.value,"onUpdate:modelValue":m[2]||(m[2]=e=>F.value=e),placeholder:"Search student or notes"},null,8,["modelValue"])])]),h(t,{modelValue:P.value,"onUpdate:modelValue":m[6]||(m[6]=e=>P.value=e),icon:"tune",label:"Filters",class:"q-mb-sm"},{default:y(()=>[_("div",q,[_("div",I,[h(u,{dense:"",outlined:"",label:"Attend",modelValue:B.attend,"onUpdate:modelValue":m[3]||(m[3]=e=>B.attend=e),options:H},null,8,["modelValue"])]),_("div",S,[h(a,{dense:"",outlined:"",label:"Min Total",type:"number",modelValue:B.minTotal,"onUpdate:modelValue":m[4]||(m[4]=e=>B.minTotal=e),modelModifiers:{number:!0}},null,8,["modelValue"])]),_("div",x,[h(a,{dense:"",outlined:"",label:"Max Total",type:"number",modelValue:B.maxTotal,"onUpdate:modelValue":m[5]||(m[5]=e=>B.maxTotal=e),modelModifiers:{number:!0}},null,8,["modelValue"])]),_("div",L,[h(l,{label:"Apply Filters",onClick:ee,color:"primary"}),h(l,{flat:"",label:"Reset",onClick:le})])])]),_:1},8,["modelValue"]),h(n,{class:"q-pa-none"},{default:y(()=>[J.value?(w(),N("div",Q,[(w(),N(T,null,k(K,e=>h(o,{key:e.name,modelValue:W[e.name],"onUpdate:modelValue":l=>W[e.name]=l,label:e.label,inline:"",dense:""},null,8,["modelValue","onUpdate:modelValue","label"])),64)),h(l,{flat:"",label:"Save Layout",onClick:z}),h(l,{flat:"",label:"Reset Layout",onClick:G})])):g("",!0),h(d,{rows:Y.value,columns:X.value,"row-key":"id","virtual-scroll":"",selection:"none",class:"shadow-1"},{"body-cell":y(e=>[h(s,{props:e},{default:y(()=>[(w(),v(j(ae(e.col.name)),{row:e.row,col:e.col,onUpdate:te},null,40,["row","col"]))]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1}))}};export{R as default};
