import{u as e,c as l,h as a,ao as t,i as s,aS as o,k as u,j as i,Q as n,l as d,p as m,t as r,be as c,d as p,f as _,br as b,g as v,b as g,s as f}from"./app-DlLesFGi.js";import{Q as x}from"./QSelect-BTh0khse.js";import{Q as h}from"./QBtnToggle-iboNob1y.js";import{Q as y}from"./QBadge-IdEcTs8C.js";import{Q as V}from"./QForm-CDvMxBSt.js";import{a7 as q,f as k,k as j,a as S,af as U,N as w,J as Q,b as C,R as A,K as T,I as E,O as M,z as D,F as O,Q as P,y as F,W as I,V as z,ag as B,ah as G,_ as H}from"./vendor-BWKGNkNB.js";import{s as L}from"./i18n-B0T1C7j3.js";import R from"./QuExamQuestionSelector-dHgSXY4m.js";import"./offline-BzIlwqNM.js";import"./ui-B7TfxbV_.js";import"./rtl-Cr6c3OOr.js";import"./QSpace-BK_PGLKv.js";import"./QTd-BU_S4ffH.js";import"./QTable-BIAJAIui.js";import"./QMarkupTable-CzIo4GGA.js";import"./QLinearProgress-CX6G9yBK.js";import"./use-fullscreen-BQHoXYBI.js";import"./QuQuestionDisplay-BYjlBdAJ.js";import"./katex-DjUCNC-N.js";import"./katex-BXKQVcz-.js";const W={class:"q-pa-md"},N={key:0},J={class:"q-gutter-md q-mt-sm"},K={key:0,class:"q-pa-md bg-grey-1 rounded-borders"},X={key:0,class:"q-mt-sm row q-gutter-xs"},Y={class:"row q-gutter-md"},$={class:"row q-gutter-md q-mt-md"},Z={key:0,class:"q-mt-md"},ee={class:"row q-gutter-md"},le={key:1,class:"q-mt-md"},ae={class:"row q-gutter-md"},te={key:2,class:"q-mt-md"},se={key:0,class:"q-mt-md"},oe={class:"text-subtitle2"},ue={class:"q-mt-lg q-gutter-sm"},ie={__name:"QuExamForm",props:{subjects:Array,examTypes:Array,markCalculationMethods:Array,publishResultsTimings:Array,customGroups:Array,grades:Array,classrooms:Array,selectedSubjectId:[Number,String],exam:Object},emits:["success","cancel"],setup(ie,{emit:ne}){var de,me,re,ce,pe,_e,be,ve,ge,fe,xe,he,ye,Ve,qe,ke,je,Se,Ue,we,Qe,Ce,Ae,Te,Ee,Me,De,Oe;const Pe=e(),Fe=ie,Ie=ne,ze=q({title:(null==(de=Fe.exam)?void 0:de.title)||"",description:(null==(me=Fe.exam)?void 0:me.description)||"",subject_id:(null==(re=Fe.exam)?void 0:re.subject_id)||Fe.selectedSubjectId||null,exam_type:(null==(ce=Fe.exam)?void 0:ce.exam_type)||"quiz",custom_group:(null==(pe=Fe.exam)?void 0:pe.custom_group)||"",duration_minutes:(null==(_e=Fe.exam)?void 0:_e.duration_minutes)||60,passing_score:(null==(be=Fe.exam)?void 0:be.passing_score)||null,max_attempts:(null==(ve=Fe.exam)?void 0:ve.max_attempts)||null,mark_calculation_method:(null==(ge=Fe.exam)?void 0:ge.mark_calculation_method)||"last",start_date:(null==(fe=Fe.exam)?void 0:fe.start_date)||null,end_date:(null==(xe=Fe.exam)?void 0:xe.end_date)||null,publish_results_timing:(null==(he=Fe.exam)?void 0:he.publish_results_timing)||"immediate",bloom_distribution:(null==(ye=Fe.exam)?void 0:ye.bloom_distribution)||{remember:0,understand:0,apply:0,analyze:0,evaluate:0,create:0},question_ids:(null==(qe=null==(Ve=Fe.exam)?void 0:Ve.questions)?void 0:qe.map(e=>e.id))||[],is_published:(null==(ke=Fe.exam)?void 0:ke.is_published)||!1,total_marks:(null==(je=Fe.exam)?void 0:je.total_marks)||0,settings:(null==(Se=Fe.exam)?void 0:Se.settings)||{shuffle_questions:!1,shuffle_options:!1,allow_print:!1},target_audience:(null==(Ue=Fe.exam)?void 0:Ue.target_audience)||{roles:["student"],grade_ids:[],classroom_ids:[],user_ids:[]}}),Be=k((null==(we=Fe.exam)?void 0:we.target_audience)&&((null==(Qe=Fe.exam.target_audience.classroom_ids)?void 0:Qe.length)>0||(null==(Ce=Fe.exam.target_audience.user_ids)?void 0:Ce.length)>0)?"specific":"public"),Ge=k([]),He=k(!1),Le=(e,l,a)=>{e.length<2?a():(He.value=!0,H.get(L("qu-exams.users.search",{search:e})).then(e=>{l(()=>{Ge.value=e.data.users})}).finally(()=>{He.value=!1}))};k([]),j(Be,e=>{"public"===e?ze.target_audience={roles:["student"],grade_ids:[],classroom_ids:[],user_ids:[]}:ze.target_audience.roles=["student"]});const Re=(null==(Ae=Fe.exam)?void 0:Ae.bloom_distribution)&&Object.values(Fe.exam.bloom_distribution).some(e=>e>0)?"auto":Fe.exam?"manual":"auto",We=k(Re),Ne=k((null==(Te=Fe.exam)?void 0:Te.questions)||[]),Je=k(!1),Ke=k(!(!(null==(Ee=Fe.exam)?void 0:Ee.start_date)&&!(null==(Me=Fe.exam)?void 0:Me.end_date))),Xe=k(null===(null==(De=Fe.exam)?void 0:De.max_attempts)?"unlimited":[1,2,3].includes(null==(Oe=Fe.exam)?void 0:Oe.max_attempts)?Fe.exam.max_attempts:"custom"),Ye=k(""),$e=["remember","understand","apply","analyze","evaluate","create"],Ze=Fe.examTypes.map(e=>({value:e,label:vl(e)+("survey"===e?" (No grading)":"")})),el=[{value:"unlimited",label:"Unlimited"},{value:1,label:"1 Attempt"},{value:2,label:"2 Attempts"},{value:3,label:"3 Attempts"},{value:"custom",label:"Custom"}],ll=Fe.markCalculationMethods.map(e=>({value:e,label:"last"===e?"Last Attempt - Use the most recent attempt score":"best"===e?"Best Attempt - Use the highest score achieved":"Average - Calculate average of all attempts"})),al=Fe.publishResultsTimings.map(e=>({value:e,label:"immediate"===e?"Immediately after submission":"after_end"===e?"After exam end date":"Manual (teacher controls)"})),tl=S(()=>Object.values(ze.bloom_distribution).reduce((e,l)=>e+(l||0),0)),sl=S(()=>Ne.value.reduce((e,l)=>e+(l.marks||0),0)),ol=S(()=>!(!ze.title||ze.title.length<10)&&(!!ze.subject_id&&(("auto"!==We.value||0!==tl.value)&&(("manual"!==We.value||0!==Ne.value.length)&&!(Ke.value&&ze.start_date&&ze.end_date&&new Date(ze.end_date)<=new Date(ze.start_date)))))),ul=S(()=>!ze.title||ze.title.length<10?"Title must be at least 10 characters":ze.subject_id?"auto"===We.value&&0===tl.value?"Please specify Bloom distribution":"manual"===We.value&&0===Ne.value.length?"Please select at least one question":Ke.value&&ze.start_date&&ze.end_date&&new Date(ze.end_date)<=new Date(ze.start_date)?"End date must be after start date":"":"Subject is required"),il=()=>{ze.total_marks=2*tl.value},nl=()=>{"survey"===ze.exam_type&&(ze.passing_score=null)},dl=e=>{"unlimited"===e?ze.max_attempts=null:"custom"!==e&&(ze.max_attempts=e)},ml=e=>{e||(ze.start_date=null,ze.end_date=null)},rl=()=>{"auto"===We.value?Ne.value=[]:ze.bloom_distribution={remember:0,understand:0,apply:0,analyze:0,evaluate:0,create:0}},cl=()=>{ze.subject_id||Fe.selectedSubjectId?Je.value=!0:Pe.notify({type:"warning",message:"Please select a subject first",position:"top"})},pl=e=>{Ne.value=e,ze.question_ids=e.map(e=>e.id),ze.total_marks=sl.value},_l=()=>{Ie("cancel"),L().current("qu-exams.index")||router.visit(L("qu-exams.index"))},bl=()=>{"manual"===We.value?ze.bloom_distribution=null:ze.question_ids=[];const e=Fe.exam?L("qu-exams.update",Fe.exam.id):L("qu-exams.store"),l=Fe.exam?"put":"post";ze[l](e,{onSuccess:()=>{Pe.notify({type:"positive",message:`Exam ${Fe.exam?"updated":"created"} successfully`,position:"top"}),Ie("success")},onError:e=>{Pe.notify({type:"negative",message:"Failed to save exam. Please check the form.",caption:Object.values(e)[0],position:"top"})}})};function vl(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}function gl(e){return{remember:"psychology",understand:"lightbulb",apply:"build",analyze:"analytics",evaluate:"fact_check",create:"auto_awesome"}[e]||"help"}return(e,q)=>{const k=U("Head");return Q(),w(O,null,[C(k,{title:ie.exam?"Edit Exam":"Create Exam"},null,8,["title"]),A("div",W,[C(V,{onSubmit:bl,class:"q-gutter-md"},{default:T(()=>[q[29]||(q[29]=A("div",{class:"text-h6"},"Basic Information",-1)),C(l),C(a,{modelValue:D(ze).title,"onUpdate:modelValue":q[0]||(q[0]=e=>D(ze).title=e),label:"Exam Title *",hint:"Enter a clear, descriptive title (10-200 characters)",counter:"",maxlength:"200",rules:[e=>!!e||"Title is required",e=>e.length>=10||"Title must be at least 10 characters"]},null,8,["modelValue","rules"]),C(a,{modelValue:D(ze).description,"onUpdate:modelValue":q[1]||(q[1]=e=>D(ze).description=e),label:"Description",type:"textarea",hint:"Optional description or instructions for students",rows:"3"},null,8,["modelValue"]),ie.selectedSubjectId?M("",!0):(Q(),E(x,{key:0,modelValue:D(ze).subject_id,"onUpdate:modelValue":q[2]||(q[2]=e=>D(ze).subject_id=e),options:ie.subjects,"option-value":"id","option-label":"name",label:"Subject *","emit-value":"","map-options":"",rules:[e=>!!e||"Subject is required"]},null,8,["modelValue","options","rules"])),C(x,{modelValue:D(ze).exam_type,"onUpdate:modelValue":[q[3]||(q[3]=e=>D(ze).exam_type=e),nl],options:D(Ze),label:"Exam Type *","emit-value":"","map-options":"",rules:[e=>!!e||"Exam type is required"]},{hint:T(()=>["survey"===D(ze).exam_type?(Q(),w("div",N," Survey: For gathering information or opinions (no grading) ")):M("",!0)]),_:1},8,["modelValue","options","rules"]),C(a,{modelValue:D(ze).custom_group,"onUpdate:modelValue":q[4]||(q[4]=e=>D(ze).custom_group=e),label:"Custom Group (Optional)",hint:"Organize exams into custom categories (e.g., 'Unit 1 Tests', 'Final Exams 2026')"},{append:T(()=>[C(n,{name:"category"})]),default:T(()=>[C(t,null,{default:T(()=>[C(s,{style:{"min-width":"200px"}},{default:T(()=>[(Q(!0),w(O,null,P(ie.customGroups,e=>F((Q(),E(i,{key:e,clickable:"",onClick:l=>D(ze).custom_group=e},{default:T(()=>[C(u,null,{default:T(()=>[I(z(e),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[o]])),128))]),_:1})]),_:1})]),_:1},8,["modelValue"]),q[30]||(q[30]=A("div",{class:"text-h6 q-mt-lg"},"Who can take this exam?",-1)),C(l),A("div",J,[C(h,{modelValue:Be.value,"onUpdate:modelValue":q[5]||(q[5]=e=>Be.value=e),options:[{label:"Public (Everyone)",value:"public"},{label:"Specific Classrooms",value:"specific"}],"toggle-color":"secondary"},null,8,["modelValue"]),"specific"===Be.value?(Q(),w("div",K,[q[25]||(q[25]=A("div",{class:"text-subtitle2 q-mb-sm"},"Select Classrooms",-1)),C(x,{modelValue:D(ze).target_audience.classroom_ids,"onUpdate:modelValue":q[6]||(q[6]=e=>D(ze).target_audience.classroom_ids=e),options:ie.classrooms,"option-value":"id","option-label":"name",label:"Classrooms",multiple:"","emit-value":"","map-options":"",hint:"Select which classrooms can access this exam"},{option:T(({itemProps:e,opt:l,selected:a,toggleOption:t})=>[C(i,B(G(e)),{default:T(()=>[C(u,null,{default:T(()=>[C(d,{innerHTML:l.name},null,8,["innerHTML"]),l.grade?(Q(),E(d,{key:0,caption:""},{default:T(()=>[I("Grade: "+z(l.grade.name),1)]),_:2},1024)):M("",!0)]),_:2},1024),C(u,{side:""},{default:T(()=>[C(m,{"model-value":a,"onUpdate:modelValue":e=>t(l)},null,8,["model-value","onUpdate:modelValue"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),C(l,{class:"q-my-md"}),q[26]||(q[26]=A("div",{class:"text-subtitle2 q-mb-sm"},"Specific Students (Optional)",-1)),C(x,{modelValue:D(ze).target_audience.user_ids,"onUpdate:modelValue":q[7]||(q[7]=e=>D(ze).target_audience.user_ids=e),label:"Assign to Specific Students",multiple:"","use-input":"","fill-input":"","hide-selected":"","input-debounce":"300",options:Ge.value,"option-value":"id","option-label":"name","emit-value":"","map-options":"",onFilter:Le,hint:"Search by name or email to add individual students"},{"no-option":T(()=>[C(i,null,{default:T(()=>[C(u,{class:"text-grey"},{default:T(()=>q[24]||(q[24]=[I(" Type at least 2 characters to search ")])),_:1})]),_:1})]),option:T(({itemProps:e,opt:l,selected:a,toggleOption:t})=>[C(i,B(G(e)),{default:T(()=>[C(u,null,{default:T(()=>[C(d,null,{default:T(()=>[I(z(l.name),1)]),_:2},1024),C(d,{caption:""},{default:T(()=>[I(z(l.email)+" ("+z(l.role)+")",1)]),_:2},1024)]),_:2},1024),C(u,{side:""},{default:T(()=>[C(m,{"model-value":a,"onUpdate:modelValue":e=>t(l)},null,8,["model-value","onUpdate:modelValue"])]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"]),D(ze).target_audience.user_ids.length>0?(Q(),w("div",X,[(Q(!0),w(O,null,P(D(ze).target_audience.user_ids,e=>(Q(),E(y,{key:e,color:"primary",removable:"",onClick:l=>D(ze).target_audience.user_ids=D(ze).target_audience.user_ids.filter(l=>l!==e)},{default:T(()=>[I(" User ID: "+z(e),1)]),_:2},1032,["onClick"]))),128))])):M("",!0)])):M("",!0)]),q[31]||(q[31]=A("div",{class:"text-h6 q-mt-lg"},"Exam Settings",-1)),C(l),A("div",Y,[C(a,{modelValue:D(ze).duration_minutes,"onUpdate:modelValue":q[8]||(q[8]=e=>D(ze).duration_minutes=e),modelModifiers:{number:!0},type:"number",label:"Duration (minutes) *",hint:"How long students have to complete the exam",style:{"min-width":"200px"},rules:[e=>!!e||"Duration is required",e=>e>0||"Duration must be greater than 0"]},null,8,["modelValue","rules"]),"survey"!==D(ze).exam_type?(Q(),E(a,{key:0,modelValue:D(ze).passing_score,"onUpdate:modelValue":q[9]||(q[9]=e=>D(ze).passing_score=e),modelModifiers:{number:!0},type:"number",label:"Passing Score (%)",hint:"Minimum score to pass (optional)",style:{"min-width":"200px"},rules:[e=>null===e||""===e||e>=0&&e<=100||"Must be between 0 and 100"]},null,8,["modelValue","rules"])):M("",!0)]),A("div",$,[C(m,{modelValue:D(ze).settings.shuffle_questions,"onUpdate:modelValue":q[10]||(q[10]=e=>D(ze).settings.shuffle_questions=e),label:"Shuffle Questions",color:"primary"},null,8,["modelValue"]),C(m,{modelValue:D(ze).settings.shuffle_options,"onUpdate:modelValue":q[11]||(q[11]=e=>D(ze).settings.shuffle_options=e),label:"Shuffle Options",color:"primary"},null,8,["modelValue"]),C(m,{modelValue:D(ze).settings.allow_print,"onUpdate:modelValue":q[12]||(q[12]=e=>D(ze).settings.allow_print=e),label:"Allow Print (for practice)",color:"secondary"},{default:T(()=>[C(r,null,{default:T(()=>q[27]||(q[27]=[I(" Enable students to print this exam for offline practice ")])),_:1})]),_:1},8,["modelValue"])]),C(c,{icon:"repeat",label:"Attempt Settings","default-opened":"",class:"q-mt-lg"},{default:T(()=>[C(p,null,{default:T(()=>[C(_,null,{default:T(()=>[C(x,{modelValue:Xe.value,"onUpdate:modelValue":[q[13]||(q[13]=e=>Xe.value=e),dl],options:el,label:"Maximum Attempts","emit-value":"","map-options":""},null,8,["modelValue"]),"custom"===Xe.value?(Q(),E(a,{key:0,modelValue:D(ze).max_attempts,"onUpdate:modelValue":q[14]||(q[14]=e=>D(ze).max_attempts=e),modelModifiers:{number:!0},type:"number",label:"Custom Attempts Count",class:"q-mt-md",rules:[e=>e>0||"Must be greater than 0"]},null,8,["modelValue","rules"])):M("",!0),C(b,{modelValue:D(ze).mark_calculation_method,"onUpdate:modelValue":q[15]||(q[15]=e=>D(ze).mark_calculation_method=e),options:D(ll),label:"Final Mark Calculation",class:"q-mt-md"},null,8,["modelValue","options"])]),_:1})]),_:1})]),_:1}),C(c,{icon:"schedule",label:"Scheduling","default-opened":"",class:"q-mt-md"},{default:T(()=>[C(p,null,{default:T(()=>[C(_,null,{default:T(()=>[C(m,{modelValue:Ke.value,"onUpdate:modelValue":[q[16]||(q[16]=e=>Ke.value=e),ml],label:"Schedule exam (set start/end dates)"},null,8,["modelValue"]),Ke.value?(Q(),w("div",Z,[A("div",ee,[C(a,{modelValue:D(ze).start_date,"onUpdate:modelValue":q[17]||(q[17]=e=>D(ze).start_date=e),label:"Start Date & Time",type:"datetime-local",hint:"When exam becomes available",style:{"min-width":"250px"}},null,8,["modelValue"]),C(a,{modelValue:D(ze).end_date,"onUpdate:modelValue":q[18]||(q[18]=e=>D(ze).end_date=e),label:"End Date & Time",type:"datetime-local",hint:"Submission deadline",style:{"min-width":"250px"},rules:[e=>!D(ze).start_date||!e||new Date(e)>new Date(D(ze).start_date)||"End date must be after start date"]},null,8,["modelValue","rules"])]),C(x,{modelValue:D(ze).publish_results_timing,"onUpdate:modelValue":q[19]||(q[19]=e=>D(ze).publish_results_timing=e),options:D(al),label:"Publish Results","emit-value":"","map-options":"",class:"q-mt-md",style:{"max-width":"300px"}},null,8,["modelValue","options"])])):M("",!0)]),_:1})]),_:1})]),_:1}),q[32]||(q[32]=A("div",{class:"text-h6 q-mt-lg"},"Question Selection",-1)),C(l),C(h,{modelValue:We.value,"onUpdate:modelValue":[q[20]||(q[20]=e=>We.value=e),rl],options:[{label:"Auto-selection (Bloom)",value:"auto"},{label:"Manual Selection",value:"manual"}],"toggle-color":"primary"},null,8,["modelValue"]),"auto"===We.value?(Q(),w("div",le,[q[28]||(q[28]=A("div",{class:"text-subtitle2 q-mb-md"},"Bloom's Taxonomy Distribution",-1)),A("div",ae,[(Q(),w(O,null,P($e,e=>C(a,{key:e,modelValue:D(ze).bloom_distribution[e],"onUpdate:modelValue":[l=>D(ze).bloom_distribution[e]=l,il],modelModifiers:{number:!0},label:vl(e),type:"number",min:"0",style:{"max-width":"150px"}},{prepend:T(()=>[C(n,{name:gl(e),color:"purple"},null,8,["name"])]),_:2},1032,["modelValue","onUpdate:modelValue","label"])),64))]),tl.value>0?(Q(),E(v,{key:0,class:"bg-blue-1 q-mt-md"},{avatar:T(()=>[C(n,{name:"info",color:"blue"})]),default:T(()=>[I(" Total Questions: "+z(tl.value)+" | Estimated Marks: "+z(2*tl.value),1)]),_:1})):M("",!0),Ye.value?(Q(),E(v,{key:1,class:"bg-orange-1 q-mt-md"},{avatar:T(()=>[C(n,{name:"warning",color:"orange"})]),default:T(()=>[I(" "+z(Ye.value),1)]),_:1})):M("",!0)])):M("",!0),"manual"===We.value?(Q(),w("div",te,[C(g,{color:"secondary",label:"Select Questions",icon:"checklist",onClick:cl}),Ne.value.length>0?(Q(),w("div",se,[A("div",oe,"Selected Questions: "+z(Ne.value.length),1),C(s,{bordered:"",separator:"",class:"q-mt-sm"},{default:T(()=>[(Q(!0),w(O,null,P(Ne.value,(e,l)=>(Q(),E(i,{key:e.id},{default:T(()=>[C(u,{avatar:""},{default:T(()=>[C(f,{color:"primary","text-color":"white"},{default:T(()=>[I(z(l+1),1)]),_:2},1024)]),_:2},1024),C(u,null,{default:T(()=>[C(d,null,{default:T(()=>{return[I(z((l=e.question_text,a=80,l&&l.length>a?l.substring(0,a)+"...":l)),1)];var l,a}),_:2},1024),C(d,{caption:""},{default:T(()=>[I(z(e.marks)+" marks",1)]),_:2},1024)]),_:2},1024),C(u,{side:""},{default:T(()=>[C(g,{flat:"",dense:"",round:"",color:"negative",icon:"close",onClick:e=>(e=>{Ne.value.splice(e,1),ze.question_ids=Ne.value.map(e=>e.id),ze.total_marks=sl.value})(l)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),C(v,{class:"bg-green-1 q-mt-md"},{avatar:T(()=>[C(n,{name:"check_circle",color:"green"})]),default:T(()=>[I(" Total Marks: "+z(sl.value),1)]),_:1})])):M("",!0)])):M("",!0),A("div",ue,[C(g,{type:"submit",color:"primary",label:"Save as Draft",loading:D(ze).processing,onClick:q[21]||(q[21]=e=>D(ze).is_published=!1)},null,8,["loading"]),C(g,{type:"submit",color:"positive",label:"Publish",loading:D(ze).processing,onClick:q[22]||(q[22]=e=>D(ze).is_published=!0),disable:!ol.value},{default:T(()=>[ol.value?M("",!0):(Q(),E(r,{key:0},{default:T(()=>[I(z(ul.value),1)]),_:1}))]),_:1},8,["loading","disable"]),C(g,{flat:"",label:"Cancel",color:"negative",class:"q-ml-sm",onClick:_l})])]),_:1}),C(R,{modelValue:Je.value,"onUpdate:modelValue":q[23]||(q[23]=e=>Je.value=e),"subject-id":D(ze).subject_id||ie.selectedSubjectId,"selected-questions":Ne.value,"onUpdate:selectedQuestions":pl},null,8,["modelValue","subject-id","selected-questions"])])],64)}}};export{ie as default};
