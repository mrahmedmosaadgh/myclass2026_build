import{p as e,u as a,d as l,e as s,Q as t,a as o,f as r,n as i,C as c,h as u,m as n,b as d,aD as m,b2 as v,l as p,q as y}from"./app-BXm70mdJ.js";import{Q as g}from"./QSpace-Bu8V-QDa.js";import{Q as f}from"./QSpinnerDots-BY_P7fmL.js";import{Q as x}from"./QTd-BIxMTYzb.js";import{Q as b}from"./QTable-rnEofRem.js";import{f as _,a as h,k as w,H as k,I as q,J as j,b as S,M as z,x as C,L as Q,V,U as A,O as M,S as E,F as I,Q as F,Z as D}from"./vendor-DNM7Y6Xn.js";import"./offline-BzIlwqNM.js";import"./i18n-CBOKL2HS.js";import"./ui-BP0GJNn5.js";import"./QMarkupTable-Dmg3C5Wm.js";import"./QSelect-CnZtzPIC.js";import"./rtl-Cr6c3OOr.js";import"./QLinearProgress-Cix0cchl.js";import"./use-fullscreen-FlxrEg_V.js";const $={key:0,class:"row justify-center q-pa-xl"},T={class:"q-mb-lg"},U={class:"text-h6 q-mb-sm"},L={class:"text-caption text-grey-7"},N={class:"row q-gutter-md q-mb-lg"},O={class:"text-h4 text-positive"},B={class:"row q-gutter-sm q-mb-md"},J={key:0,class:"row q-gutter-sm q-mb-lg"},K={key:2},R={class:"text-weight-bold"},H={key:0,class:"text-caption q-mt-xs"},P={key:0},Z={key:1,class:"q-ml-md"},G={key:3,class:"text-center q-pa-xl"},W=e({__name:"ScheduleSyncDialog",props:{modelValue:Boolean,copyId:Number,copyName:String},emits:["update:modelValue","synced"],setup(e,{emit:W}){const X=e,Y=W,ee=a(),ae=_(!1),le=_(!1),se=_(null),te=_(null),oe=_([]),re=_(null),ie=[{name:"subject_name",label:"Subject",field:"subject_name",align:"left"},{name:"teacher_name",label:"Teacher",field:"teacher_name",align:"left"},{name:"expected",label:"Expected",field:"expected",align:"center"},{name:"actual",label:"Actual",field:"actual",align:"center"},{name:"status",label:"Status",align:"center"},{name:"action",label:"Fix",align:"center"}],ce=h(()=>!!te.value&&(te.value.summary.missing>0||te.value.summary.extra>0)),ue=h(()=>te.value?te.value.by_classroom.filter(e=>e.items.some(e=>"ok"!==e.status)):[]),ne=h(()=>oe.value),de=async()=>{var e,a;if(X.copyId){ae.value=!0,se.value=null,te.value=null,re.value=null;try{const e=await D.post(`/weekly-system/api/schedule-copies/${X.copyId}/sync-status`);e.data.success?te.value=e.data.data:se.value=e.data.message||"Failed to get sync status"}catch(l){se.value=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"Failed to get sync status"}finally{ae.value=!1}}},me=()=>{if(!te.value)return;const e=[];te.value.by_classroom.forEach(a=>{a.items.forEach(a=>{"missing"===a.status&&e.push({cst_id:a.cst_id,action:"create_missing"})})}),oe.value=[...e]},ve=()=>{if(!te.value)return;const e=[];te.value.by_classroom.forEach(a=>{a.items.forEach(a=>{"extra"===a.status&&e.push({cst_id:a.cst_id,action:"delete_extra"})})});const a=oe.value.map(e=>e.cst_id),l=e.filter(e=>!a.includes(e.cst_id));oe.value=[...oe.value,...l]},pe=()=>{oe.value=[]},ye=async()=>{var e,a,l,s;if(0!==ne.value.length){le.value=!0,re.value=null;try{const e=await D.post(`/weekly-system/api/schedule-copies/${X.copyId}/apply-sync`,{actions:ne.value});re.value=e.data,e.data.success&&(ee.notify({type:"positive",message:e.data.message,position:"top"}),oe.value=[],await de(),Y("synced"))}catch(t){re.value={success:!1,message:(null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||"Failed to apply fixes"},ee.notify({type:"negative",message:(null==(s=null==(l=t.response)?void 0:l.data)?void 0:s.message)||"Failed to apply fixes",position:"top"})}finally{le.value=!1}}};return w(()=>X.modelValue,e=>{e&&X.copyId&&(te.value=null,oe.value=[],se.value=null,re.value=null,de())}),(a,_)=>(q(),k(d,{"model-value":e.modelValue,"onUpdate:modelValue":_[2]||(_[2]=e=>a.$emit("update:modelValue",e)),position:"right",maximized:""},{default:j(()=>[S(i,{style:{width:"900px","max-width":"95vw"},class:"column"},{default:j(()=>[S(l,{class:"row items-center q-pb-none bg-primary text-white"},{default:j(()=>[S(s,{name:"sync",size:"sm",class:"q-mr-sm"}),_[3]||(_[3]=z("div",{class:"text-h6"},"Schedule Sync Manager",-1)),S(g),C(S(t,{icon:"close",flat:"",round:"",dense:""},null,512),[[m]])]),_:1}),S(o),S(l,{class:"col scroll"},{default:j(()=>[ae.value?(q(),Q("div",$,[S(f,{size:"50px",color:"primary"}),_[4]||(_[4]=z("div",{class:"text-grey-7 q-mt-md"},"Analyzing schedules...",-1))])):se.value?(q(),k(r,{key:1,class:"bg-negative text-white q-mb-md"},{avatar:j(()=>[S(s,{name:"error",color:"white"})]),default:j(()=>[V(" "+A(se.value),1)]),_:1})):te.value?(q(),Q(I,{key:2},[z("div",T,[z("div",U,A(te.value.copy_name),1),z("div",L,A(te.value.school_name),1)]),z("div",N,[S(i,{flat:"",bordered:"",class:"col-12 col-sm"},{default:j(()=>[S(l,{class:"text-center"},{default:j(()=>[z("div",O,A(te.value.summary.ok),1),_[5]||(_[5]=z("div",{class:"text-caption text-grey-7"},"OK",-1)),S(s,{name:"check_circle",color:"positive",size:"md",class:"q-mt-sm"})]),_:1})]),_:1}),S(i,{flat:"",bordered:"",class:E(["col-12 col-sm",{"bg-orange-1":te.value.summary.missing>0}])},{default:j(()=>[S(l,{class:"text-center"},{default:j(()=>[z("div",{class:E(["text-h4",te.value.summary.missing>0?"text-warning":"text-grey-5"])},A(te.value.summary.missing),3),_[6]||(_[6]=z("div",{class:"text-caption text-grey-7"},"Missing",-1)),S(s,{name:"arrow_downward",color:te.value.summary.missing>0?"warning":"grey-5",size:"md",class:"q-mt-sm"},null,8,["color"])]),_:1})]),_:1},8,["class"]),S(i,{flat:"",bordered:"",class:E(["col-12 col-sm",{"bg-orange-1":te.value.summary.extra>0}])},{default:j(()=>[S(l,{class:"text-center"},{default:j(()=>[z("div",{class:E(["text-h4",te.value.summary.extra>0?"text-warning":"text-grey-5"])},A(te.value.summary.extra),3),_[7]||(_[7]=z("div",{class:"text-caption text-grey-7"},"Extra",-1)),S(s,{name:"arrow_upward",color:te.value.summary.extra>0?"warning":"grey-5",size:"md",class:"q-mt-sm"},null,8,["color"])]),_:1})]),_:1},8,["class"])]),z("div",B,[S(c,{dense:"",icon:"school",color:"blue-2","text-color":"blue-9"},{default:j(()=>[V(A(te.value.summary.total_csts)+" Subject Assignments ",1)]),_:1}),S(c,{dense:"",icon:"apps",color:"grey-3","text-color":"grey-8"},{default:j(()=>[V(" Expected: "+A(te.value.summary.total_expected)+" | Actual: "+A(te.value.summary.total_actual),1)]),_:1})]),ce.value?(q(),Q("div",J,[te.value.summary.missing>0?(q(),k(t,{key:0,color:"positive",icon:"add",label:"Select All Missing",outline:"",size:"sm",onClick:me})):M("",!0),te.value.summary.extra>0?(q(),k(t,{key:1,color:"negative",icon:"remove",label:"Select All Extra",outline:"",size:"sm",onClick:ve})):M("",!0),ne.value.length>0?(q(),k(t,{key:2,flat:"",color:"grey",label:"Clear Selection",size:"sm",onClick:pe})):M("",!0)])):M("",!0),ce.value?M("",!0):(q(),k(r,{key:1,class:"bg-positive text-white q-mb-lg"},{avatar:j(()=>[S(s,{name:"check_circle",color:"white"})]),default:j(()=>[_[8]||(_[8]=V(" All schedules are in sync with the expected values! "))]),_:1})),ce.value?(q(),Q("div",K,[_[9]||(_[9]=z("div",{class:"text-subtitle2 text-grey-7 q-mb-sm"},"Classrooms with Issues",-1)),S(u,{bordered:"",separator:"",class:"rounded-borders"},{default:j(()=>[(q(!0),Q(I,null,F(ue.value,e=>(q(),k(v,{key:e.classroom_id,label:e.classroom_name,caption:`${e.items.filter(e=>"ok"!==e.status).length} issue(s)`,icon:"class","header-class":"bg-grey-1"},{default:j(()=>[S(i,null,{default:j(()=>[S(l,{class:"q-pa-sm"},{default:j(()=>[S(b,{rows:e.items.filter(e=>"ok"!==e.status),columns:ie,"row-key":"cst_id",dense:"",flat:"","rows-per-page-options":[0],"hide-bottom":""},{"body-cell-status":j(e=>[S(x,{props:e},{default:j(()=>["missing"===e.row.status?(q(),k(s,{key:0,name:"arrow_downward",color:"warning",size:"sm"},{default:j(()=>[S(y,null,{default:j(()=>[V("Missing "+A(Math.abs(e.row.diff))+" record(s)",1)]),_:2},1024)]),_:2},1024)):"extra"===e.row.status?(q(),k(s,{key:1,name:"arrow_upward",color:"warning",size:"sm"},{default:j(()=>[S(y,null,{default:j(()=>[V(A(e.row.diff)+" extra record(s)",1)]),_:2},1024)]),_:2},1024)):M("",!0)]),_:2},1032,["props"])]),"body-cell-action":j(e=>[S(x,{props:e},{default:j(()=>["missing"===e.row.status?(q(),k(p,{key:0,modelValue:oe.value,"onUpdate:modelValue":_[0]||(_[0]=e=>oe.value=e),val:{cst_id:e.row.cst_id,action:"create_missing"},color:"positive",dense:""},{default:j(()=>[S(y,null,{default:j(()=>[V("Create "+A(Math.abs(e.row.diff))+" missing record(s)",1)]),_:2},1024)]),_:2},1032,["modelValue","val"])):"extra"===e.row.status?(q(),k(p,{key:1,modelValue:oe.value,"onUpdate:modelValue":_[1]||(_[1]=e=>oe.value=e),val:{cst_id:e.row.cst_id,action:"delete_extra"},color:"negative",dense:""},{default:j(()=>[S(y,null,{default:j(()=>[V("Delete "+A(e.row.diff)+" extra record(s)",1)]),_:2},1024)]),_:2},1032,["modelValue","val"])):M("",!0)]),_:2},1032,["props"])]),_:2},1032,["rows"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label","caption"]))),128))]),_:1})])):M("",!0),re.value?(q(),k(r,{key:3,class:E(["q-mt-lg",re.value.success?"bg-positive text-white":"bg-negative text-white"])},{avatar:j(()=>[S(s,{name:re.value.success?"check_circle":"error",color:"white"},null,8,["name"])]),default:j(()=>[z("div",R,A(re.value.message),1),re.value.results?(q(),Q("div",H,[re.value.results.created?(q(),Q("span",P,"Created: "+A(re.value.results.created),1)):M("",!0),re.value.results.deleted?(q(),Q("span",Z,"Deleted: "+A(re.value.results.deleted),1)):M("",!0)])):M("",!0)]),_:1},8,["class"])):M("",!0)],64)):(q(),Q("div",G,[S(s,{name:"sync",size:"64px",color:"grey-5"}),_[10]||(_[10]=z("p",{class:"text-h6 text-grey-7 q-mt-md"},"Ready to Check Sync Status",-1)),_[11]||(_[11]=z("p",{class:"text-grey-6"},"Click the button below to analyze schedule synchronization",-1)),S(t,{color:"primary",icon:"sync",label:"Check Sync Status",onClick:de,class:"q-mt-md"})]))]),_:1}),S(o),S(n,{align:"right"},{default:j(()=>[te.value&&ce.value?(q(),k(t,{key:0,flat:"",icon:"refresh",label:"Refresh",color:"primary",onClick:de,loading:ae.value},null,8,["loading"])):M("",!0),ne.value.length>0?(q(),k(t,{key:1,color:"primary",icon:"check",label:`Apply ${ne.value.length} Fix(es)`,onClick:ye,loading:le.value},null,8,["label","loading"])):M("",!0),C(S(t,{flat:"",label:"Close",color:"grey"},null,512),[[m]])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},[["__scopeId","data-v-978dee47"]]);export{W as default};
