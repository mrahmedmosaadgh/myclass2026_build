import{_ as e}from"./AppLayout-BwFE-B4r.js";import{f as t,o,N as r,J as i,Q as a,O as s,V as n,z as c,F as l,W as u,U as d,I as h,K as p,b}from"./vendor-BJyC5yAd.js";function g(){const e=t(!1),o=t(null),r=e=>{const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),o=window.atob(t),r=new Uint8Array(o.length);for(let i=0;i<o.length;++i)r[i]=o.charCodeAt(i);return r},i=async e=>{var t;try{console.log("Saving subscription to backend:",e);const o=null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content"),r=await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":o,Accept:"application/json"},body:JSON.stringify(e),credentials:"same-origin"});if(!r.ok){const e=await r.json();throw console.error("Server error:",e),new Error(e.message||"Failed to save subscription")}const i=await r.json();return console.log("Subscription saved successfully:",i),i}catch(o){throw console.error("Failed to save subscription:",o),o}};return{isSubscribed:e,subscription:o,setupPushNotifications:async()=>{try{if("granted"===await Notification.requestPermission()){const t=await(async()=>{try{const e=await navigator.serviceWorker.getRegistration();if(e)return e;const t=await navigator.serviceWorker.register("/sw.js",{scope:"/"});return await navigator.serviceWorker.ready,t}catch(e){throw console.error("Service Worker registration failed:",e),e}})();return await(async t=>{try{const a=await fetch("/vapid/public-key",{headers:{Accept:"text/plain"}});if(!a.ok)throw new Error("Failed to get VAPID public key");const s=await a.text();if(!s||0===s.length)throw new Error("Invalid VAPID public key");console.log("Using VAPID public key:",s);const n={userVisibleOnly:!0,applicationServerKey:r(s)},c=await t.pushManager.subscribe(n);return o.value=c,await i(c),e.value=!0,c}catch(a){if(console.error("Failed to subscribe to push:",a),"NotAllowedError"===a.name)throw new Error("Please allow notifications in your browser settings");throw a}})(t),!0}return!1}catch(t){return console.error("Failed to setup push notifications:",t),!1}},checkSubscription:async()=>{try{const t=await navigator.serviceWorker.ready,o=await t.pushManager.getSubscription();return e.value=!!o,o.value=o,o}catch(t){return console.error("Failed to check subscription:",t),null}}}}const v={key:0,class:"mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded"},w=["disabled"],f={key:1,class:"mt-2 text-sm text-red-600"},y={__name:"PushNotificationSubscribe",setup(e){const{isSubscribed:h,setupPushNotifications:p,checkSubscription:b}=g(),y=t(null),m=t("serviceWorker"in navigator),k=async()=>{var e;if(console.log("handlePushNotifications"),y.value=null,"serviceWorker"in navigator){const e=await navigator.serviceWorker.getRegistration();if(console.log("Service Worker Registration:",e),!e)return void(y.value="Service Worker not registered. Try refreshing the page.")}try{if(!m.value)throw new Error("Push notifications are not supported in your browser");if(h.value){const t=await navigator.serviceWorker.ready,o=await t.pushManager.getSubscription();o&&(await o.unsubscribe(),await fetch("/push/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":null==(e=document.querySelector('meta[name="csrf-token"]'))?void 0:e.getAttribute("content")},body:JSON.stringify({endpoint:o.endpoint})}),h.value=!1)}else await p()}catch(t){console.error("Push notification error:",t),y.value=t.message||"Failed to handle push notifications"}};return o(async()=>{if(m.value)try{await b()}catch(e){console.error("Failed to check subscription status:",e),y.value="Failed to check notification status"}}),(e,t)=>(i(),r("div",null,[y.value?(i(),r("div",v,n(y.value),1)):a("",!0),s("button",{onClick:k,class:d(["inline-flex items-center px-4 py-2 rounded-md font-semibold text-sm",c(h)?"bg-red-600 text-white hover:bg-red-500":"bg-blue-600 text-white hover:bg-primary-500",m.value?"":"opacity-50 cursor-not-allowed"]),disabled:!m.value},[c(h)?(i(),r(l,{key:0},[u(" Disable Push Notifications ")],64)):(i(),r(l,{key:1},[u(" Enable Push Notifications ")],64))],10,w),m.value?a("",!0):(i(),r("div",f," Your browser doesn't support push notifications "))]))}},m={class:"py-12"},k={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},x={class:"bg-white overflow-hidden shadow-xl sm:rounded-lg p-6"},S={__name:"Settings",setup:t=>(t,o)=>(i(),h(e,{title:"Notifications"},{header:p(()=>o[0]||(o[0]=[s("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"}," Push Notifications ",-1)])),default:p(()=>[s("div",m,[s("div",k,[s("div",x,[o[1]||(o[1]=s("div",{class:"text-gray-700 mb-4"},[s("h3",{class:"font-semibold text-lg mb-2"},"Push Notification Settings"),s("p",{class:"mb-4"},"Enable push notifications to stay updated with important events and messages.")],-1)),b(y),o[2]||(o[2]=s("div",{class:"mt-6 text-sm text-gray-500"},[s("p",null,"Once enabled, you'll receive notifications even when the browser is closed."),s("p",{class:"mt-2"},"You can disable notifications at any time through your browser settings or by clicking the button above.")],-1))])])])]),_:1}))};export{S as default};
