import{M as e}from"./Modal-DbZxSkDc.js";import{o as t,aU as r}from"./app-tFXAu5dG.js";import{f as s,k as l,N as a,J as o,O as n,b as i,V as u,a0 as d,U as c,K as p,Q as v,F as m,R as f,W as g,_ as x}from"./vendor-nQjeLEvd.js";import{r as y,u as h}from"./xlsx-cMC2LkxH.js";import"./offline-BzIlwqNM.js";import"./i18n-kquWfmcz.js";import"./ui-Bfjdq-TR.js";const w={class:"flex flex-col items-center justify-center space-y-3 cursor-pointer"},b={class:"text-lg font-medium text-gray-700"},k={class:"p-6"},C={class:"flex justify-between items-center mb-4"},S={class:"text-lg font-medium text-gray-900"},T={class:"text-sm text-gray-500"},j={key:0,class:"overflow-x-auto mb-6 rounded-lg border border-gray-200 shadow"},B={class:"min-w-full divide-y divide-gray-200"},E={class:"bg-blue-50"},U={key:0,class:"text-red-500 ml-1"},A={class:"bg-white divide-y divide-gray-200"},_={key:0},I={key:1,class:"text-gray-400 italic"},z={class:"px-6 py-4 whitespace-nowrap text-sm"},M={class:"flex justify-end space-x-3"},q=["disabled"],D={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},V={class:"p-6"},R={class:"flex items-center justify-between mb-6"},$={class:"text-xl font-semibold text-gray-900"},F={key:0,class:"mb-6 bg-green-50 border border-green-200 rounded-lg p-4"},L={class:"flex items-center mb-3"},P={class:"text-green-800 font-medium"},W={class:"pl-7"},H={class:"text-sm text-green-700 space-y-1 max-h-40 overflow-y-auto"},N={key:1,class:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4"},O={class:"flex items-center mb-3"},J={class:"text-red-800 font-medium"},K={class:"pl-7"},Q={class:"text-sm text-red-700 space-y-1 max-h-40 overflow-y-auto"},G={class:"mt-6 flex justify-end space-x-3"},X=["disabled"],Y={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 text-red-700",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Z={key:1,class:"-ml-1 mr-2 h-4 w-4 text-red-700",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},ee=t({__name:"ImportExcel",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"}},emits:["imported","validation-success","validation-error"],setup(t,{emit:ee}){const te=t,re=ee,se=s(null),le=s(!1),ae=s(!1),oe=s(!1),ne=s(!1),ie=s([]),ue=s({success:[],errors:[]}),de=s(!1),ce=s(null),pe=s(!1);l(()=>te.columns,()=>{ie.value.length>0&&(ie.value=ie.value.map(e=>{const t={};return te.columns.forEach(r=>{t[r.key]=e.data[r.key]}),{...e,data:t}}))},{deep:!0});const ve=e=>{if(!e)return;const t=new FileReader;t.onload=e=>{const t=new Uint8Array(e.target.result),r=y(t,{type:"array"}),s=r.Sheets[r.SheetNames[0]],l=h.sheet_to_json(s,{header:1});l.shift(),ie.value=l.filter(e=>e.length).map(e=>{const t={};return te.columns.forEach((r,s)=>{t[r.key]=e[s]}),{data:t,status:"new"}}),ge(),oe.value=!0},t.readAsArrayBuffer(e)},me=e=>{const t=e.target.files[0];ve(t)},fe=e=>{pe.value=!1;const t=e.dataTransfer.files[0];ve(t)},ge=async()=>{try{const e=te.columns.filter(e=>e.required).map(e=>e.key),t=ie.value.map(e=>{const t={};return te.columns.forEach(r=>{let s=e.data[r.key];null==s&&(s=""),t[r.key]=String(s).trim()}),t}),r=[],s=t.map(()=>"valid");if(t.forEach((t,l)=>{e.forEach(e=>{t[e]&&""!==String(t[e]).trim()||(r.push(`Row ${l+1}: Missing required field '${e}'`),s[l]="error")})}),ie.value=ie.value.map((e,t)=>({...e,status:s[t]})),r.length)return ue.value={success:[],errors:r},ne.value=!0,void console.warn("Local validation prevented server call:",r);const l={data:t,required_fields:e,columns:te.columns};console.debug("validatePreviewData payload:",l);const a=await x.post(te.validateUrl,l);ie.value=ie.value.map((e,t)=>({...e,status:a.data.stats.invalid_rows>0?"warning":"valid"})),re("validation-success",a.data)}catch(e){console.error("Validation error:",e);const t=[];if(e.response&&e.response.data){const r=e.response.data;r.message&&t.push(r.message),r.errors&&(Array.isArray(r.errors)?r.errors.forEach(e=>t.push(e)):Object.values(r.errors).forEach(e=>{Array.isArray(e)?e.forEach(e=>t.push(e)):t.push(String(e))}))}else t.push("Validation failed.");ue.value={success:[],errors:t},ne.value=!0}},xe=async()=>{var e,t;le.value=!0,r.start();try{const e=await x.post(te.importUrl,{data:ie.value.map(e=>e.data),columns:te.columns});re("imported"),ue.value=e.data.results,ce.value=e.data.importId,de.value=!!te.undoUrl,oe.value=!1,ne.value=!0}catch(s){console.error("Import error:",s),ue.value={success:[],errors:[(null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"An error occurred during import"]},ne.value=!0}finally{le.value=!1,r.done(),se.value.value=""}},ye=async()=>{if(ce.value&&te.undoUrl){ae.value=!0,r.start();try{await x.post(`${te.undoUrl}/${ce.value}`),de.value=!1,re("imported"),we()}catch(e){alert("Failed to undo the import")}finally{ae.value=!1,r.done()}}},he=()=>{oe.value=!1,ie.value=[],se.value.value=""},we=()=>{ne.value=!1,ue.value={success:[],errors:[]},ce.value=null,de.value=!1};return(r,s)=>(o(),a("div",null,[n("input",{type:"file",ref_key:"fileInput",ref:se,class:"hidden",accept:".xlsx,.xls",onChange:me},null,544),n("div",{class:c(["border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors duration-200",{"border-blue-500 bg-blue-50":pe.value}]),onDragover:s[0]||(s[0]=d(e=>pe.value=!0,["prevent"])),onDragleave:s[1]||(s[1]=d(e=>pe.value=!1,["prevent"])),onDrop:d(fe,["prevent"]),onClick:s[2]||(s[2]=e=>r.$refs.fileInput.click())},[n("div",w,[s[3]||(s[3]=n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})],-1)),n("div",b,u(t.buttonText),1),s[4]||(s[4]=n("p",{class:"text-sm text-gray-500"},"Drag and drop your Excel file here, or click to browse",-1)),s[5]||(s[5]=n("div",{class:"text-xs text-gray-400"},"Supported formats: .xlsx, .xls",-1))])],34),i(e,{show:oe.value,onClose:he,maxWidth:"4xl"},{default:p(()=>[n("div",k,[n("div",C,[n("h3",S,u(t.previewTitle),1),n("div",T," Total Records: "+u(ie.value.length),1)]),oe.value?(o(),a("div",j,[n("table",B,[n("thead",E,[n("tr",null,[(o(!0),a(m,null,f(t.columns.filter(e=>!e.hidden),e=>(o(),a("th",{key:e.key,class:"px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider"},[g(u(e.label)+" ",1),e.required?(o(),a("span",U,"*")):v("",!0)]))),128)),s[6]||(s[6]=n("th",{class:"px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider"}," Status ",-1))])]),n("tbody",A,[(o(!0),a(m,null,f(ie.value,(e,r)=>(o(),a("tr",{key:r,class:"hover:bg-gray-50 transition-colors duration-150"},[(o(!0),a(m,null,f(t.columns.filter(e=>!e.hidden),t=>(o(),a("td",{key:t.key,class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},[e.data[t.key]?(o(),a("span",_,u(e.data[t.key]),1)):(o(),a("span",I,"Empty"))]))),128)),n("td",z,[n("span",{class:c({"px-2 py-1 rounded-full text-xs font-medium":!0,"bg-green-100 text-green-800":"valid"===e.status,"bg-yellow-100 text-yellow-800":"warning"===e.status||"new"===e.status,"bg-red-100 text-red-800":"error"===e.status})},u(e.status),3)])]))),128))])])])):v("",!0),n("div",M,[n("button",{onClick:he,class:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"},u(t.cancelButtonText),1),n("button",{onClick:xe,disabled:le.value||!ie.value.length,class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"},[le.value?(o(),a("svg",D,s[7]||(s[7]=[n("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),n("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):v("",!0),g(" "+u(le.value?t.processingText:t.confirmButtonText),1)],8,q)])])]),_:1},8,["show"]),i(e,{show:ne.value,onClose:we,maxWidth:"2xl"},{default:p(()=>[n("div",V,[n("div",R,[n("h3",$,u(t.resultsTitle),1),s[8]||(s[8]=n("div",{class:"bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full"}," Import Complete ",-1))]),ue.value.success.length?(o(),a("div",F,[n("div",L,[s[9]||(s[9]=n("svg",{class:"w-5 h-5 text-green-500 mr-2",fill:"currentColor",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),n("h4",P,"Success ("+u(ue.value.success.length)+")",1)]),n("div",W,[n("ul",H,[(o(!0),a(m,null,f(ue.value.success,(e,t)=>(o(),a("li",{key:t,class:"flex items-start"},[s[10]||(s[10]=n("span",{class:"mr-1"},"•",-1)),n("span",null,u(e),1)]))),128))])])])):v("",!0),ue.value.errors.length?(o(),a("div",N,[n("div",O,[s[11]||(s[11]=n("svg",{class:"w-5 h-5 text-red-500 mr-2",fill:"currentColor",viewBox:"0 0 20 20",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),n("h4",J,"Errors ("+u(ue.value.errors.length)+")",1)]),n("div",K,[n("ul",Q,[(o(!0),a(m,null,f(ue.value.errors,(e,t)=>(o(),a("li",{key:t,class:"flex items-start"},[s[12]||(s[12]=n("span",{class:"mr-1"},"•",-1)),n("span",null,u(e),1)]))),128))])])])):v("",!0),n("div",G,[de.value?(o(),a("button",{key:0,onClick:ye,disabled:ae.value,class:"px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"},[ae.value?(o(),a("svg",Y,s[13]||(s[13]=[n("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),n("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(o(),a("svg",Z,s[14]||(s[14]=[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"},null,-1)]))),g(" "+u(ae.value?t.undoingText:t.undoButtonText),1)],8,X)):v("",!0),n("button",{onClick:we,class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},u(t.closeButtonText),1)])])]),_:1},8,["show"])]))}},[["__scopeId","data-v-3a4f46fb"]]);export{ee as default};
