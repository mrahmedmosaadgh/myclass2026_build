import{a as e,_ as t,f as a,k as s,o as n,M as l,J as o,b as r,N as i,z as d,a4 as c,an as u,U as f,V as g,Q as h,F as v,R as p}from"./vendor-DuKqz2x4.js";import{dbUtils as m,db as x}from"./dexie-BZxkfQNE.js";import{queueRequest as y,processQueue as b,SYNC_PRIORITIES as w,getSyncQueueStats as S}from"./syncQueue-C9lwhkfP.js";import{b4 as k,o as O,b2 as _}from"./app-CqJgtQaN.js";import"./import-wrapper-prod-rGyr_SDZ.js";import"./offline-BzIlwqNM.js";import"./i18n-DE5KxGn8.js";import"./ui-BITzTqrO.js";const T=k(),q=e(()=>T.isOnline),D=e(()=>T.lastOnlineTime),C=a("good");function E(){console.log("ðŸŒ Network: Back online"),T.updateOnlineStatus(!0),C.value="good",b().then(e=>{e.processed>0&&console.log(`âœ… Processed ${e.processed} queued requests`)}).catch(e=>{console.error("âŒ Error processing queue:",e)})}function R(){console.log("ðŸ“´ Network: Gone offline"),T.updateOnlineStatus(!1),C.value="poor"}function $(){if(!navigator.onLine)return void T.updateOnlineStatus(!1);const e=Date.now();fetch("/api/health-check",{method:"HEAD",cache:"no-cache",timeout:5e3}).then(t=>{const a=Date.now()-e;t.ok?(T.updateOnlineStatus(!0),C.value=a<500?"good":a<2e3?"slow":"poor"):T.updateOnlineStatus(!1)}).catch(()=>{T.updateOnlineStatus(!1),C.value="poor"})}e(()=>({online:q.value,lastOnline:D.value,quality:C.value,statusText:q.value?"Online":"Offline"}));const I="/api",A=1e4,M=3,j=1e3,L=t.create({baseURL:I,timeout:A,headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});function P(e,t,a=null,s={}){const n={method:e.toUpperCase(),url:t,data:a,...s};return q.value?N(n).then(e=>(q.value||E(),e.data)).catch(n=>{if(U(n))return console.log("ðŸ“¤ Network error, queuing request:",e,t),y(e,t,a,s).then(()=>{throw new F("Request queued for later sync",{method:e,url:t,data:a})});throw n}):(console.log("ðŸ“´ Offline, queuing request:",e,t),y(e,t,a,s).then(()=>{throw new F("Request queued for later sync",{method:e,url:t,data:a})}))}function N(e,t=1){return L(e).catch(a=>{if(t<M&&function(e){if(U(e))return!0;if(e.response){const t=e.response.status;return t>=500||408===t||429===t}return!1}(a))return console.log(`ðŸ”„ Retrying request (attempt ${t+1}):`,e.url),new Promise(a=>{setTimeout(()=>{a(N(e,t+1))},j*t)});throw a})}function U(e){return!e.response||"NETWORK_ERROR"===e.code||"ECONNABORTED"===e.code||e.message.includes("Network Error")}L.interceptors.request.use(e=>{var t;const a=null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content");return a&&(e.headers["X-CSRF-TOKEN"]=a),e}),L.interceptors.response.use(e=>e,e=>(e.response||T.updateOnlineStatus(!1),Promise.reject(e)));class F extends Error{constructor(e,t){super(e),this.name="OfflineError",this.requestInfo=t,this.isOfflineError=!0}}const z={get:(e,t={},a={})=>P("GET",e,null,{params:t,...a}),post:(e,t={},a={})=>P("POST",e,t,a),put:(e,t={},a={})=>P("PUT",e,t,a),delete:(e,t={})=>P("DELETE",e,null,t),patch:(e,t={},a={})=>P("PATCH",e,t,a)};function B(t,n={}){if(!m.resourceExists(t))throw new Error(`Resource '${t}' does not exist in database schema`);const l={syncPriority:w.MEDIUM,cacheDuration:36e5,maxCacheSize:1e3,offlineCapabilities:["read","create","update","delete"],autoSync:!0,optimisticUpdates:!0,...n},o=a([]),r=a(!1),i=a(null),d=a(null),c=a(!1),u=e(()=>0===o.value.length),f=e(()=>o.value.length>0),g=e(()=>!d.value||Date.now()-d.value.getTime()>l.cacheDuration),h=e(()=>c.value?"syncing":i.value?"error":g.value?"stale":"synced"),v=e(()=>x.getDirtyRecords(t).then(e=>e.length>0).catch(()=>!1));function p(e={}){const{forceRefresh:a=!1,includeDeleted:s=!1}=e;return r.value=!0,i.value=null,q.value&&(a||!f.value||g.value)?z.get(`/${t.replace(/_/g,"-")}`).then(e=>function(e){return x[t].clear().then(()=>{if(e.length>0)return x[t].bulkAdd(e.map(e=>({...e,is_dirty:!1,synced_at:(new Date).toISOString()})))})}(e).then(()=>(o.value=e,d.value=new Date,e))).catch(e=>(console.warn("Server load failed, falling back to cache:",e),k(s))).finally(()=>{r.value=!1}):k(s).finally(()=>{r.value=!1})}function S(){return c.value=!0,b().then(e=>e.processed>0?p({forceRefresh:!0}):e).finally(()=>{c.value=!1})}function k(e=!1){let a=x[t].toArray();return e||(a=x[t].where("deleted_at").equals(void 0).toArray()),a.then(e=>(o.value=e,d.value=new Date,e))}return l.autoSync&&s(q,e=>{e&&!c.value&&S().catch(e=>{console.warn("Auto-sync failed:",e)})}),{data:o,loading:r,error:i,lastLoadTime:d,isEmpty:u,hasData:f,isStale:g,syncStatus:h,hasUnsyncedChanges:v,loadAll:p,loadById:function(e,a={}){const{forceRefresh:s=!1}=a;return r.value=!0,i.value=null,x[t].get(e).then(a=>{if(a&&!s)return r.value=!1,a;if(q.value)return z.get(`/${t.replace(/_/g,"-")}/${e}`).then(e=>x[t].put(e).then(()=>e)).catch(e=>{if(a)return console.warn("Server load failed, using cached version:",e),a;throw e});if(a)return a;throw new F("Item not available offline",{id:e})}).finally(()=>{r.value=!1})},create:function(e,a={}){const{optimistic:s=l.optimisticUpdates}=a;if(!l.offlineCapabilities.includes("create"))throw new Error(`Create operation not allowed offline for ${t}`);r.value=!0,i.value=null;const n=`temp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d={...e,id:n};return s&&o.value.unshift(d),x[t].add(d).then(a=>q.value?z.post(`/${t.replace(/_/g,"-")}`,e).then(e=>x[t].update(a,{...e,is_dirty:!1,synced_at:(new Date).toISOString()}).then(()=>{if(s){const t=o.value.findIndex(e=>e.id===n);-1!==t&&(o.value[t]=e)}return e})).catch(a=>(console.warn("Server create failed, queued for sync:",a),a instanceof F?d:y("POST",`/${t.replace(/_/g,"-")}`,e,{priority:l.syncPriority}).then(()=>d))):d).catch(e=>{if(s){const e=o.value.findIndex(e=>e.id===n);-1!==e&&o.value.splice(e,1)}throw i.value=e,e}).finally(()=>{r.value=!1})},update:function(e,a,s={}){const{optimistic:n=l.optimisticUpdates,merge:d=!0}=s;if(!l.offlineCapabilities.includes("update"))throw new Error(`Update operation not allowed offline for ${t}`);return r.value=!0,i.value=null,x[t].get(e).then(s=>{if(!s)throw new Error(`Item with ID ${e} not found`);const r=d?{...s,...a}:a;if(r.id=e,n){const t=o.value.findIndex(t=>t.id===e);-1!==t&&(o.value[t]=r)}return x[t].put(r).then(()=>q.value?z.put(`/${t.replace(/_/g,"-")}/${e}`,a).then(a=>x[t].update(e,{...a,is_dirty:!1,synced_at:(new Date).toISOString()}).then(()=>{if(n){const t=o.value.findIndex(t=>t.id===e);-1!==t&&(o.value[t]=a)}return a})).catch(s=>(console.warn("Server update failed, queued for sync:",s),s instanceof F||y("PUT",`/${t.replace(/_/g,"-")}/${e}`,a,{priority:l.syncPriority}),r)):r)}).catch(e=>{throw i.value=e,e}).finally(()=>{r.value=!1})},delete:function(e,a={}){const{soft:s=!0,optimistic:n=l.optimisticUpdates}=a;if(!l.offlineCapabilities.includes("delete"))throw new Error(`Delete operation not allowed offline for ${t}`);r.value=!0,i.value=null;let d=null,c=-1;return n&&(c=o.value.findIndex(t=>t.id===e),-1!==c&&(d=o.value.splice(c,1)[0])),(s?x[t].update(e,{deleted_at:(new Date).toISOString(),is_dirty:!0}):x[t].delete(e)).then(()=>!q.value||z.delete(`/${t.replace(/_/g,"-")}/${e}`).then(()=>!s||x[t].update(e,{is_dirty:!1,synced_at:(new Date).toISOString()})).catch(a=>(console.warn("Server delete failed, queued for sync:",a),a instanceof F||y("DELETE",`/${t.replace(/_/g,"-")}/${e}`,null,{priority:l.syncPriority}),!0))).catch(e=>{throw n&&d&&-1!==c&&o.value.splice(c,0,d),i.value=e,e}).finally(()=>{r.value=!1})},sync:S,clearCache:function(){return x.clearResource(t).then(()=>{o.value=[],d.value=null})},isOnline:q,config:l}}window.addEventListener("online",E),window.addEventListener("offline",R),setInterval($,3e4),$(),s(q,e=>{console.log("ðŸŒ Network status changed: "+(e?"Online":"Offline"))});const Q={class:"offline-test-page max-w-4xl mx-auto p-6"},G={class:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"},H={class:"flex items-center"},W={class:"flex-shrink-0"},X={class:"text-white text-sm"},K={class:"ml-4"},J={class:"bg-white rounded-lg shadow p-6 border-l-4 border-blue-500"},V={class:"flex items-center"},Y={class:"ml-4"},Z={class:"text-blue-600 font-medium"},ee={class:"flex items-center"},te={class:"flex-shrink-0"},ae={class:"text-white text-sm"},se={class:"ml-4"},ne={class:"bg-white rounded-lg shadow p-6 mb-8"},le={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},oe=["disabled"],re={class:"grid grid-cols-1 lg:grid-cols-2 gap-8"},ie={class:"bg-white rounded-lg shadow"},de={class:"px-6 py-4 border-b border-gray-200"},ce={class:"flex justify-between items-center"},ue={class:"text-lg font-medium text-gray-900"},fe=["disabled"],ge={class:"p-6"},he={key:0,class:"text-center py-4"},ve={key:1,class:"text-center py-4 text-gray-500"},pe={key:2,class:"space-y-3"},me={class:"flex justify-between items-start"},xe={class:"flex-1"},ye={class:"font-medium text-sm"},be={class:"text-xs text-gray-600 mt-1"},we={class:"text-xs text-gray-500 mt-1"},Se={class:"ml-2"},ke={key:0,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800"},Oe={key:1,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"},_e={key:0,class:"text-center text-sm text-gray-500"},Te={class:"bg-white rounded-lg shadow"},qe={class:"px-6 py-4 border-b border-gray-200"},De={class:"flex justify-between items-center"},Ce={class:"text-lg font-medium text-gray-900"},Ee=["disabled"],Re={class:"p-6"},$e={key:0,class:"text-center py-4"},Ie={key:1,class:"text-center py-4 text-gray-500"},Ae={key:2,class:"space-y-3"},Me={class:"flex justify-between items-start"},je={class:"flex-1"},Le={class:"font-medium text-sm"},Pe={class:"text-xs text-gray-600 mt-1"},Ne={class:"text-xs text-gray-500 mt-1"},Ue={class:"ml-2"},Fe={key:0,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800"},ze={key:1,class:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"},Be={key:0,class:"text-center text-sm text-gray-500"},Qe={class:"mt-8 bg-white rounded-lg shadow p-6"},Ge={class:"grid grid-cols-2 md:grid-cols-4 gap-4"},He={class:"text-center"},We={class:"text-2xl font-bold text-blue-600"},Xe={class:"text-center"},Ke={class:"text-2xl font-bold text-red-600"},Je={class:"text-center"},Ve={class:"text-2xl font-bold text-orange-600"},Ye={class:"text-center"},Ze={class:"text-2xl font-bold text-gray-600"},et=O(Object.assign({layout:_},{__name:"OfflineTest",setup(t){const s=B("lessons"),m=B("students"),y=B("quiz_answers"),{isOnline:w,syncStatus:k}=s,O=a({totalRecords:0}),_=a({pending:0,failed:0,conflicts:0,total:0}),T=e(()=>Array.isArray(s.data.value)?s.data.value:[]),q=e(()=>Array.isArray(m.data.value)?m.data.value:[]),D=e(()=>{switch(k.value){case"syncing":return"Syncing...";case"stale":return"Data may be outdated";case"error":return"Sync error";default:return"All synced"}});function C(){Promise.all([s.loadAll(),m.loadAll(),y.loadAll()]).catch(e=>{console.error("Failed to load data:",e)})}function E(){x.getDatabaseInfo().then(e=>{O.value=e}),S().then(e=>{_.value=e})}function R(){const e={title:`Test Lesson ${Date.now()}`,content:`This is a test lesson created at ${(new Date).toLocaleString()}. It demonstrates offline functionality.`,course_id:Math.floor(10*Math.random())+1,teacher_id:Math.floor(5*Math.random())+1};s.create(e).then(()=>{console.log("Test lesson created"),E()}).catch(e=>{console.error("Failed to create test lesson:",e)})}function $(){const e={name:`Test Student ${Date.now()}`,email:`student${Date.now()}@example.com`,class_id:Math.floor(5*Math.random())+1,grade_id:Math.floor(12*Math.random())+1};m.create(e).then(()=>{console.log("Test student created"),E()}).catch(e=>{console.error("Failed to create test student:",e)})}function I(){const e={quiz_id:Math.floor(10*Math.random())+1,student_id:Math.floor(100*Math.random())+1,answers:{q1:"A",q2:"B",q3:"C"},score:Math.floor(100*Math.random()),submitted_at:(new Date).toISOString()};y.create(e).then(()=>{console.log("Test quiz submitted"),E()}).catch(e=>{console.error("Failed to submit test quiz:",e)})}function A(){b().then(e=>{console.log("Manual sync completed:",e),E(),e.processed>0&&C()}).catch(e=>{console.error("Manual sync failed:",e)})}return n(()=>{C(),E(),setInterval(E,5e3)}),(e,t)=>(o(),l(v,null,[r(d(c),{title:"Offline System Test"}),i("div",Q,[t[14]||(t[14]=i("div",{class:"mb-8"},[i("h1",{class:"text-3xl font-bold text-gray-900 mb-2"},"Offline-First System Test"),i("p",{class:"text-gray-600"}," Test the offline capabilities of the education management system. Try going offline (DevTools â†’ Network â†’ Offline) and see how the system behaves. ")],-1)),i("div",G,[i("div",{class:f(["bg-white rounded-lg shadow p-6 border-l-4",d(w)?"border-green-500":"border-red-500"])},[i("div",H,[i("div",W,[i("div",{class:f([d(w)?"bg-green-500":"bg-red-500","w-8 h-8 rounded-full flex items-center justify-center"])},[i("span",X,g(d(w)?"ðŸŒ":"ðŸ“´"),1)],2)]),i("div",K,[t[2]||(t[2]=i("h3",{class:"text-lg font-medium text-gray-900"},"Network Status",-1)),i("p",{class:f([d(w)?"text-green-600":"text-red-600","font-medium"])},g(d(w)?"Online":"Offline"),3)])])],2),i("div",J,[i("div",V,[t[4]||(t[4]=i("div",{class:"flex-shrink-0"},[i("div",{class:"bg-blue-500 w-8 h-8 rounded-full flex items-center justify-center"},[i("span",{class:"text-white text-sm"},"ðŸ’¾")])],-1)),i("div",Y,[t[3]||(t[3]=i("h3",{class:"text-lg font-medium text-gray-900"},"Local Database",-1)),i("p",Z,g(O.value.totalRecords)+" records",1)])])]),i("div",{class:f(["bg-white rounded-lg shadow p-6 border-l-4","synced"===d(k)?"border-green-500":"border-orange-500"])},[i("div",ee,[i("div",te,[i("div",{class:f(["synced"===d(k)?"bg-green-500":"bg-orange-500","w-8 h-8 rounded-full flex items-center justify-center"])},[i("span",ae,g("syncing"===d(k)?"â³":"ðŸ”„"),1)],2)]),i("div",se,[t[5]||(t[5]=i("h3",{class:"text-lg font-medium text-gray-900"},"Sync Status",-1)),i("p",{class:f(["synced"===d(k)?"text-green-600":"text-orange-600","font-medium"])},g(D.value),3)])])],2)]),i("div",ne,[t[6]||(t[6]=i("h2",{class:"text-xl font-semibold mb-4"},"Test Actions",-1)),i("div",le,[i("button",{onClick:R,class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," Create Test Lesson "),i("button",{onClick:$,class:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"}," Create Test Student "),i("button",{onClick:I,class:"px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"}," Submit Test Quiz "),i("button",{onClick:A,disabled:"syncing"===d(k),class:"px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:opacity-50"},g("syncing"===d(k)?"Syncing...":"Manual Sync"),9,oe)])]),i("div",re,[i("div",ie,[i("div",de,[i("div",ce,[i("h3",ue,"Lessons ("+g(T.value.length)+")",1),i("button",{onClick:t[0]||(t[0]=e=>d(s).loadAll({forceRefresh:!0})),disabled:d(s).loading,class:"text-sm text-blue-600 hover:text-blue-800 disabled:opacity-50"},g(d(s).loading?"Loading...":"Refresh"),9,fe)])]),i("div",ge,[d(s).loading&&0===T.value.length?(o(),l("div",he,t[7]||(t[7]=[i("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto"},null,-1),i("p",{class:"mt-2 text-sm text-gray-600"},"Loading lessons...",-1)]))):0===T.value.length?(o(),l("div",ve," No lessons found. Create a test lesson to get started. ")):(o(),l("div",pe,[(o(!0),l(v,null,p(T.value.slice(0,5),e=>(o(),l("div",{key:e.id,class:"border rounded p-3"},[i("div",me,[i("div",xe,[i("h4",ye,g(e.title),1),i("p",be,g(e.content?e.content.substring(0,50)+"...":""),1),i("p",we,"Course: "+g(e.course_id),1)]),i("div",Se,[e.is_dirty?(o(),l("span",ke," ðŸ“¤ Pending ")):(o(),l("span",Oe," âœ… Synced "))])])]))),128)),T.value.length>5?(o(),l("div",_e," ... and "+g(T.value.length-5)+" more ",1)):h("",!0)]))])]),i("div",Te,[i("div",qe,[i("div",De,[i("h3",Ce,"Students ("+g(q.value.length)+")",1),i("button",{onClick:t[1]||(t[1]=e=>d(m).loadAll({forceRefresh:!0})),disabled:d(m).loading,class:"text-sm text-blue-600 hover:text-blue-800 disabled:opacity-50"},g(d(m).loading?"Loading...":"Refresh"),9,Ee)])]),i("div",Re,[d(m).loading&&0===q.value.length?(o(),l("div",$e,t[8]||(t[8]=[i("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto"},null,-1),i("p",{class:"mt-2 text-sm text-gray-600"},"Loading students...",-1)]))):0===q.value.length?(o(),l("div",Ie," No students found. Create a test student to get started. ")):(o(),l("div",Ae,[(o(!0),l(v,null,p(q.value.slice(0,5),e=>(o(),l("div",{key:e.id,class:"border rounded p-3"},[i("div",Me,[i("div",je,[i("h4",Le,g(e.name),1),i("p",Pe,g(e.email),1),i("p",Ne,"Class: "+g(e.class_id),1)]),i("div",Ue,[e.is_dirty?(o(),l("span",Fe," ðŸ“¤ Pending ")):(o(),l("span",ze," âœ… Synced "))])])]))),128)),q.value.length>5?(o(),l("div",Be," ... and "+g(q.value.length-5)+" more ",1)):h("",!0)]))])])]),i("div",Qe,[t[13]||(t[13]=i("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Sync Queue Status",-1)),i("div",Ge,[i("div",He,[i("div",We,g(_.value.pending),1),t[9]||(t[9]=i("div",{class:"text-sm text-gray-600"},"Pending",-1))]),i("div",Xe,[i("div",Ke,g(_.value.failed),1),t[10]||(t[10]=i("div",{class:"text-sm text-gray-600"},"Failed",-1))]),i("div",Je,[i("div",Ve,g(_.value.conflicts),1),t[11]||(t[11]=i("div",{class:"text-sm text-gray-600"},"Conflicts",-1))]),i("div",Ye,[i("div",Ze,g(_.value.total),1),t[12]||(t[12]=i("div",{class:"text-sm text-gray-600"},"Total",-1))])])]),t[15]||(t[15]=u('<div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6" data-v-cd15afdf><h3 class="text-lg font-medium text-blue-900 mb-3" data-v-cd15afdf>Testing Instructions</h3><ol class="list-decimal list-inside space-y-2 text-sm text-blue-800" data-v-cd15afdf><li data-v-cd15afdf>Open browser DevTools (F12)</li><li data-v-cd15afdf>Go to Network tab</li><li data-v-cd15afdf>Check &quot;Offline&quot; checkbox to simulate offline mode</li><li data-v-cd15afdf>Try creating lessons, students, or submitting quiz answers</li><li data-v-cd15afdf>Notice how data is saved locally and marked as &quot;Pending&quot;</li><li data-v-cd15afdf>Uncheck &quot;Offline&quot; to go back online</li><li data-v-cd15afdf>Watch as pending data automatically syncs to the server</li><li data-v-cd15afdf>Refresh the page to see that data persists</li></ol></div>',1))])],64))}}),[["__scopeId","data-v-cd15afdf"]]);export{et as default};
