import{o as e,d as a,m as l,c as t,l as s,aP as r,Q as o,b as u,g as i,i as d,j as n,h as c,f as m,e as v,a as p,ba as g,p as y,aE as f,B as h}from"./app-B77gjd5a.js";import{Q as b}from"./QSelect-DB_tK-Lk.js";import{_ as x}from"./AppLayout-OZsHDu4T.js";import{Q as _}from"./QFile-CU_I75Xg.js";import{Q as w}from"./QBadge-ZkvAqPBD.js";import{Q as k}from"./QTd-Cd1TbwhN.js";import{Q as q}from"./QTable-Dzgz30xz.js";import{f as T,a as S,k as j,M as I,J as U,N as C,b as V,K as E,V as R,W as P,y as Q,Q as B,F as A,R as F,I as L,_ as D,o as N,U as $}from"./vendor-DuKqz2x4.js";import{r as O,u as W}from"./xlsx-cMC2LkxH.js";import"./offline-BzIlwqNM.js";import"./i18n-DE5KxGn8.js";import"./ui-BITzTqrO.js";import"./rtl-Cr6c3OOr.js";import"./use-file-Bu9Bf7oq.js";import"./QMarkupTable-xKG6mM4A.js";import"./QLinearProgress-B9hMkhRG.js";import"./use-fullscreen-Cf3Zl1YN.js";const M={class:"row items-center q-gutter-md"},Y={class:"text-h6"},G={class:"text-subtitle2 text-grey"},J={class:"text-h6"},z={key:0,class:"q-mb-md"},K={class:"text-positive text-weight-medium q-mb-sm"},Z={key:1},H={class:"text-negative text-weight-medium q-mb-sm"},X=e({__name:"ImportExcelQuasar",props:{validateUrl:{type:String,required:!0},importUrl:{type:String,required:!0},undoUrl:{type:String,required:!1,default:""},columns:{type:Array,required:!0},buttonText:{type:String,default:"Choose Excel File"},previewTitle:{type:String,default:"Preview Import Data"},confirmButtonText:{type:String,default:"Confirm Import"},cancelButtonText:{type:String,default:"Cancel"},processingText:{type:String,default:"Processing..."},resultsTitle:{type:String,default:"Import Results"},undoButtonText:{type:String,default:"Undo Import"},undoingText:{type:String,default:"Undoing..."},closeButtonText:{type:String,default:"Close"},additionalPayload:{type:Object,default:()=>({})}},emits:["imported","validation-success"],setup(e,{emit:m}){const v=e,p=m,g=T(null),y=T(!1),f=T(!1),h=T(!1),b=T(!1),x=T(!1),N=T([]),$=T({success:[],errors:[]}),X=T(!1),ee=T(null),ae=S(()=>{const e=v.columns.filter(e=>!e.hidden).map(e=>({name:e.key,label:e.label,field:a=>a.data[e.key],align:"left",sortable:!0}));return e.push({name:"status",label:"Status",field:"status",align:"left",sortable:!0}),e});j(()=>v.columns,()=>{N.value.length>0&&(N.value=N.value.map(e=>{const a={};return v.columns.forEach(l=>{a[l.key]=e.data[l.key]||""}),{...e,data:a}}))},{deep:!0});const le=async e=>{if(e){y.value=!0;try{const a=await e.arrayBuffer(),l=O(a,{type:"array"}),t=l.Sheets[l.SheetNames[0]],s=W.sheet_to_json(t,{header:1}),r=s.shift().map(e=>String(e).trim().toLowerCase());N.value=s.filter(e=>e.length).map((e,a)=>{const l={};return v.columns.forEach((a,t)=>{const s=[a.label,a.key].map(e=>String(e).trim().toLowerCase());let o=r.findIndex(e=>s.includes(e));-1===o&&t<e.length&&(o=t),l[a.key]=-1!==o?e[o]:""}),{index:a,data:l,status:"new"}}),await te(),b.value=!0}catch(a){console.error("Error reading file",a)}finally{y.value=!1}}},te=async()=>{var e,a,l;try{const t=v.columns.filter(e=>e.required).map(e=>e.key),s=await D.post(v.validateUrl,{data:N.value.map(e=>e.data),required_fields:t,columns:v.columns}),r=(null==(e=s.data.summary)?void 0:e.invalid_rows)>0||(null==(l=null==(a=s.data.summary)?void 0:a.errors)?void 0:l.length)>0;N.value=N.value.map(e=>({...e,status:r?"warning":"valid"})),p("validation-success",s.data)}catch(t){console.error("Validation error:",t),N.value=N.value.map(e=>({...e,status:"error"}))}},se=async()=>{var e,a;f.value=!0;try{const e=await D.post(v.importUrl,{data:N.value.map(e=>e.data),columns:v.columns,...v.additionalPayload});p("imported",e.data),$.value=e.data.results||{success:[],errors:[]},ee.value=e.data.importId,X.value=!!v.undoUrl,b.value=!1,x.value=!0,g.value=null}catch(l){console.error("Import error:",l),$.value={success:[],errors:[(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"An error occurred during import"]},x.value=!0}finally{f.value=!1}},re=async()=>{if(ee.value&&v.undoUrl){h.value=!0;try{await D.post(`${v.undoUrl}/${ee.value}`),X.value=!1,p("imported"),ue()}catch(e){alert("Failed to undo the import")}finally{h.value=!1}}},oe=e=>{switch(e){case"new":case"warning":return"warning";case"update":return"info";case"valid":return"positive";case"error":return"negative";default:return"grey"}},ue=()=>{x.value=!1,$.value={success:[],errors:[]},ee.value=null,X.value=!1};return(m,v)=>(U(),I("div",null,[C("div",M,[V(_,{modelValue:g.value,"onUpdate:modelValue":[v[0]||(v[0]=e=>g.value=e),le],class:"col-grow",outlined:"",dense:"",label:e.buttonText,accept:".xlsx, .xls",loading:y.value},{prepend:E(()=>[V(a,{name:"attach_file"})]),_:1},8,["modelValue","label","loading"])]),V(u,{modelValue:b.value,"onUpdate:modelValue":v[1]||(v[1]=e=>b.value=e),"full-width":""},{default:E(()=>[V(l,{class:"column full-height",style:{"max-height":"90vh"}},{default:E(()=>[V(t,null,{default:E(()=>[C("div",Y,R(e.previewTitle),1),C("div",G,"Total Records: "+R(N.value.length),1)]),_:1}),V(t,{class:"col q-pa-none"},{default:E(()=>[V(q,{flat:"",bordered:"",rows:N.value,columns:ae.value,"row-key":"index","virtual-scroll":"","rows-per-page-options":[0],class:"sticky-header-table",style:{height:"100%"}},{"body-cell-status":E(e=>[V(k,{props:e},{default:E(()=>[V(w,{color:oe(e.value)},{default:E(()=>[P(R(e.value),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1}),V(s,{align:"right",class:"bg-white text-primary"},{default:E(()=>[Q(V(o,{flat:"",label:e.cancelButtonText},null,8,["label"]),[[r]]),V(o,{flat:"",label:f.value?e.processingText:e.confirmButtonText,color:"primary",onClick:se,loading:f.value,disable:f.value||!N.value.length},null,8,["label","loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),V(u,{modelValue:x.value,"onUpdate:modelValue":v[2]||(v[2]=e=>x.value=e)},{default:E(()=>[V(l,{style:{"min-width":"350px"}},{default:E(()=>[V(t,null,{default:E(()=>[C("div",J,R(e.resultsTitle),1)]),_:1}),V(t,{class:"q-pt-none"},{default:E(()=>[$.value.success.length?(U(),I("div",z,[C("div",K,"Success ("+R($.value.success.length)+")",1),V(i,{dense:""},{default:E(()=>[(U(!0),I(A,null,F($.value.success,(e,a)=>(U(),L(c,{key:a},{default:E(()=>[V(d,null,{default:E(()=>[V(n,{caption:""},{default:E(()=>[P(R(e),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):B("",!0),$.value.errors.length?(U(),I("div",Z,[C("div",H,"Errors ("+R($.value.errors.length)+")",1),V(i,{dense:""},{default:E(()=>[(U(!0),I(A,null,F($.value.errors,(e,a)=>(U(),L(c,{key:a},{default:E(()=>[V(d,null,{default:E(()=>[V(n,{caption:"",class:"text-negative"},{default:E(()=>[P(R(e),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):B("",!0)]),_:1}),V(s,{align:"right"},{default:E(()=>[X.value?(U(),L(o,{key:0,flat:"",label:h.value?e.undoingText:e.undoButtonText,color:"secondary",onClick:re,loading:h.value,disable:h.value},null,8,["label","loading","disable"])):B("",!0),V(o,{flat:"",label:e.closeButtonText,color:"primary",onClick:ue},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},[["__scopeId","data-v-e5bd2e4c"]]),ee={class:"q-pa-md"},ae={class:"row justify-center"},le={class:"col-12 col-md-10 col-lg-8"},te={class:"row q-col-gutter-md"},se={class:"col-12 col-md-6"},re={class:"col-12 col-md-6"},oe={class:"q-gutter-sm"},ue={class:"text-caption text-grey q-mt-xs q-ml-sm"},ie={class:"row items-center q-gutter-md"},de={class:"text-weight-bold"},ne={class:"row q-col-gutter-md"},ce={class:"col-6 col-sm-3"},me={class:"text-body1"},ve={class:"col-6 col-sm-3"},pe={class:"text-body1"},ge={class:"col-6 col-sm-3"},ye={class:"text-body1 text-positive"},fe={class:"col-6 col-sm-3"},he={class:"text-body1 text-info"},be={key:0,class:"q-mt-md"},xe={class:"text-subtitle2 text-negative q-mb-sm"},_e={class:"row justify-end q-gutter-sm"},we="Teacher Excel Import",ke={__name:"TeacherImport",props:{schools:{type:Array,required:!0}},setup(e){const s=e,r=T(""),u=T(null),_=T(!1),w=T(""),k=T("update_existing"),q=T(!1),Q=T(null),O=T(null),W=S(()=>r.value&&u.value&&!w.value),M=S(()=>_.value?"Loading...":u.value?`${u.value.name} (${u.value.start_date} - ${u.value.end_date})`:r.value&&!u.value?"No active academic year found":"Select a school first"),Y=S(()=>W.value?"/admin/teachers/import/validate":""),G=S(()=>W.value?"/admin/teachers/import/process":""),J=[{key:"classroom",label:"Classroom",required:!0},{key:"subject",label:"Subject",required:!0},{key:"teacher_name",label:"Teacher",required:!0},{key:"periods_per_week",label:"Periods_per_Week",required:!0},{key:"teacher_email",label:"Teacher Email",required:!1},{key:"phone",label:"Phone",required:!1},{key:"national_id",label:"National ID",required:!1},{key:"gender",label:"Gender",required:!1},{key:"date_of_birth",label:"Date of Birth",required:!1}],z=async()=>{var e,a;if(!r.value)return u.value=null,void(w.value="");_.value=!0,w.value="";try{const e=await D.get(`/admin/teachers/import/academic-year/${r.value}`);e.data.success?u.value=e.data.academic_year:(u.value=null,w.value=e.data.message)}catch(l){u.value=null,w.value=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"Failed to load academic year"}finally{_.value=!1}},K=e=>{O.value=e},Z=e=>{Q.value=e},H=()=>{Q.value=null,O.value=null},ke=()=>{var e;if(!(null==(e=Q.value)?void 0:e.report))return;const a=JSON.stringify(Q.value.report,null,2),l=new Blob([a],{type:"application/json"}),t=URL.createObjectURL(l),s=document.createElement("a");s.href=t,s.download=`teacher-import-report-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t)};return j(r,()=>{H()}),j(u,()=>{H()}),N(()=>{s.schools&&s.schools.length>0&&(r.value=s.schools[0].id,z())}),(s,T)=>(U(),L(x,{title:we},{header:E(()=>[C("div",{class:"bg-white shadow"},[C("div",{class:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8"},[C("h1",{class:"text-3xl font-bold text-gray-900"},R(we))])])]),default:E(()=>[C("div",ee,[C("div",ae,[C("div",le,[V(l,null,{default:E(()=>[V(t,null,{default:E(()=>T[3]||(T[3]=[C("div",{class:"text-h6"},"School and Academic Year Selection",-1)])),_:1}),V(t,null,{default:E(()=>[C("div",te,[C("div",se,[V(b,{modelValue:r.value,"onUpdate:modelValue":[T[0]||(T[0]=e=>r.value=e),z],options:e.schools,"option-value":"id","option-label":"name",label:"Select School *",outlined:"","emit-value":"","map-options":"",disable:_.value},null,8,["modelValue","options","disable"])]),C("div",re,[V(m,{"model-value":M.value,label:"Active Academic Year",outlined:"",readonly:"",loading:_.value},{append:E(()=>[u.value?(U(),L(a,{key:0,name:"check_circle",color:"positive"})):r.value&&!_.value?(U(),L(a,{key:1,name:"warning",color:"negative"})):B("",!0)]),_:1},8,["model-value","loading"])])]),w.value?(U(),L(v,{key:0,class:"bg-red-1 text-negative q-mt-md rounded-borders"},{avatar:E(()=>[V(a,{name:"error",color:"negative"})]),default:E(()=>[T[4]||(T[4]=C("div",{class:"text-weight-bold"},"Academic Year Required",-1)),P(" "+R(w.value),1)]),_:1})):B("",!0)]),_:1}),W.value?(U(),L(p,{key:0})):B("",!0),W.value?(U(),L(t,{key:1},{default:E(()=>[T[7]||(T[7]=C("div",{class:"text-h6 q-mb-md"},"Import Configuration",-1)),C("div",oe,[V(g,{modelValue:k.value,"onUpdate:modelValue":T[1]||(T[1]=e=>k.value=e),val:"update_existing",label:"Update Existing",color:"primary"},{default:E(()=>[V(y,null,{default:E(()=>T[5]||(T[5]=[P("Update existing assignments and add new ones without removing others")])),_:1})]),_:1},8,["modelValue"]),V(g,{modelValue:k.value,"onUpdate:modelValue":T[2]||(T[2]=e=>k.value=e),val:"full_sync",label:"Full Sync",color:"primary"},{default:E(()=>[V(y,null,{default:E(()=>T[6]||(T[6]=[P("Replace all assignments for this school and academic year")])),_:1})]),_:1},8,["modelValue"])]),C("div",ue,R("update_existing"===k.value?"Update existing assignments and add new ones without removing other assignments":"Replace all assignments for this school and academic year with the imported data"),1)]),_:1})):B("",!0),W.value?(U(),L(p,{key:2})):B("",!0),W.value?(U(),L(t,{key:3},{default:E(()=>{var e;return[T[12]||(T[12]=C("div",{class:"text-h6 q-mb-md"},"Excel File Import",-1)),V(v,{class:"bg-blue-1 text-primary q-mb-md rounded-borders"},{avatar:E(()=>[V(a,{name:"info",color:"primary"})]),default:E(()=>[T[8]||(T[8]=C("div",{class:"text-weight-medium"},"Required Excel Columns",-1)),T[9]||(T[9]=C("div",{class:"row q-gutter-x-md text-caption"},[C("div",null,"• Classroom"),C("div",null,"• Subject"),C("div",null,"• Teacher Name"),C("div",null,"• Periods_per_Week")],-1)),T[10]||(T[10]=C("div",{class:"text-weight-medium q-mt-sm"},"Optional Columns",-1)),T[11]||(T[11]=C("div",{class:"row q-gutter-x-md text-caption"},[C("div",null,"• Teacher Email"),C("div",null,"• Phone"),C("div",null,"• National ID"),C("div",null,"• Gender"),C("div",null,"• Date of Birth")],-1))]),_:1}),V(X,{"validate-url":Y.value,"import-url":G.value,columns:J,"button-text":"Choose Teacher Excel File","preview-title":"Preview Teacher Import Data","confirm-button-text":"Import Teachers","additional-payload":{school_id:r.value,academic_year_id:null==(e=u.value)?void 0:e.id,sync_mode:k.value},onValidationSuccess:K,onImported:Z},null,8,["validate-url","import-url","additional-payload"])]}),_:1})):B("",!0),q.value?(U(),L(t,{key:4},{default:E(()=>[C("div",ie,[V(f,{color:"primary",size:"2em"}),T[13]||(T[13]=C("div",null,[C("div",{class:"text-weight-bold text-primary"},"Import in Progress"),C("div",{class:"text-caption"},"Processing your teacher data...")],-1))])]),_:1})):B("",!0),Q.value?(U(),L(t,{key:5},{default:E(()=>[T[19]||(T[19]=C("div",{class:"text-h6 q-mb-md"},"Import Results",-1)),V(v,{class:$([Q.value.success?"bg-green-1 text-positive":"bg-red-1 text-negative","rounded-borders q-mb-md"])},{avatar:E(()=>[V(a,{name:Q.value.success?"check_circle":"error",color:Q.value.success?"positive":"negative"},null,8,["name","color"])]),default:E(()=>[C("div",de,R(Q.value.success?"Import Completed Successfully":"Import Failed"),1),P(" "+R(Q.value.message),1)]),_:1},8,["class"]),Q.value.report?(U(),L(l,{key:0,bordered:"",flat:"",class:"q-mb-md"},{default:E(()=>[V(t,{class:"bg-grey-1 q-py-sm"},{default:E(()=>T[14]||(T[14]=[C("div",{class:"text-subtitle2"},"Import Summary",-1)])),_:1}),V(t,null,{default:E(()=>{var e,a,l,t,s;return[C("div",ne,[C("div",ce,[T[15]||(T[15]=C("div",{class:"text-caption text-grey"},"Total Rows",-1)),C("div",me,R((null==(e=Q.value.report.summary)?void 0:e.total_rows)||0),1)]),C("div",ve,[T[16]||(T[16]=C("div",{class:"text-caption text-grey"},"Processed",-1)),C("div",pe,R((null==(a=Q.value.report.summary)?void 0:a.processed_rows)||0),1)]),C("div",ge,[T[17]||(T[17]=C("div",{class:"text-caption text-grey"},"Teachers Created",-1)),C("div",ye,R((null==(l=Q.value.report.summary)?void 0:l.teachers_created)||0),1)]),C("div",fe,[T[18]||(T[18]=C("div",{class:"text-caption text-grey"},"Assignments",-1)),C("div",he,R(((null==(t=Q.value.report.summary)?void 0:t.assignments_created)||0)+((null==(s=Q.value.report.summary)?void 0:s.assignments_updated)||0)),1)])]),Q.value.report.errors&&Q.value.report.errors.length>0?(U(),I("div",be,[C("div",xe,"Errors ("+R(Q.value.report.errors.length)+")",1),V(h,{style:{height:"150px",border:"1px solid #ddd","border-radius":"4px"}},{default:E(()=>[V(i,{dense:""},{default:E(()=>[(U(!0),I(A,null,F(Q.value.report.errors,(e,a)=>(U(),L(c,{key:a},{default:E(()=>[V(d,null,{default:E(()=>[V(n,{class:"text-negative text-caption"},{default:E(()=>[P(" Row "+R(e.row)+": "+R(e.message),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])):B("",!0)]}),_:1})]),_:1})):B("",!0),C("div",_e,[V(o,{outline:"",color:"primary",label:"Import Another File",onClick:H}),Q.value.report?(U(),L(o,{key:0,color:"primary",label:"Download Report",onClick:ke,icon:"download"})):B("",!0)])]),_:1})):B("",!0)]),_:1})])])])]),_:1}))}};export{ke as default};
